function disableLabelEventsGlobally(){$("label").bind("click",function(event){event.stopPropagation();});}$.fn.toggleCheckbox=function(){return this.each(function(){if(!$(this).attr("alreadyToggled")){if($(this).attr("checked")){$(this).removeAttr("checked");}else{$(this).attr("checked","checked");}}$(this).removeAttr("alreadyToggled");});};function DataList(extraData){this.dataArray=extraData;this.length=0;this.dataString="";for(var dataEntry in this.dataArray){if(this.length!==0){this.dataString+=" ";}this.dataString+=dataEntry;this.length+=1;}this.print=function(){return this.dataString;};}function LogEntry(logAction,logActionTarget,extraData){this.timestamp=new Date();this.action=logAction+" "+logActionTarget;this.data=new DataList(extraData);this.print=function(){var buffer="";buffer+=Math.round(this.timestamp.getTime()/1000)+",";buffer+=this.action+",";buffer+=this.data.print();return buffer;};}function LogQueue(){this.CLIENT_SIDE_VALIDATION="client-side-validation";this.SERVER_SIDE_VALIDATION="server-side-validation";this.CLICKED="clicked";this.SECTION_EXPANDED="section-expanded";this.ROW_SELECTED="row-selected";this.CHECKBOX_TOGGLED="checkbox-toggled";this.SYSTEM_ERROR_HANDLER="system-error-handler";this.PAGE_LOADED="page-loaded";this.LOG_CAP=50;this.logs=[];this.enqueue=function(logEntry){if(this.logs.length>=this.LOG_CAP){this.dequeue();}this.logs.push(logEntry);};this.dequeue=function(){var entry=this.logs.shift();return entry;};this.dump=function(){var buffer="";if(this.logs.length>0){buffer+="log0="+this.dequeue().print();}var i=1;while(this.logs.length>0){buffer+="&log"+i+"="+this.dequeue().print();i+=1;}return buffer;};}var PIPELINE=new Object();var payselectpage=new Object();var spcpage=new Object();var shipoptionselectpage=new Object();var billingaddressselectpage=new Object();var ordereditpopover=new Object();var payselectdiv;var spcdiv;var shipoptionselectdiv;var billingaddressselectdiv;var logEvents=new LogQueue();var ajaxRequestArray=[];var STOP_ALL_AJAX_REQUESTS=false;var PIPEDATA_RETURN_RID="";var SCOPE=null;var ASYNCSCOPE=null;var CONTENT_FETCH_IN_PROGRESS=[];var SUPERSEDE_STATIC_HANDLER=[];function Validator(validator){var This=this;this.elementsToValidate=validator.elementsToValidate;this.elementsToHighlight=validator.elementsToHighlight||validator.elementsToValidate;this.validateFunctionWrappers=validator.validateFunctionWrappers;this.refreshHighlight=function(success){if(success){this.elementsToHighlight.each(function(){if(!jQuery.browser.safari&&$(this).is("select")&&$(this).parent().hasClass("redbox-wrapper")){$(this).parent().replaceWith($(this));}else{$(this).removeClass("redbox");}});}else{this.elementsToHighlight.each(function(){if(!jQuery.browser.safari&&$(this).is("select")&&!$(this).parent().hasClass("redbox-wrapper")){$(this).wrap("<div class='redbox-wrapper'></div>");}else{$(this).addClass("redbox");}});}};this.findValidateFunctionWrapper=function(validateFunctionWrapper){for(var index in this.validateFunctionWrappers){if(this.validateFunctionWrappers[index].equals(validateFunctionWrapper)){return index;}}return -1;};this.removeValidateFunctionWrapper=function(validateFunctionWrapper){var wrapper=this.findValidateFunctionWrapper(validateFunctionWrapper);if(wrapper>=0){delete this.validateFunctionWrappers[wrapper];}};this.addValidateFunctionWrapper=function(validateFunctionWrapper){if(this.findValidateFunctionWrapper(validateFunctionWrapper)==-1){this.validateFunctionWrappers.push(validateFunctionWrapper);}};}function ValidateFunctionWrapper(validateFunctionWrapper){this.validateFunction=validateFunctionWrapper.validateFunction;this.errorIdentifier=validateFunctionWrapper.errorIdentifier;this.clearErrorsOnly=validateFunctionWrapper.clearErrorsOnly;this.invoke=function(elementsToValidate){return this.validateFunction(elementsToValidate);};this.equals=function(otherValidateFunctionWrapper){if(this.validateFunction.toString()==otherValidateFunctionWrapper.validateFunction.toString()&&this.errorIdentifier==otherValidateFunctionWrapper.errorIdentifier){return true;}return false;};}function validateIsNotEmpty(elementsToValidate){return elementsToValidate.val().length>0;}function ErrorAuthority(section){this.section=section;this.errorBlock=section.find(".errorblock");this.errorIdentifiers=[];this.validators=[];this.DEFAULT_PRIORITY=100;var This=this;this.filterErrors=function(){var currentPriority=this.DEFAULT_PRIORITY;for(var i in this.errorIdentifiers){currentPriority=Math.min(this.errorIdentifiers[i],currentPriority);}for(var j in this.errorIdentifiers){if(this.errorIdentifiers[j]>currentPriority){this.removeError(j);}}};this.addError=function(errorIdentifier){var priority=this.errorBlock.find("[error="+errorIdentifier+"]").attr("priority")||this.DEFAULT_PRIORITY;this.errorIdentifiers[errorIdentifier]=priority;this.filterErrors();this.refreshErrorBlock();};this.addErrors=function(errorIdentifiers){this.addErrorsWithoutValidating(errorIdentifiers);if(this.hasErrors()){logEvents.enqueue(new LogEntry(logEvents.SERVER_SIDE_VALIDATION,this.section.attr("id"),this.errorIdentifiers));}this.refreshErrorBlock();};this.addErrorsWithoutValidating=function(errorIdentifiers){for(var i in errorIdentifiers){var priority=this.errorBlock.find("[error="+errorIdentifiers[i]+"]").attr("priority")||this.DEFAULT_PRIORITY;this.errorIdentifiers[errorIdentifiers[i]]=priority;var associatedFieldsSelector=$("[error="+errorIdentifiers[i]+"]").attr("associated-fields");if(associatedFieldsSelector){$(associatedFieldsSelector).show();}}this.filterErrors();};this.removeError=function(name){delete this.errorIdentifiers[name];this.refreshErrorBlock();};this.clearErrors=function(){this.errorIdentifiers=[];this.clearAllHighlighting();this.refreshErrorBlock();};this.runAllValidators=function(clearErrors){if(clearErrors){this.clearErrors();}for(var i in this.validators){this.validate(this.validators[i]);}if(this.hasErrors()){logEvents.enqueue(new LogEntry(logEvents.CLIENT_SIDE_VALIDATION,this.section.attr("id"),this.errorIdentifiers));}};this.clearAllHighlighting=function(){for(var i in this.validators){this.validators[i].refreshHighlight(true);}};this.hasErrors=function(){for(var i in this.errorIdentifiers){return true;}return false;};this.validate=function(validator){var success=true;var validatedIdentifiers=[];var failedIdentifiers=[];for(var i in validator.validateFunctionWrappers){var validateFunctionWrapper=validator.validateFunctionWrappers[i];var validationResult=validateFunctionWrapper.invoke(validator.elementsToValidate);if(validationResult){validatedIdentifiers[validateFunctionWrapper.errorIdentifier]=true;}else{if(validateFunctionWrapper.clearErrorsOnly){}else{failedIdentifiers[validateFunctionWrapper.errorIdentifier]=true;}}if(validateFunctionWrapper.clearErrorsOnly){}else{success=success&&validationResult;}}for(var v in validatedIdentifiers){this.removeError(v);}for(var f in failedIdentifiers){this.addError(f);}validator.refreshHighlight(success);};this.addValidator=function(validator){this.validators.push(validator);};this.getValidator=function(validatorId){for(var validator in this.validators){if(this.validators[validator].elementsToValidate.attr("id")==validatorId){return this.validators[validator];}}return null;};this.refreshErrorBlock=function(){this.errorBlock.find("[error]").hide();var count=0;for(var errorIdentifier in this.errorIdentifiers){var htmlError="[error="+errorIdentifier+"]";this.errorBlock.find(htmlError).show();count++;}if(count>0){this.errorBlock.show();var tabindexName=$.browser.msie?"tabIndex":"tabindex";this.errorBlock.attr(tabindexName,-1).focus();}else{this.errorBlock.hide();}};}function loadPageContent(data){setmarker("x4");var htm=$("[pageurl='"+PIPELINE.nextpage.url+"']");if(htm.length==0){htm=$("[pagecontent=template]").clone();htm.attr("pagecontent","copy");htm.attr("pageurl",PIPELINE.nextpage.url);htm.attr("id",PIPELINE.nextpage.page+"pagecontent");htm.find("div").replaceWith(data);htm.appendTo("#pagecontentplaceholder");setmarker("x5");eval(PIPELINE.nextpage.page+"div=$('#"+PIPELINE.nextpage.page+"pagecontent')");eval(PIPELINE.nextpage.page+"page.ready()");}CONTENT_FETCH_IN_PROGRESS[PIPELINE.nextpage.url]=0;delete SUPERSEDE_STATIC_HANDLER[PIPELINE.nextpage.url];displayPage();}function requestPageContent(){var htm=$("div[pageurl='"+PIPELINE.nextpage.url+"']");if(CONTENT_FETCH_IN_PROGRESS[PIPELINE.nextpage.url]){SUPERSEDE_STATIC_HANDLER[PIPELINE.nextpage.url]=loadPageContent;}else{if(htm.length==0){CONTENT_FETCH_IN_PROGRESS[PIPELINE.nextpage.url]=1;delete SUPERSEDE_STATIC_HANDLER[PIPELINE.nextpage.url];setmarker("x3");var url=PIPELINE.nextpage.url;var callback="loadPageContent";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";getHtmlData(url,callback,errorhandler,systemerrorhandler,null,null);}else{eval(PIPELINE.nextpage.page+"div=$('#"+PIPELINE.nextpage.page+"pagecontent')");eval(PIPELINE.nextpage.page+"page.ready()");displayPage();}}}function fillStaticContent(data,url,page){if(SUPERSEDE_STATIC_HANDLER[url]){SUPERSEDE_STATIC_HANDLER[url](data,url,page);}else{if($("div[pageurl='"+url+"']").length==0){htm=$("[pagecontent=template]").clone();htm.attr("pagecontent","copy");htm.attr("pageurl",url);htm.attr("id",page+"pagecontent");htm.find("div").replaceWith(data);htm.appendTo("#pagecontentplaceholder");}CONTENT_FETCH_IN_PROGRESS[url]=0;delete SUPERSEDE_STATIC_HANDLER[url];}}function requestStaticContent(url,page){if(!CONTENT_FETCH_IN_PROGRESS[url]&&($("div[pageurl='"+url+"']").length==0)){CONTENT_FETCH_IN_PROGRESS[url]=1;delete SUPERSEDE_STATIC_HANDLER[url];var callbackargs=[];callbackargs.push("'"+url+"'");callbackargs.push("'"+page+"'");var callback="fillStaticContent";getHtmlData(url,callback,null,null,null,callbackargs);}}function jsonPipedata(data){if(data.nextpage){conductor(data);}else{generalErrorHandling();}}function requestPipedata(page){var url="/gp/buy/pipeline/handlers/json-pipedata.html";var callback="jsonPipedata";var extradata="page="+page;var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);}function displayPage(){$("div[pagecontent=copy]").hide();if(PIPELINE.nextpage.page=="shipoptionselect"){$("head link.pipeline").each(function(){this.disabled=true;});$("head link.shipoptionselect").each(function(){this.disabled=false;});}else{$("head link.shipoptionselect").each(function(){this.disabled=true;});$("head link.pipeline").each(function(){this.disabled=false;});}$("div[pageurl='"+PIPELINE.nextpage.url+"']").show();setmarker("be");eval(PIPELINE.nextpage.page+"page.startEngine(PIPELINE.pipedata)");}function conductor(pipedata,nextpage){if(pipedata&&pipedata.conductoraction){return conductorOverrider(pipedata.conductoraction);}setmarker("x2");if(payselectpage.ASYNC_CONTINUE_TIMEOUT){clearTimeout(payselectpage.ASYNC_CONTINUE_TIMEOUT);}if(billingaddressselectpage.ASYNC_CONTINUE_TIMEOUT){clearTimeout(billingaddressselectpage.ASYNC_CONTINUE_TIMEOUT);}PIPELINE.windowwidth=$(window).width();PIPELINE.windowheight=$(window).height();PIPELINE.pipedata=pipedata;if(nextpage&&nextpage.page&&nextpage.url){PIPELINE.nextpage=nextpage;}else{if(pipedata&&pipedata.nextpage){if(pipedata.nextpage.page&&pipedata.nextpage.url){PIPELINE.nextpage=pipedata.nextpage;}else{if(pipedata.nextpage.url){window.location.href=pipedata.nextpage.url;return ;}else{generalErrorHandling();return ;}}}else{requestPipedata();return ;}}if(PIPELINE.nextpage&&PIPELINE.nextpage.page){$(document).attr("title",$("div[pagetitle="+PIPELINE.nextpage.page+"]").attr("value"));requestPageContent();if(ordereditpopover){ordereditpopover.hidePopover();}}}function gotoPage(page){var nextpage=new Object();nextpage.page=page;if(page=="spc"){nextpage.url="/gp/buy/pipeline/spc.html";}else{if(page=="payselect"){nextpage.url="/gp/buy/pipeline/payselect.html";}else{if(page=="shipoptionselect"){nextpage.url="/gp/buy/pipeline/shipoptionselect.html";}else{if(page=="billingaddressselect"){nextpage.url="/gp/buy/pipeline/billingaddrselect.html";}}}}conductor(PIPELINE.pipedata,nextpage);}function amz_js_PopWin(url,name,options){var ContextWindow=window.open(url,name,options);ContextWindow.focus();return false;}function createFailingValidateFunctionWrapper(errorId){return new ValidateFunctionWrapper({validateFunction:function(){return false;},errorIdentifier:errorId});}function getHtmlData(url,callback,errorhandler,systemerrorhandler,extradata,callbackargs){if(STOP_ALL_AJAX_REQUESTS){return ;}var now=new Date().getTime();var ajaxRequest=$.ajax({type:"POST",url:url,data:extradata+"&cachebuster="+now,headers:{"Cache-Control":"no-cache","pragma":"no-cache"},success:function(msg){if(msg===null){if(systemerrorhandler){var errObj=createError("error","emptyDataError");eval(systemerrorhandler+"(errObj)");}}else{if(msg.search("htmlresponsesuccess")===-1){if(errorhandler){var errObj=createError("error","htmlRequestError");eval(errorhandler+"(errObj)");}}else{if(callback!==null){var parameters="msg";if(callbackargs!==null){parameters+=","+callbackargs.join(",");}eval(callback+"("+parameters+")");}}}},error:function(){if(systemerrorhandler){var errObj=createError("error","ajaxError");eval(systemerrorhandler+"(errObj)");}}});ajaxRequestArray.push(ajaxRequest);}function getData(url,callback,errorhandler,systemerrorhandler,extradata){if(STOP_ALL_AJAX_REQUESTS){return ;}var now=new Date().getTime();var ajaxRequest=$.ajax({type:"POST",url:url,data:extradata+"&returnjson=1&isDecoupledSPC=1&cachebuster="+now,headers:{"Cache-Control":"no-cache","pragma":"no-cache"},contentType:"application/x-www-form-urlencoded; charset=UTF-8;",dataType:"text",dataFilter:function(data,type){var jsonObject=null;try{jsonObject=eval("("+data+")");}catch(e){jsonObject=null;}return jsonObject;},success:function(msg){if(msg===null){if(systemerrorhandler){var errObj=createError("error","emptyDataError");eval(systemerrorhandler+"(errObj)");}}else{var currentscope=null;if(msg.isclienttimebased){currentscope=SCOPE;setscope(ASYNCSCOPE);}else{createscope();resetue();}if(msg.requestid){setrid(msg.requestid);}if(currentscope){setscope(currentscope);}if(msg.conductoraction){conductorOverrider(msg.conductoraction);return ;}if(msg.pipedata&&msg.pipedata.conductoraction){conductorOverrider(msg.pipedata.conductoraction);return ;}if(msg.error){if(errorhandler!==null){eval(errorhandler+"(msg.error)");}}else{if(msg.errors){if(errorhandler!==null){eval(errorhandler+"(msg.errors)");}}else{if(msg.autohandlererror){if(systemerrorhandler){eval(systemerrorhandler+"(msg.autohandlererror)");}}else{if(callback!==null){eval(callback+"(msg)");}}}}}},error:function(){if(systemerrorhandler){var errObj=createError("error","ajaxError");eval(systemerrorhandler+"(errObj)");}}});ajaxRequestArray.push(ajaxRequest);}function cleanUp(){STOP_ALL_AJAX_REQUESTS=true;var ajaxRequest=null;while(ajaxRequest=ajaxRequestArray.shift()){ajaxRequest.abort();}}function getRefTag(element){return"ref="+element.attr("ref");}function decodeJSonResponse(data){var patternForFullWidth=new RegExp(String.fromCharCode(65340),"g");var patternForSlash=new RegExp(String.fromCharCode(92,92,92,92),"g");var output=data.replace(patternForFullWidth,String.fromCharCode(92),"g");output=output.replace(patternForSlash,String.fromCharCode(92));output=output.replace(/\\1/g,String.fromCharCode(34));output=output.replace(/\\2/g,String.fromCharCode(10));return output;}function uiScrollToTop(){if($(window).scrollTop()!==0){$("html,body").animate({scrollTop:"0px"},1000);}}function populateYearDropdown(element,startYear,endYear){var optionHTML="";for(var i=startYear;i<=endYear;i++){optionHTML+='<option value="'+i+'" >'+i+"</option>";}$(element).append(optionHTML);}function conductorOverrider(action){if(action){if(action.type=="fatal"){window.location.href="/gp/buy/pipeline/handlers/error.html?errorType=conductorError";}else{if(action.type=="redirect"){window.location.href=action.url;}}}}function createError(level,message){var errObj=new Object();errObj.action=(level=="fatal"?"fatal":"error");errObj.type=message;return errObj;}function generalErrorHandling(errordata){var action=errordata?errordata.action:null;var errorType;var additionalInfo=[];if(action&&action.code){additionalInfo[action.code]=1;}if(errordata&&errordata.type){errorType=errordata.type;}else{if(action&&action.code){errorType=action.code;}else{if(typeof errordata=="string"){errorType=errordata;}else{errorType="Unknown:pipelineJSError";}}}logEvents.enqueue(new LogEntry(logEvents.SYSTEM_ERROR_HANDLER,"General_SystemError",additionalInfo));if(action=="fatal"){window.location.href="/gp/buy/payselect/handlers/error.html?errorAction=fatal&errorType="+encodeURIComponent(errorType);}else{if(action=="redirect"){window.location.href=errordata.url;}else{window.location.href="/gp/buy/payselect/handlers/error.html?errorType="+encodeURIComponent(errorType);}}}function creditCardType(type){switch(type){case"Amazon.com Visa":return"amzn";case"Amazon.com B. Visa":return"amzn";case"Amazon.com Visa Signature":return"amzn";case"Amazon.com Bus. Visa Sig.":return"amzn";case"Amazon.de Kreditkarte":return"amzn";case"Amazon.de VISA Karte":return"amzn";case"Amazon.de Visa":return"amzn";case"Amazon.co.uk MasterCard":return"mc";case"Amazon.com Store Card":return"plcc";case"Target Visa":return"visa";case"Visa":return"visa";case"Visa/Delta/Electron":return"visa";case"Visa/Electron":return"visa";case"Visa / 4B / Euro6000":return"visa";case"Visa / Electron":return"visa";case"MasterCard":return"mc";case"MasterCard/EuroCard":return"mc";case"Eurocard / MasterCard":return"mc";case"MasterCard / 4B / Euro6000":return"mc";case"Solo/Maestro":return"mc";case"American Express":return"amex";case"Discover":return"discover";case"Diners Club":return"diners";case"JCB":return"jcb";case"Carte Bancaire":return"carte-bancaire";case"Carte Aurore":return"carte-aurore";case"CartaSi Visa":return"cartasi-visa";case"CartaSi MasterCard":return"cartasi-mastercard";case"Postepay":return"postepay-visa";default:return"none";}}function eventPageLoaded(){setmarker("ld");sendue("ld");logEvents.enqueue(new LogEntry(logEvents.PAGE_LOADED,$("#pagecontentplaceholder").children(":visible").attr("id"),[]));createscope(1);}var isSubmitted=false;function confirmPurchase_onSubmit(){if(isSubmitted){return false;}else{isSubmitted=true;return true;}}payselectpage.maybeDisplayContinueDisabled=function maybeDisplayContinueDisabled(){if(payselectpage.CONTINUE_ERROR_AUTHORITY.hasErrors()){var htm=$("#continue-blocker-box");htm.show();var y=htm.find(".continue-blocker").height()/2;var x=htm.find(".continue-blocker").width();htm.find(".continue-blocker").css({top:$(this).offset().top-y,left:$(this).offset().left-x-20});$(this).siblings(".continue-disabled").show();$(this).hide();}else{if($("#existing-instruments tr.current").attr("requirescvv")){var currentrow=$("#existing-instruments tr.current");payselectpage.CONTINUE_CVV_ERROR_AUTHORITY.runAllValidators(true);if(payselectpage.CONTINUE_CVV_ERROR_AUTHORITY.hasErrors()){$(this).siblings(".continue-disabled").show();$(this).hide();$("#existing-CVV-warning-block").show();currentrow.find("#existingcccvvnum").addClass("redbox");var htm=$("#needcvvarrow");htm.show();var y=htm.find(".continue-blocker-cvv-arrow").height()/2;var x=htm.find(".continue-blocker-cvv-arrow").width();htm.find(".continue-blocker-cvv-arrow").css({top:currentrow.find("#existingcccvvnum").offset().top,left:currentrow.find("#existingcccvvnum").offset().left+x+25});}}}};payselectpage.displayContinueEnabled=function displayContinueEnabled(){$("#continue-blocker-box").hide();var currentrow=$("#existing-instruments tr.current");if(currentrow.attr("requirescvv")){$("#existing-CVV-warning-block").hide();currentrow.find("#existingcccvvnum").removeClass("redbox");$("#needcvvarrow").hide();}$(this).siblings(".continue-enabled").show();$(this).hide();};payselectpage.displayCVVHelp=function displayCVVHelp(){var htm=$("#cvvhelppopover");htm.show();var y=htm.height()/2;var x=htm.width();htm.css({top:$(this).offset().top,left:$(this).offset().left+50});};payselectpage.hideCVVHelp=function hideCVVhelp(){$("#cvvhelppopover").hide();};payselectpage.createValidators=function createValidators(){payselectpage.CONTINUE_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#continue-blocker-box"),elementsToHighlight:$("<div/>"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateFlexiblePaymentsHasCreditCard,errorIdentifier:"continue_FlexiblePaymentsNeedsCreditCard"}),new ValidateFunctionWrapper({validateFunction:validatePaymentMethodSelected,errorIdentifier:"continue_AvailableBalanceDontCoverFullCost",clearErrorsOnly:true}),new ValidateFunctionWrapper({validateFunction:validateExpirationDate,errorIdentifier:"continue_BadExpiration"}),new ValidateFunctionWrapper({validateFunction:validatePaymentMethodSelected,errorIdentifier:"continue_BlankSlate"}),new ValidateFunctionWrapper({validateFunction:validatePaymentMethodSelected,errorIdentifier:"continue_AddressChallenge",clearErrorsOnly:true}),new ValidateFunctionWrapper({validateFunction:validateBadCombinationCheckExistingBalance,errorIdentifier:"continue_BadCombinationCheckExistingBalance"}),new ValidateFunctionWrapper({validateFunction:validateRewardsValue,errorIdentifier:"continue_BadRewardsValue"}),new ValidateFunctionWrapper({validateFunction:validateRewardsMin,errorIdentifier:"continue_BadRewardsMin"}),new ValidateFunctionWrapper({validateFunction:validateRewardsMax,errorIdentifier:"continue_BadRewardsMax"}),new ValidateFunctionWrapper({validateFunction:validateAddressChallenge,errorIdentifier:"continue_AddressChallenge"}),new ValidateFunctionWrapper({validateFunction:validateGCorPromoBalance,errorIdentifier:"continue_BadGCorPromoBalance"}),new ValidateFunctionWrapper({validateFunction:validateCardCurrency,errorIdentifier:"continue_SelectCardCurrency"})]}));payselectpage.CONTINUE_CVV_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#continue-blocker-box"),elementsToHighlight:$("<div/>"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateBadCVVNumber,errorIdentifier:"continue_BadExpiration"})]}));payselectpage.CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#newCreditCardNumber"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addCreditCard_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardLength,errorIdentifier:"addCreditCard_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardMatchesLuhn,errorIdentifier:"addCreditCard_BadNumber"})]}));payselectpage.CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#cctype"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateCreditCardHasType,errorIdentifier:"addCreditCard_NoType"})]}));payselectpage.CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#ccname"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addCreditCard_NoName"})]}));payselectpage.CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#expirationmonthandyear, #cctype"),elementsToHighlight:$("#expirationmonthandyear select"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotExpired,errorIdentifier:"addCreditCard_BadExpiration"})]}));if(!payselectpage.treatment_10435){payselectpage.CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#maestrofields"),elementsToHighlight:$("#startmonth, #startyear, #issuenumber"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateHasIssueNumberOrValidStartDate,errorIdentifier:"addCreditCard_NoIssueNumberOrStartDate"})]}));}payselectpage.CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#securitycode, #cctype"),elementsToHighlight:$("#securitycode"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateCreditCardCVV2,errorIdentifier:"addCreditCard_BadSecurityCode"})]}));payselectpage.LINE_OF_CREDIT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#newLineOfCreditNumber"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addLoc_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardLength,errorIdentifier:"addLoc_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardMatchesLuhn,errorIdentifier:"addLoc_BadNumber"})]}));payselectpage.LINE_OF_CREDIT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#locname"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addLoc_NoName"})]}));payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#newVerifiedCreditCardNumber"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addCreditCard_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardLength,errorIdentifier:"addCreditCard_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardMatchesLuhn,errorIdentifier:"addCreditCard_BadNumber"})]}));payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#vccname"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addCreditCard_NoName"})]}));payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#vccexpirationmonthandyear, #vcctype"),elementsToHighlight:$("#vccexpirationmonthandyear select"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotExpired,errorIdentifier:"addCreditCard_BadExpiration"})]}));payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#vcccvvnum,#vcctype"),elementsToHighlight:$("#vcccvvnum"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateCreditCardCVV2,errorIdentifier:"addCreditCard_BadSecurityCode"})]}));payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#newVerifiedDebitCardNumber"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addCreditCard_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardLength,errorIdentifier:"addCreditCard_BadNumber"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardMatchesLuhn,errorIdentifier:"addCreditCard_BadNumber"})]}));payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#vdcname"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addCreditCard_NoName"})]}));payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#vdcexpirationmonthandyear, #vdctype"),elementsToHighlight:$("#vdcexpirationmonthandyear select"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotExpired,errorIdentifier:"addCreditCard_BadExpiration"})]}));payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#vdccvvnum, #vdctype"),elementsToHighlight:$("#vdccvvnum"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateCreditCardCVV2,errorIdentifier:"addCreditCard_BadSecurityCode"})]}));payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#check-account-number, #check-account-number-confirm"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateAccountNumberMatch,errorIdentifier:"addBankAccount_AccountNumberMismatch"})]}));payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#check-account-number"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addBankAccount_NoAccountNumber"})]}));payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#check-routing-number"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateRoutingNumberLength,errorIdentifier:"addBankAccount_ShortRoutingNumber"})]}));payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#check-dl"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addBankAccount_NoDLNumber"})]}));payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#check-dl-state"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateDLStateNotEmpty,errorIdentifier:"addBankAccount_NoDLState"})]}));payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#check-name"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addBankAccount_NoName"})]}));payselectpage.GIFTCARD_PROMO_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#gcpromoinput"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addGiftCardOrPromo_NoCode"})]}));payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#debit-bank-routing-number"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addDirectDebit_NoRoutingNumber"})]}));payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#debit-account-number"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addDirectDebit_NoAccountNumber"})]}));payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#debit-account-name"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addDirectDebit_NoAccountOwnerName"})]}));payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#invoice-first-name"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addInvoiceAccount_NoFirstName"})]}));payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#invoice-last-name"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addInvoiceAccount_NoLastName"})]}));payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#invoice-day-of-birth"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addInvoiceAccount_NoDateOfBirth"})]}));payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#invoice-month-of-birth"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addInvoiceAccount_NoDateOfBirth"})]}));payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#invoice-year-of-birth"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addInvoiceAccount_NoDateOfBirth"})]}));};function validateCardCurrency(elementsToValidate){if(!payselectpage.isCurrencyAttributeUiEnabled()){return true;}var cardCurrencySelectorDiv=$("#payselectpagecontent #existing-credit-cards tr.current .cardCurrencySelector");if(cardCurrencySelectorDiv&&cardCurrencySelectorDiv.is(":visible")){return payselectpage.getSelectedCardCurrency(cardCurrencySelectorDiv);}return true;}payselectpage.getRewardsUsageData=function getRewardsUsageData(row){if(row.find(".rewardsusage").is("[paymentmethodid]")){var rewardsAccountData={};var htmrewards=row.find(".rewardsusage");rewardsAccountData.id=htmrewards.attr("paymentmethodid");rewardsAccountData.rate=payselectpage.REWARDS_ACCOUNTS[rewardsAccountData.id].ratio;var rewardsSelect=htmrewards.find("[name^=rewardsselect]:checked").val();if(rewardsSelect=="rewardsmax"){rewardsAccountData.amount=htmrewards.find("[datafield='maxdollaramount']").attr("amount");rewardsAccountData.isMaxSelected=true;}else{if(rewardsSelect=="rewardscustom"){rewardsAccountData.amount=htmrewards.find("input[name='rewardscustom']").val();rewardsAccountData.isMaxSelected=false;}else{return null;}}return rewardsAccountData;}return null;};payselectpage.actionDeleteExpiredCreditCardNowLink=function actionDeleteExpiredCreditCardNowLink(event){var target=$(event.target);var expired=target.parents("[existingcreditcard=copy]");var url="/gp/buy/payselect/handlers/delete-credit-card.html/";var extradata="paymentMethodId="+expired.attr("paymentmethodid");var callback="";var errorhandler="";var systemerrorhandler="generalErrorHandling";var tbody=expired.parents("#existing-credit-cards");var trs=tbody.find("tr");if(trs.length<=2){callback="payselectpage.refreshDashboard";}expired.attr("isdeleted","true").fadeOut(1500,function(){expired.remove();payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(true);});getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.actionUpdateExpirationNowLink=function actionUpdateExpirationNowLink(event){var target=$(event.target);var expired=target.parents("[existingcreditcard=copy]");expired.attr("creditcardupdated","true");expired.find("[datafield='expirationdate']").hide();expired.find("[datafield='expirednotify']").hide();expired.find("#expired-modify").show();expired.find("#new-cc-month").change(function(){payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(false);});expired.find("#new-cc-year").change(function(){payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(false);});if(expired.attr("isaddresschallenge")=="true"){payselectpage.showExpandoAlertArrow(expired);}logEvents.enqueue(new LogEntry(logEvents.CLICKED,expired.find(":radio").attr("id")+"-update-expiration",[]));};payselectpage.actionUpdateStartDate=function actionUpdateStartDate(event){var target=$(event.target);var updated=target.parents("[existingcreditcard=copy]");updated.attr("creditcardupdated","true");logEvents.enqueue(new LogEntry(logEvents.CLICKED,updated.find(":radio").attr("id")+"-update-startdate",[]));};payselectpage.actionUpdateIssueNumber=function actionUpdateIssueNumber(event){var target=$(event.target);var updated=target.parents("[existingcreditcard=copy]");updated.attr("creditcardupdated","true");logEvents.enqueue(new LogEntry(logEvents.CLICKED,updated.find(":radio").attr("id")+"-update-issuenumber",[]));};payselectpage.actionUpdatePurchaseOrderNumber=function actionUpdatePurchaseOrderNumber(event){var target=$(event.target);if(target.val()==target.attr("emptyvalue")){target.attr("maxlength","17").removeClass("default-value").val("");}else{if(target.val()==""){target.removeAttr("maxlength").addClass("default-value").val(target.attr("emptyvalue"));}}};payselectpage.actionChangedPurchaseOrderNumber=function actionChangePurchaseOrderNumber(event){payselectpage.ASYNC_CONTINUE_VALID=false;};payselectpage.asyncActionContinue=function asyncActionContinue(isDynamicSpc){if($("#existing-instruments .current").length==0){return ;}var url="/gp/buy/payselect/handlers/continue.html/";var callback="payselectpage.jsonAsyncContinue";var errorhandler="payselectpage.jsonAsyncErrorHandler";var systemerrorhandler="payselectpage.jsonAsyncErrorHandler";var extradata=payselectpage.generateContinueInputs();extradata+="&isAsync=1";if(!isDynamicSpc){extradata+="&returnstaticspc=1";}payselectpage.ASYNC_CONTINUE_VALID=true;payselectpage.WAITING_FOR_ASYNC_CONTINUE=true;if(payselectpage.ASYNC_CONTINUE_TIMEOUT){clearTimeout(payselectpage.ASYNC_CONTINUE_TIMEOUT);}getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.actionContinueWrapper=function actionContinueWrapper(event){payselectdiv.find(".continue-enabled").hide();payselectdiv.find(".continue-spinner").show();setscope(ASYNCSCOPE);setctb();resetue();logEvents.enqueue(new LogEntry(logEvents.CLICKED,$(event.target).attr("id"),[]));payselectpage.actionContinue(event);};payselectpage.actionContinue=function actionContinue(event){if(payselectpage.WAITING_FOR_ASYNC_CONTINUE){payselectpage.CONTINUE_CLICKED=true;payselectpage.CONTINUE_EVENT=event;return ;}payselectpage.CONTINUE_CLICKED=false;payselectpage.CONTINUE_EVENT=null;if(payselectpage.ASYNC_CONTINUE_VALID&&payselectpage.ASYNC_CONTINUE_PIPEDATA){payselectpage.ASYNC_CONTINUE_VALID=false;payselectpage.WAITING_FOR_ASYNC_CONTINUE=false;if(payselectpage.isbbq){bbqConductor(payselectpage.ASYNC_CONTINUE_PIPEDATA);}else{conductor(payselectpage.ASYNC_CONTINUE_PIPEDATA);}return ;}var url="/gp/buy/payselect/handlers/continue.html/"+getRefTag($(event.target));var callback="payselectpage.jsonContinue";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";var extradata=payselectpage.generateContinueInputs();extradata+="&change="+payselectpage.DASHBOARD_CLICK_COUNT;getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.generateContinueInputs=function generateContinueInputs(){var htmcurrent=$("#existing-instruments .current");var paymentMethodId="";if(!htmcurrent.attr("isnewinvoiceaccount")){paymentMethodId=htmcurrent.attr("paymentmethodid");}var paymentMethodType=htmcurrent.attr("paymentmethodtype");var canTryTFX=htmcurrent.attr("cantrytfx");var cvv="";if(htmcurrent.attr("requirescvv")){cvv=encodeURIComponent(htmcurrent.find("#existingcccvvnum").val());}var fpsPaymentMethodId="";if($("#existing-balance [flexiblepayments=copy] input").is(":checked")){fpsPaymentMethodId=$("#existing-balance [flexiblepayments=copy]").attr("paymentmethodid");}var existingBalance=$("#existing-balance [paymentmethodid='availablebalance']");var useGCBalance=existingBalance.find("[datafield='gcitem']").is(":visible")&&existingBalance.find("input").is(":checked");var usePromoBalance=!existingBalance.find("[datafield='promoitem']").is(":visible")||existingBalance.find("input").is(":checked");var currentlyUsesPromoBalance=payselectpage.CURRENTLY_USES_PROMO_BALANCE;var purchasingCardNumber="";if(payselectpage.CAN_INPUT_PCARD_REFERENCE_NUMBER&&payselectdiv.find(".current").attr("ispurchasingcard")=="true"){purchasingCardNumber=$("#purchasing-card-text").val();}var purchaseOrderNumber="";var purchaseOrderNumberElement=payselectdiv.find(".current").find("input[name='purchaseOrderNumber']");if(purchaseOrderNumberElement.attr("emptyvalue")&&purchaseOrderNumberElement.attr("emptyvalue")!=purchaseOrderNumberElement.val()){purchaseOrderNumber=purchaseOrderNumberElement.val();}var rewardsAccountId="";var rewardsAmount="";var rewardsRate="";var rewardsAccountData=payselectpage.getRewardsUsageData(htmcurrent);if(rewardsAccountData){rewardsAccountId=rewardsAccountData.id;rewardsAmount=rewardsAccountData.amount;rewardsRate=rewardsAccountData.rate;}var extradata="paymentMethodId="+paymentMethodId+"&paymentMethodType="+paymentMethodType+"&useGCBalance="+useGCBalance+"&usePromoBalance="+usePromoBalance+"&currentlyUsesPromoBalance="+currentlyUsesPromoBalance+"&fpsPaymentMethodId="+fpsPaymentMethodId+"&purchaseOrderNumber="+purchaseOrderNumber+"&purchasingCardNumber="+purchasingCardNumber+"&rewardAccountId="+rewardsAccountId+"&rewardAccountAmount="+rewardsAmount+"&rewardAccountRate="+rewardsRate+"&returnjson=1&returnpipedata=1"+"&isClientTimeBased=1"+"&canTryTFX="+canTryTFX+"&hasWorkingJavascript=1"+"&addCreditCardVerificationNumber="+cvv;$("#existing-instruments").find("[creditcardupdated=true]").each(function(i){var ccId=$(this).attr("paymentmethodid");var month=$(this).find("#new-cc-month").val();var year=$(this).find("#new-cc-year").val();if(!payselectpage.treatment_10435){var startdatemonth=$(this).find("#startdatemonth").val();var startdateyear=$(this).find("#startdateyear").val();var issuenumber=$(this).find("[datafield='issuenumber']").val();}var updatevalid=false;if(month&&year&&expirationValid(month,year)){extradata+="&month"+i+"="+month;extradata+="&year"+i+"="+year;updatevalid=true;}if(!payselectpage.treatment_10435){if(startdatemonth&&startdateyear&&startdateValid(startdatemonth,startdateyear)){extradata+="&startdatemonth"+i+"="+startdatemonth;extradata+="&startdateyear"+i+"="+startdateyear;updatevalid=true;}if(issuenumber!==null){extradata+="&issuenumber"+i+"="+issuenumber;updatevalid=true;}}var cardCurrency=payselectpage.getSelectedCardCurrency($(this));if(cardCurrency){extradata+="&cardCurrency"+i+"="+cardCurrency;updatevalid=true;}if(updatevalid){extradata+="&ccId"+i+"="+ccId;}});return extradata;};payselectpage.getSelectedCardCurrency=function getSelectedCardCurrency(cardRow){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}var selectedCardCurrencyRadio=$(".cardCurrencyRadio:checked",cardRow);if(selectedCardCurrencyRadio&&selectedCardCurrencyRadio.size()>0&&selectedCardCurrencyRadio.is(":visible")){if(selectedCardCurrencyRadio.val()=="Other"){var selectedCurrency=$(".cardCurrencyDropDown option:selected",cardRow);if(selectedCurrency.val()&&selectedCurrency.val()!=""){return selectedCurrency.val();}}else{return selectedCardCurrencyRadio.val();}}};payselectpage.actionContinueFormSubmitWrapper=function actionContinueFormSubmitWrapper(event){resetue();payselectpage.actionContinueFormSubmit(event);};payselectpage.actionContinueFormSubmit=function actionContinueFormSubmit(event){if(payselectpage.WAITING_FOR_ASYNC_CONTINUE){payselectpage.CONTINUE_CLICKED=true;payselectpage.CONTINUE_EVENT=event;return ;}payselectpage.CONTINUE_CLICKED=false;payselectpage.CONTINUE_EVENT=null;if(payselectpage.ASYNC_CONTINUE_VALID&&payselectpage.ASYNC_CONTINUE_SPCHTML){payselectpage.ASYNC_CONTINUE_VALID=false;payselectpage.WAITING_FOR_ASYNC_CONTINUE=false;$("#pagecontentplaceholder").html(decodeJSonResponse(payselectpage.ASYNC_CONTINUE_SPCHTML));eventPageLoaded();return ;}var htmcurrent=$("#existing-instruments .current");var paymentMethodId="";if(!htmcurrent.attr("isnewinvoiceaccount")){paymentMethodId=htmcurrent.attr("paymentmethodid");}var paymentMethodType=htmcurrent.attr("paymentmethodtype");var canTryTFX=htmcurrent.attr("cantrytfx");var fpsPaymentMethodId="";if($("#existing-balance [flexiblepayments=copy] input").is(":checked")){fpsPaymentMethodId=$("#existing-balance [flexiblepayments=copy]").attr("paymentmethodid");}var existingBalance=$("#existing-balance [paymentmethodid='availablebalance']");var useGCBalance=existingBalance.find("[datafield='gcitem']").is(":visible")&&existingBalance.find("input").is(":checked");var usePromoBalance=!existingBalance.find("[datafield='promoitem']").is(":visible")||existingBalance.find("input").is(":checked");var currentlyUsesPromoBalance=payselectpage.CURRENTLY_USES_PROMO_BALANCE;var purchasingCardNumber="";if(payselectpage.CAN_INPUT_PCARD_REFERENCE_NUMBER&&payselectdiv.find(".current").attr("ispurchasingcard")=="true"){purchasingCardNumber=$("#purchasing-card-text").val();}var purchaseOrderNumber="";var purchaseOrderNumberElement=payselectdiv.find(".current").find("input[name=purchaseOrderNumber]");if(purchaseOrderNumberElement.attr("emptyvalue")&&purchaseOrderNumberElement.attr("emptyvalue")!=purchaseOrderNumberElement.val()){purchaseOrderNumber=purchaseOrderNumberElement.val();}var rewardsAccountId="";var rewardsAmount="";var rewardsRate="";var rewardsAccountData=payselectpage.getRewardsUsageData(htmcurrent);if(rewardsAccountData){rewardsAccountId=rewardsAccountData.id;rewardsAmount=rewardsAccountData.amount;rewardsRate=rewardsAccountData.rate;}var cvv="";if(htmcurrent.attr("requirescvv")){cvv=encodeURIComponent(htmcurrent.find("#existingcccvvnum").val());}var url="/gp/buy/payselect/handlers/continue.html/"+getRefTag($(event.target));var formHtm='<form id="continueForm" name="continueForm" action="'+url+'" method="POST">';formHtm+='<input name="paymentMethodId" value="'+paymentMethodId+'" type="hidden" />';formHtm+='<input name="paymentMethodType" value="'+paymentMethodType+'" type="hidden" />';formHtm+='<input name="useGCBalance" value="'+useGCBalance+'" type="hidden" />';formHtm+='<input name="usePromoBalance" value="'+usePromoBalance+'" type="hidden" />';formHtm+='<input name="currentlyUsesPromoBalance" value="'+currentlyUsesPromoBalance+'" type="hidden" />';formHtm+='<input name="fpsPaymentMethodId" value="'+fpsPaymentMethodId+'" type="hidden" />';formHtm+='<input name="purchaseOrderNumber" value="'+purchaseOrderNumber+'" type="hidden" />';formHtm+='<input name="purchasingCardNumber" value="'+purchasingCardNumber+'" type="hidden" />';formHtm+='<input name="rewardAccountId" value="'+rewardsAccountId+'" type="hidden" />';formHtm+='<input name="rewardAccountAmount" value="'+rewardsAmount+'" type="hidden" />';formHtm+='<input name="rewardAccountRate" value="'+rewardsRate+'" type="hidden" />';formHtm+='<input name="hasWorkingJavascript" value="1" type="hidden" />';formHtm+='<input name="returnjson" value="0" type="hidden" />';formHtm+='<input name="canTryTFX" value="'+canTryTFX+'" type="hidden" />';formHtm+='<input name="addCreditCardVerificationNumber" value="'+cvv+'" type="hidden" />';$("#existing-instruments").find("[creditcardupdated=true]").each(function(i){var ccId=$(this).attr("paymentmethodid");var month=$(this).find("#new-cc-month").val();var year=$(this).find("#new-cc-year").val();var startdatemonth=$(this).find("#startdatemonth").val();var startdateyear=$(this).find("#startdateyear").val();var issuenumber=$(this).find("[datafield=issuenumber]").val();var updatevalid=false;if(month&&year&&expirationValid(month,year)){formHtm+='<input name="month'+i+'" value="'+month+'" type="hidden" />';formHtm+='<input name="year'+i+'" value="'+year+'" type="hidden" />';updatevalid=true;}if(startdatemonth&&startdateyear&&startdateValid(startdatemonth,startdateyear)){formHtm+='<input name="startdatemonth'+i+'" value="'+startdatemonth+'" type="hidden" />';formHtm+='<input name="startdateyear'+i+'" value="'+startdateyear+'" type="hidden" />';updatevalid=true;}if(issuenumber!==null){formHtm+='<input name="issuenumber'+i+'" value="'+issuenumber+'" type="hidden" />';updatevalid=true;}if(updatevalid){formHtm+='<input name="ccId'+i+'" value="'+ccId+'" type="hidden" />';}});formHtm+="</form>";logEvents.enqueue(new LogEntry(logEvents.CLICKED,$(event.target).attr("id"),[]));payselectdiv.append(formHtm);$("#continueForm").submit();};payselectpage.actionChangeCurrencyLinkClick=function actionChangeCurrencyLinkClick(event){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}var changeCurrencyLink=$(event.target);changeCurrencyLink.attr("clicked","true");payselectpage.markCardAsUpdated(event);var cardRow=changeCurrencyLink.parents("tr[behavior=singlepaymentmethod]");payselectpage.displaySuitableCardCurrencyUi(cardRow);payselectpage.selectOtherCurrencyRadioButton(cardRow);};payselectpage.selectOtherCurrencyRadioButton=function selectOtherCurrencyRadioButton(cardRow){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}var otherRadio=$("input.cardCurrencyRadio[value=Other]",cardRow);otherRadio.attr("checked",true);};payselectpage.markCardAsUpdated=function markCardAsUpdated(cardEvent){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}var target=$(cardEvent.target);var card=target.parents("[existingcreditcard=copy]");card.attr("creditcardupdated","true");};payselectpage.actionCurrencyRadioClick=function actionCurrencyRadioClick(event){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}payselectpage.markCardAsUpdated(event);};payselectpage.actionCurrencyDropdownChange=function actionCurrencyDropdownChange(event){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}var inputSelect=$(event.target);var cardRow=inputSelect.parents("tr[behavior=singlepaymentmethod]");payselectpage.selectOtherCurrencyRadioButton(cardRow);payselectpage.markCardAsUpdated(event);payselectpage.uiSelectDashboardRow(cardRow);};payselectpage.isCurrencyAttributeUiEnabled=function isCurrencyAttributeUiEnabled(){return(PIPELINE.pipedata&&PIPELINE.pipedata.weblabs&&PIPELINE.pipedata.weblabs.payselect&&PIPELINE.pipedata.weblabs.payselect.RCX_CHECKOUT_TFX_CURRENCY_ATTRIBUTE_14224=="T1");};payselectpage.uiSelectDashboardRow=function uiSelectDashboardRow(row){if($("#order-summary .continue-disabled").is(":visible")){$("#continue-blocker-box").hide();$("#order-summary .continue-disabled").hide();$("#order-summary .continue-enabled").show();}var rewardsrow=row.filter("[datafield^=rewardsselect]");if(rewardsrow.size()>0){if(rewardsrow.find("input[type=radio]").is(":not(:disabled)")){rewardsrow.siblings("[datafield^=rewardsselect]").find(".rewardsselecttoggle").hide();rewardsrow.find("input[type=radio]").attr("checked","checked");rewardsrow.find(".rewardsselecttoggle").show();}row=rewardsrow.parents("tr");}row.find("table.rewardsspendtable").show();payselectpage.displaySuitableCardCurrencyUi(row);var input=row.find("input[name=pm]");if(row.attr("behavior")=="singlepaymentmethod"){logEvents.enqueue(new LogEntry(logEvents.ROW_SELECTED,input.attr("id"),[]));var htmcurrent=$("#existing-instruments tr.current");if(!row.hasClass("current")){htmcurrent.find("#existing-card-cvv-text input").val("");htmcurrent.find("div.rewardsusage:visible").find("table.rewardsspendtable").hide();payselectpage.hideCardCurrencyUi(htmcurrent);if(htmcurrent.attr("isaddresschallenge")=="true"){payselectpage.hideAddressChallengeExpando(htmcurrent);}if(htmcurrent.attr("id")=="new-verified-credit-card"){$("#acceptvcc").show();$("#addnewvcc").hide();}else{if(htmcurrent.attr("id")=="verified_debitCard"){if($("#verified_debitCard_banking_select").attr("value")=="OtherBanks"){payselectdiv.find("#verified_debitCard_banking_select").val("");payselectdiv.find("#new-vdc-otherbanks").hide();}payselectdiv.find("#chooseDebitCardBank").hide();}else{if(htmcurrent.attr("id")=="cash-on-delivery-cash-enabled"){$("#cod-message-2nd-line-enable").hide();$("#cod-terms-conditions").hide();}else{if(htmcurrent.attr("id")=="nb_netbanking"){payselectdiv.find("#choosenetbanking").hide();}}}}if(row.attr("isaddresschallenge")=="true"){payselectpage.showAddressChallengeExpando(row);payselectpage.createExpandoValidators(row);}}$("#existing-instruments tr.current").removeClass("current");row.addClass("current");input.attr("checked","checked");if(row.attr("id")=="cash-on-delivery-cash-enabled"&&row.attr("showcodcashmessage2ndline")=="true"){$("#cod-message-2nd-line-enable").show();$("#cod-terms-conditions").show();}if(row.attr("id")=="verified_debitCard"){var verifedDebitCard=$("#verified_debitCard_banking_select").attr("value");if(verifedDebitCard&&verifedDebitCard!="OtherBanks"){payselectdiv.find("#chooseDebitCardBank").show();}}if(row.attr("id")=="nb_netbanking"&&$("#netBanking_select").attr("value")){payselectdiv.find("#choosenetbanking").show();}if(row.attr("isaddresschallenge")!="true"){if(payselectpage.CAN_INPUT_PCARD_REFERENCE_NUMBER&&(row.attr("ispurchasingcard")=="true")){$("#purchasing-card-number").show();}else{$("#purchasing-card-number").hide();}}}else{if(row.attr("behavior")=="multipaymentmethod"){logEvents.enqueue(new LogEntry(logEvents.CHECKBOX_TOGGLED,input.attr("id"),[]));input.toggleCheckbox();}}payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(false);if(payselectpage.isSpcPrefetchAllowed(row)){if(payselectpage.optimisticsetpayment()){payselectpage.DASHBOARD_CHANGE_RETRY_COUNT++;}}else{payselectpage.ASYNC_CONTINUE_VALID=false;}payselectpage.DASHBOARD_CLICK_COUNT++;};payselectpage.isSpcPrefetchAllowed=function isSpcPrefetchAllowed(row){if(row.attr("requirescvv")){return false;}if(payselectpage.isCurrencyAttributeUiEnabled()){var cardCurrencySelectorDiv=$(".cardCurrencySelector",row);return !(cardCurrencySelectorDiv&&cardCurrencySelectorDiv.is(":visible"));}return true;};payselectpage.optimisticsetpayment=function optimisticsetpayment(){payselectpage.ASYNC_CONTINUE_VALID=false;if(!payselectpage.CONTINUE_ERROR_AUTHORITY.hasErrors()&&payselectpage.DASHBOARD_CLICK_COUNT>0&&payselectpage.DASHBOARD_CHANGE_RETRY_COUNT<=payselectpage.RETRYOPTIMISTICCHANGE&&payselectpage.TIMEOUTRETRYCOUNT<payselectpage.RETRYOPTIMISTICTIMEOUT&&!payselectpage.WAITING_FOR_ASYNC_CONTINUE){payselectpage.WAITING_FOR_ASYNC_CONTINUE=false;payselectpage.ASYNC_CONTINUE_PIPEDATA=null;if(payselectpage.ASYNC_CONTINUE_TIMEOUT){clearTimeout(payselectpage.ASYNC_CONTINUE_TIMEOUT);}payselectpage.asyncActionContinue(payselectpage.CONTINUE=="ajax");return true;}return false;};payselectpage.positionElementsIE=function positionElementsIE(){if(jQuery.browser.msie===true&&jQuery.browser.version=="6.0"){var dwBL_y=$("#existing-instruments").height()+15+"px";$("#dashboard-wrapper_BL").css({"top":dwBL_y,"left":"-5px"});var wBR_y=$("#wrapper").height()-4+"px";$("#wrapper-BR").css({"top":wBR_y,"right":"0px"});var oswBL_y=$("#wrapper").height()-6+"px";$("#os-wrapper-BL").css({"top":oswBL_y});var oswBR_y=$("#wrapper").height()-6+"px";$("#os-wrapper-BR").css({"top":oswBR_y});var elbow_y=$("#existing-instruments").height()+18+"px";var elbow_x=$("#existing-instruments").width()+12+"px";$("#elbow").css({"top":elbow_y,"left":elbow_x});$("#order-summary").append("<div id='os-border-blocker'>&nbsp</div>");$("#os-border-blocker").height($("#dashboard-wrapper").height()+7).css("background-color",$("#wrapper").css("background-color"));var y=($("#dashboard-wrapper").height()-$("#dashboard-spinner").height())/2+"px";var x=$("#dashboard-wrapper").width()/2+"px";$("#dashboard-spinner").css({"top":y,"left":x});y=$("#existing-instruments").height()/2+"px";x=$("#existing-instruments").width()/2+"px";$("#existing-instruments-spinner").css({"top":y,"left":x});y=$("#os-wrapper").height()/2+"px";x=$("#os-wrapper").width()/2+"px";$("#os-summary-spinner").css({"top":y,"left":x});}};payselectpage.uiDashboardResize=function uiDashboardResize(){payselectpage.positionElementsIE();var diff=$("#existing-instruments").outerHeight()-$("#os-wrapper").outerHeight();var BORDERSTYLE="1px solid "+$("#os-wrapper").css("border-left-color");if(diff>=0){$("#elbow").hide();$("#wrapper-BR").show();$("#os-wrapper-BR").hide();$("#os-wrapper-BL").hide();$("#os-wrapper").css("border-bottom",0);}else{if(diff<0&&diff>=-29){$("#elbow").hide();$("#wrapper-BR").show();$("#os-wrapper-BR").hide();$("#os-wrapper-BL").hide();$("#os-wrapper").css("border-bottom",0);$("#existing-instruments").css("padding-bottom","1px");}else{$("#elbow").show();$("#wrapper-BR").hide();$("#os-wrapper-BR").show();$("#os-wrapper-BL").show();$("#os-wrapper").css("border-bottom",BORDERSTYLE);}}};payselectpage.uiDashboardSpinner=function uiDashboardSpinner(enable){if(enable){$("#order-summary").fadeTo("fast","0.33");$("#existing-instruments-wrapper").fadeTo("fast","0.33");$("#dashboard-spinner").show();}else{$("#dashboard-spinner").hide();$("#order-summary").fadeTo("fast","1");$("#existing-instruments-wrapper").fadeTo("fast","1");}};payselectpage.uiOrderSummarySpinner=function uiOrderSummarySpinner(enable){if(enable){$("#order-summary").fadeTo("fast","0.33");$("#os-summary-spinner").show();}else{$("#os-summary-spinner").hide();$("#order-summary").fadeTo("fast","1");}};payselectpage.uiExistingInstrumentsSpinner=function uiExistingInstrumentsSpinner(enable){if(enable){$("#existing-instruments-wrapper").fadeTo("fast","0.33");$("#existing-instruments-spinner").show();}else{$("#existing-instruments-spinner").hide();$("#existing-instruments-wrapper").fadeTo("fast","1");}};payselectpage.htmlAvailableBalance=function htmlAvailableBalance(total,totalraw,giftcard,promotion,availablebalancecoverstotal,usepromotions,usegiftcard,purchasetotal,purchasetotalraw){var htm=$("#existing-balance [existingbalance='template']").clone(true);i=300;htm.attr("paymentmethodid","availablebalance");htm.attr("existingbalance","copy");htm.find("input").attr("id","pm_"+i);htm.find("[datafield='balance']").attr("for","pm_"+i);if(availablebalancecoverstotal){htm.attr("behavior","singlepaymentmethod");htm.find("[type='checkbox']").remove();}else{htm.attr("behavior","multipaymentmethod");htm.find("[type='radio']").remove();}htm.find("[datafield='balancetext']").prepend(total+"&nbsp;");$("#continue-blocker-box [error='continue_BadGCorPromoBalance'] [datafield='gcpromototal']").html(total);$("#continue-blocker-box [error='continue_BadGCorPromoBalance'] [datafield='purchasetotal']").html(purchasetotal);$("#continue-blocker-box [error='continue_BadGCorPromoBalance'] [datafield='gcpromototal']").attr("total",totalraw);$("#continue-blocker-box [error='continue_BadGCorPromoBalance'] [datafield='purchasetotal']").attr("total",purchasetotalraw);if(giftcard){htm.find("[datafield='gcitem']").prepend(giftcard).show();}if(promotion){htm.find("[datafield='promoitem']").prepend(promotion).show();}htm.appendTo("#existing-balance");htm.show();if(!usepromotions||!usegiftcard){var html=payselectdiv.find("[paymentmethodid='availablebalance']");if(html!==null){if((html.find("[type='checkbox']").length!==0)&&html.find("[datafield='promoitem']").is(":visible")){html.find("[type='checkbox']").removeAttr("checked");}}}};payselectpage.htmlFlexiblePayments=function htmlFlexiblePayments(flexiblepayments,useFlexiblePayments){var htm=$("#existing-balance [flexiblepayments='template']").clone(true);i=400;htm.attr("paymentmethodid",flexiblepayments.paymentmethodid);htm.attr("flexiblepayments","copy");htm.find("input").attr("id","pm_"+i);htm.find("[datafield='balance']").attr("for","pm_"+i);htm.find("[datafield='balancetext']").prepend(flexiblepayments.balance+"&nbsp;");if(useFlexiblePayments){htm.find("input").attr("checked","checked");}htm.appendTo("#existing-balance");htm.show();};payselectpage.htmlOrderSummaryRow=function htmlOrderSummaryRow(i,row){var htm;if(row.style=="separator"){htm=$("#order-summary [subtotalsseparator='template']").clone();htm.attr("subtotalsseparator","copy");}else{if(row.style=="grandTotal"){htm=$("#order-summary [subtotalstotal='template']").clone();htm.attr("subtotalstotal","copy");htm.find("[datafield='label']").prepend(row.label);htm.find("[datafield='price']").html(row.value);}else{htm=$("#order-summary [subtotalsline='template']").clone();htm.attr("subtotalsline","copy");htm.find("[datafield='label']").html(row.label);htm.find("[datafield='price']").html(row.value);}}htm.appendTo("#order-summary table.subtotals");htm.show();};payselectpage.convertDollarsToPoints=function convertDollarsToPoints(paymentmethodid,dollars){var decimalPlaces=0;if(payselectpage.REWARDS_ACCOUNTS[paymentmethodid].rewardsdecimalplaces){decimalPlaces=payselectpage.REWARDS_ACCOUNTS[paymentmethodid].rewardsdecimalplaces;}return getNumberWithSeparators((dollars/payselectpage.REWARDS_ACCOUNTS[paymentmethodid].ratio),decimalPlaces);};payselectpage.htmlRewardsAccount=function htmlRewardsAccount(i,htm,rewardsaccount,isaddresschallenge){if(rewardsaccount){var htmdatafields=htm.find("[datafield]");if(rewardsaccount.displaydata){for(var stringKey in rewardsaccount.displaydata){htmdatafields.filter("[datafield="+stringKey+"]").html(rewardsaccount.displaydata[stringKey]);}}var htmrewards;if(rewardsaccount.hasconstraintviolation){htmrewards=htm.find("div.rewardserror");var constraint=rewardsaccount.constraintviolation;if(constraint=="RewardAccountNegativeBalanceConstraintViolation"){htmrewards.find(".negativebalance").show();}else{if(constraint=="RewardAccountZeroBalanceConstraintViolation"){htmrewards.find(".zerobalance").show();}else{if(constraint=="RewardAccountNotEligibleForPurchaseConstraintViolation"){htmrewards.find(".noteligibletospend").show();payselectpage.setupPointsPopoverMessage(rewardsaccount,htmdatafields,htmrewards,"rewards-noteligibletospend-container","rewards-noteligibletospend-popover","rewards-noteligibletospend-popover-title","rewards-noteligibletospend-popover-content");}else{if(constraint=="RewardAccountNullBalanceConstraintViolation"){htmrewards.find(".nullbalance").show();payselectpage.setupPointsPopoverMessage(rewardsaccount,htmdatafields,htmrewards,"rewards-nullbalance-container","rewards-nullbalance-popover","rewards-nullbalance-popover-title","rewards-nullbalance-popover-content");}else{if(constraint=="RewardAccountSpendOutageConstraintViolation"){htmrewards.find(".spendoutage").show();payselectpage.setupPointsPopoverMessage(rewardsaccount,htmdatafields,htmrewards,"rewards-spendoutage-container","rewards-spendoutage-popover","rewards-spendoutage-popover-title","rewards-spendoutage-popover-content");}else{htmrewards.find(".rewardserror").show();payselectpage.setupPointsPopoverMessage(rewardsaccount,htmdatafields,htmrewards,"rewards-rewardserror-container","rewards-rewardserror-popover","rewards-rewardserror-popover-title","rewards-rewardserror-popover-content");}}}}}}else{if(!rewardsaccount.registered){if(rewardsaccount.registrationtype=="AUTOMATIC"){htmrewards=htm.find("div.autoreg");htmrewards.attr("issuerid",rewardsaccount.issuerid);htmrewards.attr("programid",rewardsaccount.programid);}else{htmrewards=htm.find("div.rewardseligible");htmrewards.attr("issuerid",rewardsaccount.issuerid);htmrewards.attr("programid",rewardsaccount.programid);}}else{var id=rewardsaccount.paymentmethodid;var rewardsData={};rewardsData.ratio=rewardsaccount.conversionratio;rewardsData.rewardsdecimalplaces=rewardsaccount.rewardsdecimalplaces;rewardsData.maxusabledollars=rewardsaccount.maxusabledollars;rewardsData.mindollars=rewardsaccount.mindollaramount;payselectpage.REWARDS_ACCOUNTS[id]=rewardsData;htmrewards=htm.find("div.rewardsusage");htmrewards.attr("paymentmethodid",id);var replacerewardsselect=function(htm){htm.html(htm.html().replace(/rewardsselect/,"rewardsselect"+id));};replacerewardsselect(htmdatafields.filter("[datafield=rewardsselectmax]").find("input[value=rewardsmax]").parent());replacerewardsselect(htmdatafields.filter("[datafield=rewardsselectcustom]").find("input[value=rewardscustom]").parent());replacerewardsselect(htmdatafields.filter("[datafield=rewardsselectnone]").find("input[value=rewardsnone]").parent());htmdatafields.filter("[datafield=rewardsselectnone]").find("input[value=rewardsnone]").attr("checked","checked");htmdatafields.filter("[datafield=rewardsselectnone]").find("input[value=rewardsnone]").attr("defaultChecked","defaultChecked");if(rewardsaccount.showcoverstotalmessage){htmrewards.find(".rewardscoverstotal").show();}else{htmrewards.find(".rewardsnotcoverstotal").show();}htm.find("span[datafield=rewardsbalance]").html(rewardsaccount.dollarbalancedisplay);htm.find("span[datafield=rewardsbalancepoints]").html(getNumberWithSeparators(rewardsaccount.pointsbalance,rewardsaccount.rewardsdecimalplaces));if(rewardsaccount.usenewbalancedisplay){var htmbalance=htm.find("span[datafield=rewards_usage_balance]");var balancedisplay=payselectpage.setupPointsBalanceMessage(htmbalance.html(),htmdatafields.filter("[datafield=rewardsbalancepoints]"),htmdatafields.filter("[datafield=rewardsbalance]"),htmdatafields.filter("[datafield=rewards_usage_autopopover_link]"));htmbalance.html(balancedisplay);htmbalance.show();htm.find(".rewardsbalancemessage_c").hide();}htmdatafields.filter("[datafield=maxdollaramount]").html(rewardsaccount.maxusabledollarsdisplay);htmdatafields.filter("[datafield=maxdollaramount]").attr("amount",rewardsData.maxusabledollars);htmdatafields.filter("[datafield=maxpointsamount]").html(payselectpage.convertDollarsToPoints(id,rewardsData.maxusabledollars));htmdatafields.filter("[datafield=custompointsamount]").html(payselectpage.convertDollarsToPoints(id,0));htmrewards.find("input[name=rewardscustom]").attr("useintegervalidation",rewardsaccount.useintegervalidation);if(!rewardsaccount.hasminspendamount){htmrewards.find("input").attr("disabled","true");}if(rewardsaccount.showautoregistermessage){payselectpage.setupPointsPopoverMessage(rewardsaccount,htmdatafields,htmrewards,"rewards-autoregistration-container","rewards-autoregistration-popover","auto-rewards-popover-title","rewards-autoregistration-popover-content");}}}if(isaddresschallenge=="true"){htmrewards.attr("rewardshiddenforaddresschallenge","true");}else{htmrewards.show();}}};payselectpage.setupPointsPopoverMessage=function setupPointsPopoverMessage(rewardsaccount,htmdatafields,htmrewards,containerClass,popoverClass,popoverTitleClass,popoverContentClass){if(rewardsaccount.marketinglink){htmdatafields.filter("[datafield=rewards_marketing_link]").html(rewardsaccount.marketinglink);}htmrewards.find("."+containerClass).show();amznJQ.available("popover",function(){amznJQ.jQuery(htmrewards.find("."+popoverClass)).amazonPopoverTrigger({title:htmrewards.children("."+popoverTitleClass).text(),localContent:htmrewards.children("."+popoverContentClass),zIndex:1000,showOnHover:true,width:450,height:150,modal:false,clone:true,draggable:false,showCloseButton:false,location:"right"});});};payselectpage.setupPointsBalanceMessage=function setupPointsBalanceMessage(balancestring,pointsbalancehtm,dollarbalancehtm,popoverlinkhtm){var replacerewardbalance=function(replacestring,htmobject){if(htmobject){var destinationhtml=htmobject.remove().wrap("<p>").parent().html();balancestring=balancestring.replace(replacestring,destinationhtml);}};replacerewardbalance("{points}",pointsbalancehtm);replacerewardbalance("{dollars}",dollarbalancehtm);replacerewardbalance("{popover}",popoverlinkhtm);return balancestring;};payselectpage.htmlCreditCard=function htmlCreditCard(i,instrument,template,hiderewardsaccount){var htm=null;if(template){htm=template.clone(true);}else{htm=$("#existing-credit-cards [existingcreditcard='template']").clone(true);}htm.attr("paymentmethodid",instrument.paymentmethodid);htm.attr("paymentmethodtype",instrument.paymentmethodtype);htm.attr("ispurchasingcard",instrument.ispurchasingcard);htm.attr("cantrytfx",instrument.cantrytfx);htm.attr("existingcreditcard","copy");htm.find("input:radio[name='pm']").attr({id:"pm_"+i});htm.attr("issuer",instrument.issuer);htm.attr("brand",instrument.brand);htm.attr("tail",instrument.tail);htm.attr("isaddresschallenge",instrument.isaddresschallenge);htm.attr("needsecuritycode",instrument.needsecuritycode);htm.attr("requirescvv",instrument.requirescvv);htm.attr("validcvvlength",instrument.validcvvlength);var htmdatafields=htm.find("[datafield]");htmdatafields.filter("[datafield=cardname]").attr("for","pm_"+i).find("span").append(instrument.tail);htmdatafields.filter("[datafield=cardnametext]").html(instrument.issuerdisplayname?instrument.issuerdisplayname:instrument.type);if(instrument.issuerdisplayimage){htmdatafields.filter("[datafield=atm-cardimage]").attr("src",instrument.issuerdisplayimage).attr("alt",instrument.issuerdisplayname).show();}else{var cardtype=creditCardType(instrument.type);htmdatafields.filter("[datafield="+cardtype+"-cardimage]").attr({alt:instrument.type}).show();}htmdatafields.filter("[datafield=cardholdername]").html(decodeJSonResponse(instrument.name));htmdatafields.filter("[datafield=expirationdate]").prepend(instrument.expiration);if(!payselectpage.treatment_10435){if(instrument.issuenumber){htmdatafields.filter("[datafield=issuenumber]").attr("value",instrument.issuenumber);htm.find("#updateissuenumber").unbind("click").bind("click",payselectpage.actionUpdateIssueNumber);htm.find("#updateissuenumber").show();}else{if(instrument.startdatemonth&&instrument.startdateyear){var startdatemonth=parseInt(instrument.startdatemonth,10);var startdateyear=parseInt(instrument.startdateyear,10);var date=new Date();var currentYear=parseInt(date.getFullYear(),10);populateYearDropdown(htm.find("#startdateyear"),currentYear-5,currentYear);htm.find("#startdatemonth [value="+startdatemonth+"]").attr("selected","true");htm.find("#startdateyear [value="+startdateyear+"]").attr("selected","true");htm.find("#startdate").unbind("click").bind("click",payselectpage.actionUpdateStartDate);htm.find("#startdate").show();}}}if((instrument.expired||instrument.expiringsoon)&&!instrument.hideexpirationdate){var expirationSplit=instrument.expiration.split("/");var expirationMonth=parseInt(expirationSplit[0],10);var expirationYear=parseInt(expirationSplit[1],10);populateYearDropdown(htm.find("#new-cc-year"),expirationYear,expirationYear+20);htm.find("#new-cc-month [value="+expirationMonth+"]").attr("selected","true");if(instrument.expired){htmdatafields.filter("[datafield=expirationdate]").show().hide();htmdatafields.filter("[datafield=expirednotify]").show();htmdatafields.filter("[datafield=expiredtext]").append(instrument.expiration);htm.find("#expired-updater").unbind("click").bind("click",payselectpage.actionUpdateExpirationNowLink);htm.find("#expired-deleter").unbind("click").bind("click",payselectpage.actionDeleteExpiredCreditCardNowLink);htm.attr("cardexpired","true");}else{if(instrument.expiringsoon){htm.find("#update-expiring-soon").show();htm.find("#update-expiring-soon").unbind("click").bind("click",payselectpage.actionUpdateExpirationNowLink);htm.attr("cardexpired","true");}}}else{htm.attr("cardexpired","false");}if(!hiderewardsaccount&&instrument.rewardsaccount){payselectpage.htmlRewardsAccount(i,htm,instrument.rewardsaccount,instrument.isaddresschallenge);}if(instrument.preferredcurrency||instrument.derivedcurrency){payselectpage.htmlCardCurrency(htm,instrument.paymentmethodid,instrument.preferredcurrency,instrument.derivedcurrency,instrument.isaddresschallenge);}if(instrument.requirescvv){htm.find("#existing-card-cvv-text").show();$("#existing-card-cvv-title").show();}else{htm.find("#existing-card-cvv-text").hide();}htm.appendTo("#existing-credit-cards");htm.show();};payselectpage.hideCardCurrencyUi=function hideCardCurrencyUi(cardRow){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}var cardCurrency=$("div.cardCurrency",cardRow);if(cardCurrency&&cardCurrency.size()>0){cardCurrency.hide();}};payselectpage.displaySuitableCardCurrencyUi=function displaySuitableCardCurrencyUi(cardRow){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}var cardCurrency=$("div.cardCurrency",cardRow);if(cardCurrency&&cardCurrency.size()>0){var currencyUiEligibility=cardCurrency.attr("currencyUiEligible");if(currencyUiEligibility&&currencyUiEligibility=="true"){var cardCurrencyHiddenAttr=cardCurrency.attr("currencyHiddenForAddressChallenge");if(cardCurrencyHiddenAttr==undefined||cardCurrencyHiddenAttr!="true"){cardCurrency.show();var displayCardCurrencyMessage=false;var cardCurrencyMessage=$(".cardCurrencyMessage",cardRow);var cardCurrencySelector=$(".cardCurrencySelector",cardRow);var cardCurrencyMessageLabel=$(".currencyLabel",cardCurrencyMessage);if(cardCurrencyMessageLabel&&cardCurrencyMessageLabel.size()>0&&cardCurrencyMessageLabel.attr("currency")&&cardCurrencyMessageLabel.attr("currency")!=""){var changeCurrencyLink=$(".changeCurrencyLink",cardCurrencyMessage);displayCardCurrencyMessage=!(changeCurrencyLink&&changeCurrencyLink.size()>0&&changeCurrencyLink.attr("clicked")&&changeCurrencyLink.attr("clicked")=="true");}if(displayCardCurrencyMessage){cardCurrencyMessage.show();cardCurrencySelector.hide();}else{cardCurrencyMessage.hide();cardCurrencySelector.show();}}else{cardCurrency.hide();}}else{cardCurrency.hide();}}};payselectpage.htmlCardCurrency=function htmlCardCurrency(htm,paymentmethodid,preferredcurrency,derivedcurrency,isAddressChallenge){if(!payselectpage.isCurrencyAttributeUiEnabled()){return ;}if((preferredcurrency&&preferredcurrency!="")||(derivedcurrency&&derivedcurrency!="")){var cardCurrency=htm.find("div.cardCurrency");cardCurrency.attr("currencyUiEligible","true");if(isAddressChallenge=="true"){cardCurrency.attr("currencyHiddenForAddressChallenge","true");}var currency=preferredcurrency;if(!preferredcurrency){currency=derivedcurrency;}var currencyText=cardCurrency.find("option[value='"+currency+"']").html();var currencyLabel=cardCurrency.find(".cardCurrencySelector .currencyLabel");currencyLabel.html(currencyLabel.html().replace("currencyCode",currencyText));var cardCurrencyRadios=$(".cardCurrencyRadio",cardCurrency);if(cardCurrencyRadios&&cardCurrencyRadios.length==2){$(cardCurrencyRadios[0]).attr("name",$(cardCurrencyRadios[0]).attr("name")+"."+paymentmethodid);$(cardCurrencyRadios[1]).attr("name",$(cardCurrencyRadios[1]).attr("name")+"."+paymentmethodid);}var cardCurrencyRadio=$(".cardCurrencyRadio[value!='Other']",cardCurrency);if(cardCurrencyRadio&&cardCurrencyRadio.size()>0){cardCurrencyRadio.val(currency);}if(preferredcurrency){var cardCurrencyMessageLabel=cardCurrency.find(".cardCurrencyMessage .currencyLabel");cardCurrencyMessageLabel.html(cardCurrencyMessageLabel.html().replace("currencyCode",currencyText));cardCurrencyMessageLabel.attr("currency",preferredcurrency);}}};payselectpage.htmlLocAccount=function htmlLocAccount(i,instrument,purchaseordernumber,template){i+=600;var htm=null;if(template){htm=template.clone(true);}else{htm=$("#existing-loc-accounts [existinglocaccount='template']").clone(true);}htm.attr("paymentmethodid",instrument.paymentmethodid);htm.attr("paymentmethodtype",instrument.paymentmethodtype);htm.attr("existinglocaccount","copy");htm.find("input").attr({id:"pm_"+i});htm.find("[datafield='name']").attr("for","pm_"+i).find(".loc-name").html(instrument.type);htm.find("[datafield='name']").find(".ending-in").append(instrument.tail);var poInput=htm.find("[name='purchaseOrderNumber']");if(purchaseordernumber==null||purchaseordernumber==""){poInput.addClass("default-value").val(poInput.attr("emptyvalue"));}else{poInput.removeClass("default-value").val(purchaseordernumber);}htm.appendTo("#existing-loc-accounts");htm.show();};payselectpage.htmlCheckingAccount=function htmlCheckingAccount(i,instrument){i+=100;var htm=$("#existing-checking-accounts [existingcheckingaccount='template']").clone(true);htm.attr("paymentmethodid",instrument.paymentmethodid);htm.attr("paymentmethodtype",instrument.paymentmethodtype);htm.attr("existingcheckingaccount","copy");htm.find("input").attr({id:"pm_"+i});htm.find("[datafield='bankname']").attr("for","pm_"+i).find("span").append(instrument.tail);htm.find("[datafield='banknametext']").html(instrument.type);htm.find("[datafield='accountholdername']").html(instrument.name);htm.appendTo("#existing-checking-accounts");htm.show();};payselectpage.htmlDirectDebit=function htmlDirectDebit(i,instrument){i+=200;var htm=payselectdiv.find("[existingdirectdebit='template']").clone(true);htm.attr("paymentmethodid",instrument.paymentmethodid);htm.attr("paymentmethodtype",instrument.paymentmethodtype);htm.attr("existingdirectdebit","copy");htm.find("input").attr({id:"pm_"+i});htm.find("[datafield='debitbank']").attr("for","pm_"+i).find("span").append(instrument.tail);htm.find("[datafield='accountname']").html(instrument.name);htm.appendTo("#existing-direct-debit");htm.show();};payselectpage.actionDisplayAddress=function actionDisplayAddress(addressid,jqueryselector,extraaddressargs){var url="/gp/buy/shared/handlers/address-display.html";var extradata="addressId="+addressid;if(extraaddressargs){extradata+="&"+extraaddressargs.join("&");}var callback="payselectpage.htmlDisplayAddress";var callbackargs=[];callbackargs.push("'"+jqueryselector+"'");getHtmlData(url,callback,null,null,extradata,callbackargs);};payselectpage.htmlDisplayAddress=function htmlDisplayAddress(htmldata,jqueryselector){eval(jqueryselector+".html(htmldata)");};payselectpage.htmlInvoiceAccount=function htmlInvoiceAccount(instrument){var htm=payselectdiv.find("[existinginvoiceaccount='template']").clone(true);htm.attr("paymentmethodid",instrument.paymentmethodid);htm.attr("paymentmethodtype",instrument.paymentmethodtype);if(instrument.isnewinvoiceaccount){htm.attr("isnewinvoiceaccount",1);}htm.attr("existinginvoiceaccount","copy");if(!instrument.hideaddress){payselectpage.actionDisplayAddress(instrument.shippingaddressid,'payselectdiv.find("[existinginvoiceaccount=copy]").find("[datafield=invoiceaddress]")',["isInvoiceAddress=1"]);}htm.appendTo("#existing-invoice-account");htm.show();};payselectpage.htmlChinaMerchantsBankInstallment=function htmlChinaMerchantsBankInstallment(i,instrument){i+=500;var htm=$("#china-merchants-bank-installments tr[existinginstallment='template']").clone(true);htm.attr("paymentmethodid",instrument.id);htm.attr("existinginstallment","copy");htm.find(":radio[name=pm]").attr({id:"pm_"+i});var htmdatafields=htm.find("[datafield]");htmdatafields.filter("[datafield=installmentname]").attr("for","pm_"+i);htmdatafields.filter("[datafield=installmentnametext]").html(decodeJSonResponse(instrument.name));htmdatafields.filter("[datafield=installmentdescription]").html(decodeJSonResponse(instrument.description));htm.appendTo("#china-merchants-bank-installments");htm.show();};payselectpage.refreshDashboard=function refreshDashboard(){payselectpage.uiDashboardSpinner(true);uiScrollToTop();var url="/gp/buy/pipeline/handlers/json-pipedata.html";var extradata="page=payselect&object=creditcards&object=lineofcreditaccounts&object=purchaseordernumber&object=checkingaccounts&object=payselectordersummary&object=availablebalance&object=recommendedpaymentmethod&object=purchasepaymentattributes&object=cobrandads&object=newpaymentmethods&object=pagestate&object=onetimepaymentmethods&object=directdebits&object=invoiceaccount&object=domesticcards&object=thirdpartyaccounts&object=chinamerchantsbankinstallments&object=wirebybank&object=instrumenttitles&payContinueStyle="+payselectpage.CONTINUE+"&returnrid="+PIPEDATA_RETURN_RID;var callback="payselectpage.jsonDashboard";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";PIPEDATA_RETURN_RID="";getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.refreshOrderSummary=function refreshOrderSummary(){payselectpage.uiOrderSummarySpinner(true);uiScrollToTop();var url="/gp/buy/pipeline/handlers/json-pipedata.html";var extradata="page=payselect&object=payselectordersummary&payContinueStyle="+payselectpage.CONTINUE;var callback="payselectpage.jsonDashboard";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.refreshExistingInstruments=function refreshExistingInstruments(){payselectpage.uiExistingInstrumentsSpinner(true);uiScrollToTop();var url="/gp/buy/pipeline/handlers/json-pipedata.html";var extradata="page=payselect&object=creditcards&object=lineofcreditaccounts&object=purchaseordernumber&object=checkingaccounts&object=availablebalance&object=recommendedpaymentmethod&object=pagestate&object=directdebits&object=invoiceaccount&object=instrumenttitles&payContinueStyle="+payselectpage.CONTINUE;var callback="payselectpage.jsonDashboard";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.actionSelectExistingPayment=function actionSelectExistingPayment(event){if(payselectpage.WAITING_FOR_VALIDATION){return ;}var tgt=$(event.target);var clickedRow=tgt.parents("tr");if(clickedRow.attr("isdeleted")=="true"){return ;}if(clickedRow.hasClass("epdropdownlist")){return ;}payselectpage.uiSelectDashboardRow(clickedRow);};payselectpage.hideAddressChallengeExpando=function hideAddressChallengeExpando(row){if(row.attr("paymentmethodtype")=="creditCard"){payselectpage.hideCreditCardExpando(row);}else{}};payselectpage.showAddressChallengeExpando=function showAddressChallengeExpando(row){if(row.attr("paymentmethodtype")=="creditCard"){payselectpage.showCreditCardExpando(row);}else{}};payselectpage.createExpandoValidators=function createExpandoValidators(row){if(row.attr("paymentmethodtype")=="creditCard"){payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY=new ErrorAuthority($("tr[creditcardexpando=copy]"));payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:row.find("[datafield=cardnumber]"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateCreditCardMatchesLuhn,errorIdentifier:"addCreditCard_NotMatch"}),new ValidateFunctionWrapper({validateFunction:validateCreditCardMatchesTail,errorIdentifier:"addCreditCard_NotMatch"})]}));payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:row.find("[datafield='securitycode']"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateCreditCardCVV2,errorIdentifier:"addCreditCard_BadSecurityCode"})]}));}else{}};payselectpage.hideCreditCardExpando=function hideCreditCardExpando(row){$("tr[creditcardexpando='copy']").remove();row.find("input[datafield='cardnumber']").hide();row.find("#validatesecuritycode").hide();row.find("input.validate-instrument-button").hide();row.find("img.loading-small:visible").hide();row.find("[datafield=cardname]").show();payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY.clearAllHighlighting();};payselectpage.showExpandoAlertArrow=function showExpandoAlertArrow(clickedrow){var expandorow=$("tr[creditcardexpando='copy']");if(expandorow.length>0){var textbox=clickedrow.find("input[datafield='cardnumber']");var expando=expandorow.find(".expandobox");var arrow=expandorow.find(".donsbeak");var x=textbox.position().left+textbox.width()/6;var y=expando.position().top-arrow.height()+2;arrow.css({position:"absolute",left:x,top:y}).show();}};payselectpage.showCreditCardExpando=function showCreditCardExpando(row){var defaulttext=row.find("input[datafield='cardnumber']").attr("prefixtext")+row.find("[datafield='cardname'] span").text();row.find("[datafield='cardname']").hide();row.find("input[datafield='cardnumber']").focus(function(){if($(this).attr("readyforfocus")=="true"){$(this).css("color","#000000").attr("readyforfocus","false").val("");}}).css("color","#656565").attr({value:defaulttext,readyforfocus:"true"}).show();row.find("input.validate-instrument-button").show();if(row.attr("needsecuritycode")=="true"){row.find("#validatesecuritycode").show();}var expandorow=$("tr[creditcardexpando='template']").clone(true);expandorow.attr("creditcardexpando","copy");expandorow.attr("id","ac_"+row.find("input[name='pm']").attr("id"));expandorow.insertAfter(row);expandorow.show();payselectpage.showExpandoAlertArrow(row);};payselectpage.actionConfirmCreditCard=function actionConfirmCreditCard(event){var tgt=$(event.target);var clickedrow=tgt.parents("tr");clickedrow.find("input.validate-instrument-button").hide();clickedrow.find("img.loading-small").show();payselectpage.WAITING_FOR_VALIDATION=true;payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY.runAllValidators(true);if(!payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY.hasErrors()){if(clickedrow.attr("cardexpired")=="true"){var expiramonth=clickedrow.find("#new-cc-month").val();var expirayear=clickedrow.find("#new-cc-year").val();}else{var regex=new RegExp("[0-9]{2}"+String.fromCharCode(92)+"/[0-9]{4}");var expiradate=regex.exec(clickedrow.find("[datafield='expirationdate']").text());if(expiradate){var splitresult=expiradate[0].split("/");var expiramonth=splitresult[0];var expirayear=splitresult[1];}}var issuenumber="";var startmonth="";var startyear="";if(!payselectpage.treatment_10435){if(clickedrow.find("[datafield=issuenumber]").is(":visible")){var issuenumber=encodeURIComponent(clickedrow.find("[datafield='issuenumber']").val());}if(clickedrow.find("#startdatemonth").is(":visible")){var startmonth=encodeURIComponent(clickedrow.find("#startdatemonth").val());}if(clickedrow.find("#startdateyear").is(":visible")){var startyear=encodeURIComponent(clickedrow.find("#startdateyear").val());}}var securitycode=clickedrow.find("[datafield='securitycode']").is(":visible")?encodeURIComponent(clickedrow.find("[datafield='securitycode']").val()):"";if(clickedrow.attr("requirescvv")){securitycode=encodeURIComponent(clickedrow.find("#existingcccvvnum").val());}var url="/gp/buy/payselect/handlers/add-credit-card.html/"+getRefTag($(event.target));var extradata="";if(payselectpage.treatment_10435){extradata="addCreditCardNumber="+encodeURIComponent(clickedrow.find("[datafield='cardnumber']").val())+"&name="+encodeURIComponent(clickedrow.find("[datafield='cardholdername']").text())+"&month="+(expiramonth?encodeURIComponent(expiramonth):"12")+"&year="+(expirayear?encodeURIComponent(expirayear):"2012")+"&issuer="+encodeURIComponent(clickedrow.attr("issuer"))+"&brand="+encodeURIComponent(clickedrow.attr("brand"))+"&addCreditCardVerificationNumber="+securitycode+"&currentPaymentInstrumentID="+encodeURIComponent(clickedrow.attr("paymentmethodid"));}else{extradata="addCreditCardNumber="+encodeURIComponent(clickedrow.find("[datafield='cardnumber']").val())+"&name="+encodeURIComponent(clickedrow.find("[datafield='cardholdername']").text())+"&month="+(expiramonth?encodeURIComponent(expiramonth):"12")+"&year="+(expirayear?encodeURIComponent(expirayear):"2012")+"&issuer="+encodeURIComponent(clickedrow.attr("issuer"))+"&brand="+encodeURIComponent(clickedrow.attr("brand"))+"&issueNumber="+issuenumber+"&startMonth="+startmonth+"&startYear="+startyear+"&addCreditCardVerificationNumber="+securitycode+"&currentPaymentInstrumentID="+encodeURIComponent(clickedrow.attr("paymentmethodid"));}var callback="payselectpage.jsonConfirmCreditCard";var errorhandler="payselectpage.jsonConfirmCreditCardError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,clickedrow.find("input[name='pm']").attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);}else{clickedrow.find("img.loading-small").hide();clickedrow.find("input.validate-instrument-button").show();clickedrow.find("[datafield='cardnumber']").focus();payselectpage.WAITING_FOR_VALIDATION=false;}payselectpage.showExpandoAlertArrow(clickedrow);};payselectpage.jsonConfirmCreditCard=function jsonConfirmCreditCard(data){var currentrow=$("#existing-instruments tr.current");if(data.newpaymentmethodid==currentrow.attr("paymentmethodid")){payselectpage.hideCreditCardExpando(currentrow);currentrow.find("div[rewardshiddenforaddresschallenge='true']").show();if(payselectpage.isCurrencyAttributeUiEnabled()){var cardCurrencyDiv=$("div.cardCurrency",currentrow);if(cardCurrencyDiv&&cardCurrencyDiv.size()>0){cardCurrencyDiv.attr("currencyHiddenForAddressChallenge","false");payselectpage.displaySuitableCardCurrencyUi(currentrow);}}if(payselectpage.CAN_INPUT_PCARD_REFERENCE_NUMBER&&(currentrow.attr("ispurchasingcard")=="true")){$("#purchasing-card-number").show();}else{$("#purchasing-card-number").hide();}currentrow.find("input[name='pm']").attr("checked","checked");currentrow.attr("isaddresschallenge","false");}else{currentrow.find("img.loading-small").hide();currentrow.find("input.validate-instrument-button").show();currentrow.find("[datafield='cardnumber']").focus();}payselectpage.showExpandoAlertArrow(currentrow);payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(false);payselectpage.WAITING_FOR_VALIDATION=false;eventPageLoaded();if(!payselectpage.CONTINUE_ERROR_AUTHORITY.hasErrors()&&!$("#existing-instruments tr.current").attr("requirescvv")){payselectpage.asyncActionContinue(PIPELINE.pipedata.pagestate[PIPELINE.nextpage.page].useajaxcontinue);}};payselectpage.jsonConfirmCreditCardError=function jsonConfirmCreditCardError(errors){var currentrow=$("#existing-instruments tr.current");currentrow.find("img.loading-small").hide();currentrow.find("input.validate-instrument-button").show();currentrow.find("input[name='pm']").attr("checked","checked");currentrow.find("[datafield='cardnumber']").focus();payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY.addErrors(errors);payselectpage.WAITING_FOR_VALIDATION=false;payselectpage.showExpandoAlertArrow(currentrow);eventPageLoaded();};payselectpage.actionUpdatePointsDisplay=function actionUpdatePointsDisplay(event){var rewardsEntry=$(this).val();if(validateRewardsInput($(this))){var points=payselectpage.convertDollarsToPoints($(this).parents("[paymentmethodid]").attr("paymentmethodid"),rewardsEntry);$(this).parents(".rewardscustom").find("[datafield='custompointsamount']").html(points);}payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(false);};payselectpage.actionSelectRewardsCustom=function actionSelectRewardsCustom(event){$(this).filter(".prefilled").removeClass("prefilled").val("");};payselectpage.uiSelectRewards=function uiSelectRewards(id,isMaxSelected,amount){var htmrewards=$("#existing-instruments [paymentmethodid='"+id+"']");if(isMaxSelected){payselectpage.uiSelectDashboardRow(htmrewards.find("tr[datafield='rewardsselectmax']"));}else{if(amount){payselectpage.uiSelectDashboardRow(htmrewards.find("tr[datafield='rewardsselectcustom']"));var htmcustominput=htmrewards.find("input[name='rewardscustom']");htmcustominput.removeClass("prefilled");htmcustominput.val(amount);if(validateRewardsInput(htmcustominput)){htmrewards.find("[datafield='custompointsamount']").html(payselectpage.convertDollarsToPoints(htmrewards.attr("paymentmethodid"),htmcustominput.val()));}}}};payselectpage.uiSelectDefaultPaymentMethod=function uiSelectDefaultPaymentMethod(defaultPaymentMethodId){var clickedRow=$("#existing-instruments [paymentmethodid='"+defaultPaymentMethodId+"']");if(!clickedRow){var thirdPartyAccountSelected=$("#third-party-select option[value='"+defaultPaymentMethodId+"']");var domesticCardSelected=$("#domestic-card-select option[value='"+defaultPaymentMethodId+"']");var verifiedDebitCardSelected=$("verified_debitCard_banking_select option[value='"+defaultPaymentMethodId+"']");var netBankingSelected=$("netBanking_select  option[value='"+defaultPaymentMethodId+"']");if(thirdPartyAccountSelected.size()){thirdPartyAccountSelected.attr("selected","true");clickedRow=$("#existing-instruments #third-party-account");clickedRow.attr("paymentmethodid",$("#third-party-select").attr("value"));}else{if(domesticCardSelected.size()){domesticCardSelected.attr("selected","true");clickedRow=$("#existing-instruments #domestic-card");clickedRow.attr("paymentmethodid",$("#domestic-card-select").attr("value"));}else{if(verifiedDebitCardSelected.size()){verifiedDebitCardSelected.attr("selected","true");clickedRow=$("#existing-instruments #verified_debitCard");clickedRow.attr("paymentmethodid",$("#verified_debitCard_banking_select").attr("value"));}else{if(netBankingSelected.size()){netBankingSelected.attr("selected","true");clickedRow=$("#existing-instruments #nb_netbanking");clickedRow.attr("paymentmethodid",$("#netBanking_select").attr("value"));}}}}}payselectpage.uiSelectDashboardRow(clickedRow);};payselectpage.jsonRegisterRewardsError=function jsonRegisterRewardsError(error){var htm=payselectpage.REWARDS_REGISTRATION.popover;htm.children("div").hide();var errorhtm=htm.children("#rewards-registration-error");if(error===null){errorhtm.find("[error='rewards_SystemUnavailable']").show();}else{errorhtm.find("[error='"+error+"']").show();}errorhtm.show();payselectpage.REWARDS_REGISTRATION.step="error";logEvents.enqueue(new LogEntry(logEvents.SERVER_SIDE_VALIDATION,"registerRewardsError-"+error));};payselectpage.jsonAutoRegisterRewardsError=function jsonAutoRegisterRewardsError(error){var htm=payselectpage.REWARDS_REGISTRATION.autohtm;htm.find(".autorewardsloading").hide();htm.find(".autorewardserror").show();logEvents.enqueue(new LogEntry(logEvents.SERVER_SIDE_VALIDATION,"autoregisterrewardserror-"+error));};payselectpage.jsonAutoRegisterRewardsSignup=function jsonAutoRegisterRewardsSignup(data){var htm=payselectpage.REWARDS_REGISTRATION.autohtm;htm.find(".autorewardsloading").hide();payselectpage.REWARDS_REGISTRATION.autohtm="";payselectpage.refreshDashboard();};payselectpage.jsonRegisterRewardsSignup=function jsonRegisterRewardsSignup(data){var htm=payselectpage.REWARDS_REGISTRATION.popover;var successhtm=htm.find("#rewards-registration-success");successhtm.find(".customername").text(data.customername);if(data.dollarbalancedisplay&&data.pointsbalance){successhtm.find("[datafield='rewardsamount']").html(data.dollarbalancedisplay);successhtm.find("[datafield='pointsamount']").html(getNumberWithSeparators(data.pointsbalance,data.rewardsdecimalplaces));if(data.usenewbalancedisplay){var balancehtm=successhtm.find("[datafield=rewards_register_success_balance]");var balancemessage=payselectpage.setupPointsBalanceMessage(balancehtm.html(),successhtm.find("[datafield='pointsamount']"),successhtm.find("[datafield='rewardsamount']"),null);balancehtm.html(balancemessage);balancehtm.show();successhtm.find(".rewardsuccessbalance_c").hide();}successhtm.find(".rewardsuccessbalance").show();}if(data.showwarnmessage){successhtm.find(".warnmessage").show();}htm.find("#rewards-registration-intermission").hide();successhtm.show();payselectpage.NEW_PAYMENT_METHOD_ID=htm.attr("parentpaymentmethodid");payselectpage.REWARDS_REGISTRATION.step="success";};payselectpage.actionRegisterRewardsSignup=function actionRegisterRewardsSignup(event){var htm=payselectpage.REWARDS_REGISTRATION.popover.children("#rewards-registration-main");htm.hide();htm.siblings("#rewards-registration-intermission").find(".loading-large").show();htm.siblings("#rewards-registration-intermission").show();var extradata="programid="+encodeURIComponent(htm.parent().attr("programid"));extradata+="&paymentinstrumentid="+encodeURIComponent(htm.parent().attr("parentpaymentmethodid"));var datafields=htm.find(":input[datafield]");datafields.each(function(){var datafield=$(this).attr("datafield");if(datafield=="CVV2"){extradata+="&registerRewardsCreditCardVerificationNumber="+encodeURIComponent($(this).val());}else{if($(this).attr("entryindex")){if($(this).attr("entryindex")==1){var sortedentries=datafields.filter("[datafield="+datafield+"]").sort(function(a,b){return Number($(a).attr("entryindex"))-Number($(b).attr("entryindex"));});extradata+="&"+datafield+"=";sortedentries.each(function(){extradata+=$(this).val();});}}else{if(datafield=="TERMS_AND_CONDITIONS"){if($(this).is(":checked")){extradata+="&"+datafield+"=true";}}else{extradata+="&"+datafield+"="+encodeURIComponent($(this).val());}}}});var url="/gp/buy/payselect/handlers/register-rewards-account.html";var callback="payselectpage.jsonRegisterRewardsSignup";var errorhandler="payselectpage.jsonRegisterRewardsError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_intermission",[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);payselectpage.REWARDS_REGISTRATION.step="intermission";};payselectpage.actionAutoRegisterRewardsSignup=function actionAutoRegisterRewardsSignup(event){if(!payselectpage.REWARDS_REGISTRATION){payselectpage.REWARDS_REGISTRATION={};}var autohtm=$(this).parents(".autoreg");payselectpage.REWARDS_REGISTRATION.autohtm=autohtm;autohtm.find(".autorewardsmessage").hide();autohtm.find(".autorewardserror").hide();autohtm.find(".autorewardsloading").show();var cchtm=$(this).parents("[paymentmethodid]");var programid=$(this).parents("[programid]").attr("programid");var extradata="programid="+encodeURIComponent(programid);extradata+="&paymentinstrumentid="+encodeURIComponent(cchtm.attr("paymentmethodid"));var url="/gp/buy/payselect/handlers/register-rewards-account.html";var callback="payselectpage.jsonAutoRegisterRewardsSignup";var errorhandler="payselectpage.jsonAutoRegisterRewardsError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,"autorewardssignup",[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.jsonRegisterRewardsConfigure=function jsonRegisterRewardsConfigure(data){var htm=payselectpage.REWARDS_REGISTRATION.popover.children("#rewards-registration-main");htm.siblings("#rewards-registration-loading").hide();var programid=htm.parents("[programid]").attr("programid");for(var i in data.fields){var element=data.fields[i];var datafield=htm.find("[datafield='"+element.type+"']");if(element.value){datafield.filter("input").attr("value",element.value);}datafield.parents(".rewardsfield").show();}if(data.termshtml){htm.find(".rewardstermstext").html(decodeJSonResponse(data.termshtml));}if(data.billingzip){htm.find("[datafield=BILLING_POSTAL_CODE]").attr("value",data.billingzip);}if(data.displaydata){var datafieldhtm=payselectpage.REWARDS_REGISTRATION.popover.find("[datafield]");for(var stringKey in data.displaydata){datafieldhtm.filter("[datafield="+stringKey+"]").html(data.displaydata[stringKey]);}}if(data.marketinglink){htm.find("[datafield='rewards_marketing_link']").html(data.marketinglink);}htm.show();payselectpage.REWARDS_REGISTRATION.step="main";logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_main",[]));};payselectpage.actionRegisterRewardsClose=function actionRegisterRewardsClose(trigger,popover){if(payselectpage.REWARDS_REGISTRATION.step=="success"){payselectpage.refreshDashboard();}payselectpage.REWARDS_REGISTRATION=null;logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_close",[]));};payselectpage.actionRegisterRewardsConfigure=function actionRegisterRewardsConfigure(event){payselectpage.REWARDS_REGISTRATION={};payselectpage.REWARDS_REGISTRATION.step="loading";event.preventDefault();var cchtm=$(this).parents("[paymentmethodid]");var issuerid=$(this).parents("[issuerid]").attr("issuerid");var programid=$(this).parents("[programid]").attr("programid");amznJQ.onReady("popover",function(){amznJQ.jQuery.AmazonPopover.displayPopover({title:$("#rewards-registration-title").text(),localContent:"#payselectpagecontent #rewards-registration-lightbox",width:500,zIndex:1000,showOnHover:false,modal:true,clone:true,draggable:false,showCloseButton:true,location:"centered",closeText:$("#rewards-popover-close").text(),closeEventExclude:"CLICK_OUTSIDE",group:"RewardsRegistration",onHide:payselectpage.actionRegisterRewardsClose});});var htm=$("#ap_container #rewards-registration-lightbox");htm.attr("issuerid",issuerid);htm.attr("programid",programid);htm.attr("parentpaymentmethodid",cchtm.attr("paymentmethodid"));htm.find("[programid='"+programid+"']").show();htm.find("[name='rewardsname']").val(cchtm.find("[datafield='cardholdername']").text());var expirationDateRegex=new RegExp("[0-9]{2}"+String.fromCharCode(92)+"/[0-9]{4}");var expirationDate=expirationDateRegex.exec(cchtm.find("[datafield='expirationdate']").text());if(expirationDate){var expirationSplit=expirationDate[0].split("/");var expirationMonth=expirationSplit[0];var expirationYear=expirationSplit[1];htm.find("[name='rewardsexpdate']").attr("value",expirationYear+"-"+expirationMonth);}htm.find("#rewards-registration-main [name='rewardssignup']").bind("click",payselectpage.actionRegisterRewardsSignup);amznJQ.available("popover",function(){amznJQ.jQuery(htm.find(".cvv2help")).amazonPopoverTrigger({localContent:htm.find(".cvv2helpcontent"),zIndex:1000,showOnHover:true,width:250,height:150,modal:false,clone:false,draggable:false,showCloseButton:false,location:"auto"});});htm.find("#rewards-registration-loading .loading-large").show();htm.find("#rewards-registration-loading").show();var url="/gp/buy/payselect/handlers/get-rewards-configuration.html";var extradata="programid="+programid+"&partner="+issuerid+"&ccpaymentinstrumentid="+cchtm.attr("paymentmethodid")+"&issuer="+cchtm.attr("issuer")+"&brand="+cchtm.attr("brand");var callback="payselectpage.jsonRegisterRewardsConfigure";var errorhandler="payselectpage.jsonRegisterRewardsError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);payselectpage.REWARDS_REGISTRATION.popover=htm;logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_learnmore",[]));};payselectpage.actionAddGiftPromotion=function actionAddGiftPromotion(event){payselectpage.GIFTCARD_PROMO_ERROR_AUTHORITY.runAllValidators(true);if(!payselectpage.GIFTCARD_PROMO_ERROR_AUTHORITY.hasErrors()){var claimcode=encodeURIComponent($("#gcpromoinput").val());payselectdiv.find("#gcpromoerrorblock").hide();payselectdiv.find("[gcpromoerror='copy']").remove();var url="/gp/buy/payselect/handlers/add-giftcard-promotion.html/"+getRefTag($(event.target));var currentlyUsesPromoBalance=payselectpage.CURRENTLY_USES_PROMO_BALANCE;var extradata="claimcode="+claimcode+"&currentlyUsesPromoBalance="+currentlyUsesPromoBalance;var callback="payselectpage.jsonAddGiftPromotion";var errorhandler="payselectpage.jsonAddGiftPromotionError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,payselectpage.GIFTCARD_PROMO_ERROR_AUTHORITY.section.attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);if(payselectpage.treatment_9393){$("#gc_entry input.apply").parent().parent().hide();}else{$("#gc_entry input.apply").hide();}$("#gc_entry img.loading-small").show();}};payselectpage.actionAddDirectDebit=function actionAddDirectDebit(event){payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY.runAllValidators(true);if(!payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY.hasErrors()){var debitBankRoutingNumber=encodeURIComponent($("#debit-bank-routing-number").val());var debitAccountNumber=encodeURIComponent($("#debit-account-number").val());var debitAccountName=encodeURIComponent($("#debit-account-name").val());var countryCode=encodeURIComponent($("#country-code").val());var url="/gp/buy/payselect/handlers/add-direct-debit.html/"+getRefTag($(event.target));var extradata="addBankAccountNumber="+debitAccountNumber+"&addBankAccountRoutingNumber="+debitBankRoutingNumber+"&debitAccountName="+debitAccountName+"&countryCode="+countryCode;var callback="payselectpage.jsonAddDirectDebit";var errorhandler="payselectpage.jsonAddDirectDebitError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY.section.attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);if(payselectpage.treatment_9393){$("#direct-debit input.add-instrument-button").parent().parent().hide();}else{$("#direct-debit input.add-instrument-button").hide();}$("#direct-debit img.loading-small").show();}};payselectpage.actionAddInvoiceAccount=function actionAddInvoiceAccount(event){payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.runAllValidators(true);if(!payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.hasErrors()){var invoicingFirstName=encodeURIComponent($("#invoice-first-name").val());var invoicingLastName=encodeURIComponent($("#invoice-last-name").val());var invoicingDayOfBirth=encodeURIComponent($("#invoice-day-of-birth").val());var invoicingMonthOfBirth=encodeURIComponent($("#invoice-month-of-birth").val());var invoicingYearOfBirth=encodeURIComponent($("#invoice-year-of-birth").val());var url="/gp/buy/payselect/handlers/add-invoice-account.html/"+getRefTag($(event.target));var extradata="invoicingFirstName="+invoicingFirstName+"&invoicingLastName="+invoicingLastName+"&invoicingDayOfBirth="+invoicingDayOfBirth+"&invoicingMonthOfBirth="+invoicingMonthOfBirth+"&invoicingYearOfBirth="+invoicingYearOfBirth;var callback="payselectpage.jsonAddInvoiceAccount";var errorhandler="payselectpage.jsonAddInvoiceAccountError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.section.attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);if(payselectpage.treatment_9393){$("#new-invoice input.add-instrument-button").parent().parent().hide();}else{$("#new-invoice input.add-instrument-button").hide();}$("#new-invoice img.loading-small").show();}};payselectpage.actionAddCreditCard=function actionAddCreditCard(event){if(payselectpage.treatment_9393){$(this).parent().parent().hide();}else{$(this).hide();}$(this).parents("table").find("img.loading-small").show();if(payselectpage.WAITING_FOR_TYPE){setTimeout(function(){payselectpage.actionAddCreditCard(event);},50);return ;}var authority;var creatediv=$(event.target).parents("div.create").attr("id");var table;if(!creatediv){authority=payselectpage.CREDIT_CARD_ERROR_AUTHORITY;table=$("#new-cc");}else{if(creatediv=="addnewvcc"){authority=payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY;payselectpage.setActionSource("vcc");table=$("#new-vcc");}else{if(creatediv=="addnewvdc"){authority=payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY;payselectpage.setActionSource("vdc");table=$("#new-vdc");}}}authority.runAllValidators(true);if(!authority.hasErrors()){var newCreditCardNumber="";var name="";var issuer="";var brand="";var month="";var year="";var issueNumber="";var startMonth="";var startYear="";var securityCode="";if(!creatediv){newCreditCardNumber=encodeURIComponent($("#newCreditCardNumber").val());name=encodeURIComponent($("#ccname").val());issuer=encodeURIComponent($("#cctype").val().charAt(0));brand=encodeURIComponent($("#cctype").val().substr(1));month=issuer!="G"?encodeURIComponent($("#ccmonth").val()):"12";year=issuer!="G"?encodeURIComponent($("#ccyear").val()):"2012";if(!payselectpage.treatment_10435){issueNumber=encodeURIComponent($("#issuenumber").val());startMonth=encodeURIComponent($("#startmonth").attr("value"));startYear=encodeURIComponent($("#startyear").attr("value"));}securityCode=encodeURIComponent($("#securitycode").val());}else{if(creatediv=="addnewvcc"){newCreditCardNumber=encodeURIComponent($("#newVerifiedCreditCardNumber").val());name=encodeURIComponent($("#vccname").val());issuer=encodeURIComponent($("#vcctype").val().charAt(0));brand=encodeURIComponent($("#vcctype").val().substr(1));month=encodeURIComponent($("#vccmonth").val());year=encodeURIComponent($("#vccyear").val());securityCode=encodeURIComponent($("#vcccvvnum").val());}else{if(creatediv=="addnewvdc"){newCreditCardNumber=encodeURIComponent($("#newVerifiedDebitCardNumber").val());name=encodeURIComponent($("#vdcname").val());issuer=encodeURIComponent($("#vdctype").val().charAt(0));brand=encodeURIComponent($("#vdctype").val().substr(1));month=encodeURIComponent($("#vdcmonth").val());year=encodeURIComponent($("#vdcyear").val());securityCode=encodeURIComponent($("#vdccvvnum").val());}}}var url="/gp/buy/payselect/handlers/add-credit-card.html/"+getRefTag($(event.target));var extradata="";if(payselectpage.treatment_10435){extradata="addCreditCardNumber="+newCreditCardNumber+"&name="+name+"&month="+month+"&year="+year+"&issuer="+issuer+"&brand="+brand+"&addCreditCardVerificationNumber="+securityCode+"&payContinueStyle="+payselectpage.CONTINUE;}else{extradata="addCreditCardNumber="+newCreditCardNumber+"&name="+name+"&month="+month+"&year="+year+"&issuer="+issuer+"&brand="+brand+"&issueNumber="+issueNumber+"&startMonth="+startMonth+"&startYear="+startYear+"&addCreditCardVerificationNumber="+securityCode+"&payContinueStyle="+payselectpage.CONTINUE;}var callback="payselectpage.jsonAddCreditCard";var errorhandler="payselectpage.jsonAddCreditCardError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,authority.section.attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);}else{if(payselectpage.treatment_9393){table.find("input.add-instrument-button").parent().parent().show();}else{table.find("input.add-instrument-button").show();}table.find("img.loading-small").hide();}};payselectpage.actionAddLineOfCredit=function actionAddLineOfCredit(event){var locContainer=$("#new-loc");if(payselectpage.treatment_9393){locContainer.find("input.add-instrument-button").parent().parent().hide();}else{locContainer.find("input.add-instrument-button").hide();}locContainer.find("img.loading-small").show();if(payselectpage.WAITING_FOR_TYPE){setTimeout(function(){actionAddLineOfCredit(event);},50);return ;}payselectpage.LINE_OF_CREDIT_ERROR_AUTHORITY.runAllValidators(true);if(!payselectpage.LINE_OF_CREDIT_ERROR_AUTHORITY.hasErrors()){var newCreditCardNumber=encodeURIComponent(locContainer.find("#newLineOfCreditNumber ").val());var name=encodeURIComponent(locContainer.find("#locname").val());var url="/gp/buy/payselect/handlers/add-credit-card.html/"+getRefTag($(event.target));var extradata="";if(payselectpage.treatment_10435){extradata="addCreditCardNumber="+newCreditCardNumber+"&name="+name+"&month="+"&year="+"&issuer="+"&brand="+"&addCreditCardVerificationNumber=";}else{extradata="addCreditCardNumber="+newCreditCardNumber+"&name="+name+"&month="+"&year="+"&issuer="+"&brand="+"&issueNumber="+"&startMonth="+"&startYear="+"&addCreditCardVerificationNumber=";}var callback="payselectpage.jsonAddLineOfCredit";var errorhandler="payselectpage.jsonAddLineOfCreditError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,payselectpage.LINE_OF_CREDIT_ERROR_AUTHORITY.section.attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);}else{if(payselectpage.treatment_9393){locContainer.find("input.add-instrument-button").parent().parent().show();}else{locContainer.find("input.add-instrument-button").show();}locContainer.find("img.loading-small").hide();}};payselectpage.actionUseAvailableBalance=function actionUseAvailableBalance(){var useAvailableBalance=encodeURIComponent($("#existing-balance [existingbalance='copy']").find("input").is(":checked"));var url="/gp/buy/payselect/handlers/use-available-balance.html";var extradata="useAvailableBalance="+useAvailableBalance;var callback="payselectpage.jsonUseAvailableBalance";var errorhandler="payselectpage.jsonUseAvailableBalanceError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.actionAddBankAccount=function actionAddBankAccount(event){payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.runAllValidators(true);if(!payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.hasErrors()){var routingNumber=encodeURIComponent($("#check-routing-number").val());var accountNumber=encodeURIComponent($("#check-account-number").val());var name=encodeURIComponent($("#check-name").val());var driveLicenseNumber=encodeURIComponent($("#check-dl").val());var driveLicenseState=encodeURIComponent($("#check-dl-state").val());payselectdiv.find("#bankaccounterrorblock").hide();payselectdiv.find("[bankaccounterror=copy]").remove();var url="/gp/buy/payselect/handlers/add-bank-account.html/"+getRefTag($(event.target));var extradata="addBankAccountRoutingNumber="+routingNumber+"&addBankAccountNumber="+accountNumber+"&newBankAccountHolderName="+name+"&addBankAccountDriversLicense="+driveLicenseNumber+"&newBankAccountSt="+driveLicenseState;var callback="payselectpage.jsonAddBankAccount";var errorhandler="payselectpage.jsonAddBankAccountError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.section.attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);if(payselectpage.treatment_9393){$("#bank-account input.add-instrument-button").parent().parent().hide();}else{$("#bank-account input.add-instrument-button").hide();}$("#bank-account img.loading-small").show();}};payselectpage.actionApplyCreditAccount=function actionApplyCreditAccount(){amz_js_PopWin("/gp/cobrandcard/marketing.html/ref=ox_pay_page_storecard_apply?ie=UTF8&place=slpp&inc=9018&pr=conplcc&plattr=NOPP0001&pop-up=1","AmazonHelp","width=925,height=600,resizable=1,scrollbars=1,toolbar=1,status=1");};payselectpage.actionCreditCardTypeChanged=function actionCreditCardTypeChanged(type,source){if(!payselectpage.treatment_10435){if(type=="S0"){$("#maestrofields").show();}else{$("#maestrofields").hide();}}if(type=="G21"){$("#"+source+"month, #"+source+"year").attr("disabled","disabled");}else{$("#"+source+"month, #"+source+"year").removeAttr("disabled");}};payselectpage.actionCCTypeDropdownChanged=function actionCCTypeDropdownChanged(event){payselectpage.actionCreditCardTypeChanged($(event.target).find("option:selected").val(),"cc");};payselectpage.actionThirdPartyAccountsDropdownChanged=function actionThirdPartyAccountsDropdownChanged(event){var clickedRow=$("#third-party-account");clickedRow.find("input[type='radio']").attr("checked","checked");clickedRow.attr("paymentmethodid",$("#third-party-select").attr("value"));payselectpage.uiSelectDashboardRow(clickedRow);};payselectpage.actionDomesticCardsDropdownChanged=function actionDomesticCardsDropdownChanged(event){var clickedRow=$("#domestic-card");clickedRow.find("input[type='radio']").attr("checked","checked");clickedRow.attr("paymentmethodid",$("#domestic-card-select").attr("value"));payselectpage.uiSelectDashboardRow(clickedRow);};payselectpage.actionVerifiedDebitCardBankDropdownChanged=function actionVerifiedDebitCardBankDropdownChanged(event){var clickedRow=$("#verified_debitCard");clickedRow.find("input[type='radio']").attr("checked","checked");if($("#verified_debitCard_banking_select").attr("value")=="OtherBanks"){clickedRow.attr("paymentmethodid","");$("#chooseDebitCardBank").hide();$("#new-vdc-otherbanks").show();}else{if($("#verified_debitCard_banking_select").attr("value")){clickedRow.attr("paymentmethodid",$("#verified_debitCard_banking_select").attr("value"));$("#new-vdc-otherbanks").hide();$("#selectdebitcardbankname").text($("#verified_debitCard_banking_select").find("option:selected").text());$("#chooseDebitCardBank").show();}else{clickedRow.attr("paymentmethodid",$("#verified_debitCard_banking_select").attr("value"));$("#new-vdc-otherbanks").hide();$("#chooseDebitCardBank").hide();}}payselectpage.uiSelectDashboardRow(clickedRow);};payselectpage.actionNetBankingDropdownChanged=function actionNetBankingDropdownChanged(event){if($("#netBanking_select").attr("value")){$("#selectnetbankingname").text($("#netBanking_select").find("option:selected").text());$("#choosenetbanking").show();}else{$("#choosenetbanking").hide();}var clickedRow=$("#nb_netbanking");clickedRow.find("input[type='radio']").attr("checked","checked");clickedRow.attr("paymentmethodid",$("#netBanking_select").attr("value"));payselectpage.uiSelectDashboardRow(clickedRow);};payselectpage.actionViewInfoWireByBank=function actionViewInfoWireByBank(event){$("#wire-by-bank-message").hide();$("#wire-by-bank-info").show();};payselectpage.actionViewAddNewCreditCard=function actionViewAddNewCreditCard(event){$("#acceptvcc").hide();$("#addnewvcc").show();};payselectpage.actionViewCODMessage=function actionViewCODMessage(event){$("#cod-message-2nd-line-enable").show();$("#cod-terms-conditions").show();};payselectpage.actionUseECard=function actionUseECard(event){$("#cc div.offer").hide();$("#cc div.create").show();$("#cc div.create").find(":input:first").focus();$("#ecard-help-link").show();$("#order-summary-title").show();$("#order-summary-title-blank").hide();$("#subtotals").show();};payselectpage.displayCreditCardIcon=function displayCreditCardIcon(type,issuerdisplayimage,imagediv){var icon;if(issuerdisplayimage){icon=$(imagediv+" img[issuer='ATM']");icon.attr("src",issuerdisplayimage);}else{icon=$(imagediv+" *[issuer='"+type+"']");}if(!icon.is(":visible")){icon.siblings("*:visible").fadeOut("fast",function(){icon.show().fadeIn("fast");});}};payselectpage.updateCreditCardType=function updateCreditCardType(type,issuerdisplayimage){if(!payselectpage.getActionSource()){payselectpage.WAITING_FOR_TYPE=false;$("#cctype").val(type);payselectpage.actionCreditCardTypeChanged(type,"cc");payselectpage.displayCreditCardIcon(type,issuerdisplayimage,"#newCreditCardImages");}else{if(payselectpage.getActionSource()=="vcc"){payselectpage.WAITING_FOR_TYPE=false;$("#vcctype").val(type);payselectpage.actionCreditCardTypeChanged(type,"vcc");payselectpage.displayCreditCardIcon(type,issuerdisplayimage,"#newVerifiedCreditCardImages");}else{if(payselectpage.getActionSource()=="vdc"){payselectpage.WAITING_FOR_TYPE=false;$("#vdctype").val(type);payselectpage.actionCreditCardTypeChanged(type,"vdc");payselectpage.displayCreditCardIcon(type,issuerdisplayimage,"#newVerifiedDebitCardImages");}}}};payselectpage.actionCreditCardNumberChanged=function actionCreditCardNumberChanged(){payselectpage.WAITING_FOR_TYPE=true;var creditCardNumber;var numberField=$(this).attr("id");if(numberField==="newCreditCardNumber"){creditCardNumber=encodeURIComponent($("#newCreditCardNumber").val());}else{if(numberField==="newVerifiedCreditCardNumber"){creditCardNumber=encodeURIComponent($("#newVerifiedCreditCardNumber").val());payselectpage.setActionSource("vcc");}else{if(numberField==="newVerifiedDebitCardNumber"){creditCardNumber=encodeURIComponent($("#newVerifiedDebitCardNumber").val());payselectpage.setActionSource("vdc");}}}var url="/gp/buy/payselect/handlers/get-credit-card-type.html";var extradata="addCreditCardNumber="+creditCardNumber;var callback="payselectpage.jsonGetCreditCardType";var errorhandler="payselectpage.jsonGetCreditCardTypeError";var systemerrorhandler="payselectpage.jsonGetCreditCardTypeSystemError";getData(url,callback,errorhandler,systemerrorhandler,extradata);};payselectpage.jsonPageState=function jsonPageState(pagestate,availablebalancecoverstotal){payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(true);var error={};if(pagestate.blankslate){$("#blankslate").show();error.continue_BlankSlate="continue_BlankSlate";payselectpage.CONTINUE_ERROR_AUTHORITY.addErrors(error);}if(pagestate.availablebalancedontcoverfullcost){$("#blankslate").show();error.continue_AvailableBalanceDontCoverFullCost="continue_AvailableBalanceDontCoverFullCost";payselectpage.CONTINUE_ERROR_AUTHORITY.addErrors(error);}if(!(pagestate.blankslate||pagestate.availablebalancedontcoverfullcost)){$("#blankslate").hide();}if(PIPELINE.pipedata&&PIPELINE.pipedata.weblabs&&PIPELINE.pipedata.weblabs.payselect&&PIPELINE.pipedata.weblabs.payselect.PAYPAGE_DISPLAY_CC_FORM_13616=="T1"){if(pagestate.showCreditCardForm){$("#cc div.offer").hide();$("#cc div.create").show();}}if(pagestate.addresschallenge){if(pagestate.addresschallengestatus){switch(pagestate.addresschallengestatus){case"entireWalletShown":break;case"partialWalletHidden":$("#address-challenge-partial-wallet-suppress").show();break;default:$("#amnesia-message").show();break;}}else{$("#amnesia-message").show();$("#add-credit-card").trigger("click");}error.continue_AddressChallenge="continue_AddressChallenge";payselectpage.CONTINUE_ERROR_AUTHORITY.addErrors(error);}else{$("#amnesia-message").hide();$("#address-challenge-wallet-suppress").hide();$("#address-challenge-partial-wallet-suppress").hide();}if(pagestate.showcodcashmessage){$("#cod-cash-message").show();}if(pagestate.shownewcreditcardhelplink){$("#new-credit-card-help-link").show();}if(pagestate.hideotherpaymentmethod){$("#other-payment-method").hide();}else{$("#other-payment-method").show();}payselectpage.CAN_INPUT_PCARD_REFERENCE_NUMBER=pagestate.caninputpcardreferencenumber;payselectpage.CURRENTLY_USES_PROMO_BALANCE=pagestate.currentlyusespromobalance;if(pagestate.useajaxcontinue){payselectdiv.find(".continue-enabled").unbind("click").bind("click",payselectpage.actionContinueWrapper);payselectpage.CONTINUE="ajax";}else{payselectdiv.find(".continue-enabled").unbind("click").bind("click",payselectpage.actionContinueFormSubmitWrapper);payselectpage.CONTINUE="post";}if(pagestate.ismaestrocardenabled){$("#add-cc-logo-with-maestro").show();}else{$("#add-cc-logo").show();}};payselectpage.PAYSELECT_DELETE_CC_5470=function PAYSELECT_DELETE_CC_5470(treatment){if(treatment=="T1"){$("#existing-credit-cards tr").find("#delete-expired-context").each(function(){$(this).show();});}};payselectpage.RCX_CHECKOUT_CART_REMOVE_DATE_ISSUER_FOR_UK_S0_10435=function RCX_CHECKOUT_CART_REMOVE_DATE_ISSUER_FOR_UK_S0_10435(treatment){if(treatment=="T1"){payselectpage.treatment_10435=true;}else{payselectpage.treatment_10435=false;}};payselectpage.RCX_CHECKOUT_MBCC_SUPPORT_10251=function RCX_CHECKOUT_MBCC_SUPPORT_10251(treatment){if(treatment=="T1"){$("#add-cc-logo-with-boc").show();$("#add-cc-logo").hide();$("#title-international-cc-with-boc").show();$("#title-international-cc").hide();}else{$("#add-cc-logo-with-boc").hide();$("#add-cc-logo").show();$("#title-international-cc").show();$("#title-international-cc-with-boc").hide();}};payselectpage.CHECKOUT_9393=function CHECKOUT_9393(treatment){if(treatment=="T1"){payselectpage.treatment_9393=true;}else{payselectpage.treatment_9393=false;}};payselectpage.RCX_CHECKOUT_SPC_BBQ_10015=function(treatment){if(window.useBbq&&treatment=="T1"){payselectpage.isbbq=true;}};payselectpage.PAYPAGE_DISPLAY_CC_FORM_13616=function PAYPAGE_DISPLAY_CC_FORM_13616(treatment){};payselectpage.RCX_CHECKOUT_TFX_CURRENCY_ATTRIBUTE_14224=function RCX_CHECKOUT_TFX_CURRENCY_ATTRIBUTE_14224(treatment){};payselectpage.CHECKOUT_10180=function CHECKOUT_10180(treatment){};payselectpage.setActionSource=function setActionSource(actionsource){payselectpage.NEW_CARD_ACTION_SOURCE=actionsource;};payselectpage.getActionSource=function getActionSource(){return payselectpage.NEW_CARD_ACTION_SOURCE;};payselectpage.jsonContinue=function jsonContinue(data){if(payselectpage.isbbq){bbqConductor(data.pipedata);}else{conductor(data.pipedata);}};payselectpage.jsonAsyncContinue=function jsonAsyncContinue(data){if(data.pipedata){payselectpage.ASYNC_CONTINUE_PIPEDATA=data.pipedata;payselectpage.CURRENTLY_USES_PROMO_BALANCE=data.currentlyusespromobalance;}if(data.spchtml){payselectpage.ASYNC_CONTINUE_SPCHTML=data.spchtml;payselectpage.CURRENTLY_USES_PROMO_BALANCE=data.currentlyusespromobalance;}payselectpage.WAITING_FOR_ASYNC_CONTINUE=false;payselectpage.ASYNC_CONTINUE_TIMEOUT=setTimeout("payselectpage.TIMEOUTRETRYCOUNT++;payselectpage.optimisticsetpayment()",45000);if(payselectpage.CONTINUE_CLICKED){if(data.pipedata){payselectpage.actionContinue(payselectpage.CONTINUE_EVENT);}else{if(data.spchtml){payselectpage.actionContinueFormSubmit(payselectpage.CONTINUE_EVENT);}}}};payselectpage.jsonAsyncErrorHandler=function jsonAsyncErrorHandler(data){payselectpage.WAITING_FOR_ASYNC_CONTINUE=false;if(payselectpage.CONTINUE_CLICKED){payselectpage.actionContinue(payselectpage.CONTINUE_EVENT);}};payselectpage.jsonExistingCreditCards=function jsonExistingCreditCards(creditcards,hiderewardsaccount){var creditCardsTable=$("#existing-credit-cards-table");creditCardsTable.find("tr[existingcreditcard='copy']").remove();creditCardsTable.find("tr[creditcardexpando='copy']").remove();payselectpage.REWARDS_ACCOUNTS={};if(creditcards.length===0){creditCardsTable.hide();}else{creditCardsTable.show();var htmlTemplate=$("#existing-credit-cards").children("[existingcreditcard='template']");$.each(creditcards,function(i,creditcard){payselectpage.htmlCreditCard(i,creditcard,htmlTemplate,hiderewardsaccount);});}};payselectpage.jsonExistingLocAccounts=function jsonExistingLocAccounts(locaccounts,currentpaymentmethodid,purchaseordernumber){var locAccountsTable=$("#existing-loc-accounts-table");locAccountsTable.find("tr[existinglocaccount='copy']").remove();if(locaccounts.length===0){locAccountsTable.hide();}else{locAccountsTable.show();var htmlTemplate=$("#existing-loc-accounts [existinglocaccount='template']");$.each(locaccounts,function(i,locaccount){var shouldSetPurchaseOrderNumber=(locaccount.paymentmethodid==currentpaymentmethodid);payselectpage.htmlLocAccount(i,locaccount,shouldSetPurchaseOrderNumber?purchaseordernumber:null,htmlTemplate);});}};payselectpage.jsonExistingCheckingAccounts=function jsonExistingCheckingAccounts(checkingaccounts){var checkingAccountTable=$("#existing-checking-accounts-table");checkingAccountTable.find("tr[existingcheckingaccount='copy']").remove();if(checkingaccounts.length===0){checkingAccountTable.hide();}else{checkingAccountTable.show();$.each(checkingaccounts,function(i,checkingaccount){payselectpage.htmlCheckingAccount(i,checkingaccount);});}};payselectpage.jsonExistingDirectDebits=function jsonExistingDirectDebits(directdebits){var directDebitTable=$("#existing-direct-debit-table");directDebitTable.find("tr[existingdirectdebit='copy']").remove();if(directdebits.length===0){directDebitTable.hide();}else{directDebitTable.show();$.each(directdebits,function(i,directdebit){payselectpage.htmlDirectDebit(i,directdebit);});}};payselectpage.jsonExistingInvoiceAccount=function jsonExistingInvoiceAccount(invoiceaccount){if((invoiceaccount.paymentmethodtype&&invoiceaccount.shippingaddressid)||payselectpage.UNFINISHED_INVOICE_ADDRESS_ID){$("#existing-invoice-account-table tr[existinginvoiceaccount='copy']").remove();$("#existing-invoice-account-table").show();$("#invoice").hide();if(!(invoiceaccount.paymentmethodtype&&invoiceaccount.shippingaddressid)){invoiceaccount.shippingaddressid=payselectpage.UNFINISHED_INVOICE_ADDRESS_ID;invoiceaccount.paymentmethodid=payselectpage.UNFINISHED_INVOICE_ADDRESS_ID;invoiceaccount.paymentmethodtype="invoiceAccount";invoiceaccount.isnewinvoiceaccount=1;invoiceaccount.hideaddress=1;}else{if(invoiceaccount.shippingaddressid==invoiceaccount.paymentmethodid){invoiceaccount.isnewinvoiceaccount=1;}}payselectpage.htmlInvoiceAccount(invoiceaccount);}};payselectpage.jsonThirdPartyAccounts=function jsonThirdPartyAccounts(thirdpartyaccounts){if(thirdpartyaccounts.length==0){$("#third-party-account-table").hide();}else{$("#third-party-account-table").show();var thirdPartySel=$("#third-party-select");thirdPartySel.find("option").hide();thirdPartySel.find("option[value='']").attr("display",1).show();$.each(thirdpartyaccounts,function(){thirdPartySel.find("option[value='"+this+"']").attr("display",1).show();});thirdPartySel.find("option").remove("[display!=1]");}};payselectpage.jsonDomesticCards=function jsonDomesticCards(domesticcards){if(domesticcards.length==0){$("#domestic-card-table").hide();}else{$("#domestic-card-table").show();var domCardSel=$("#domestic-card-select");domCardSel.find("option").hide();domCardSel.find("option[value='']").attr("display",1).show();$.each(domesticcards,function(){domCardSel.find("option[value='"+this+"']").attr("display",1).show();});domCardSel.find("option").remove("[display!=1]");}};payselectpage.jsonVerifiedDebitCards=function jsonVerifiedDebitCards(verifieddebitcard){$("#new-verified-debit-cards-table").show();if(verifieddebitcard.length>0){var verifiedDebitCardSel=$("#verified_debitCard_banking_select");verifiedDebitCardSel.find("option").hide();verifiedDebitCardSel.find("option[value='']").attr("display",1).show();verifiedDebitCardSel.find("option[value='OtherBanks']").attr("display",1).show();$.each(verifieddebitcard,function(){verifiedDebitCardSel.find("option[value='"+this+"']").attr("display",1).show();});verifiedDebitCardSel.find("option").remove("[display!=1]");}payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY.clearErrors();if($("#verified_debitCard_banking_select").attr("value")=="OtherBanks"){$("#verified_debitCard").attr("paymentmethodid","");payselectdiv.find("#vdc").find("input").val("");payselectdiv.find("#vdc").find("select").val("");$("#newVerifiedDebitCardImages *[issuer='']").siblings().hide();$("#newVerifiedDebitCardImages *[issuer='']").show();payselectdiv.find("#verified_debitCard_banking_select").val("");payselectdiv.find("#new-vdc-otherbanks").hide();payselectdiv.find("#chooseDebitCardBank").hide();}};payselectpage.jsonNetBanking=function jsonNetBanking(netbanking){if(netbanking.length==0){$("#netBanking-table").hide();}else{$("#netBanking-table").show();var netBankingSel=$("#netBanking_select");netBankingSel.find("option").hide();netBankingSel.find("option[value='']").attr("display",1).show();$.each(netbanking,function(){netBankingSel.find("option[value='"+this+"']").attr("display",1).show();});netBankingSel.find("option").remove("[display!=1]");}};payselectpage.jsonChinaMerchantsBankInstallments=function jsonChinaMerchantsBankInstallments(chinamerchantsbankinstallments){$("[existinginstallment='copy']").remove();if(chinamerchantsbankinstallments.length==0){$("#china-merchants-bank-installment-title-table").hide();$("#china-merchants-bank-installment-body-table").hide();}else{$("#china-merchants-bank-installment-title-table").show();$("#china-merchants-bank-installment-body-table").show();$.each(chinamerchantsbankinstallments,function(i,chinamerchantsbankinstallment){payselectpage.htmlChinaMerchantsBankInstallment(i,chinamerchantsbankinstallment);});}};payselectpage.jsonWireByBankOrPostOffice=function jsonWireByBankOrPostOffice(wirebybank){if(wirebybank.length==0){$("#wire-by-bank-or-post-office-table").hide();}else{$("#wire-by-bank-or-post-office-table").show();if(wirebybank.length!=0){$("#wire-by-bank").show();}}};payselectpage.jsonOrderSummary=function jsonOrderSummary(ordersummary){var domOrderSummary=$("#order-summary");domOrderSummary.find("[subtotalsline='copy']").remove();domOrderSummary.find("[subtotalstotal='copy']").remove();domOrderSummary.find("[subtotalsseparator='copy']").remove();domOrderSummary.show();if(ordersummary.useecardlink){payselectdiv.find(".use-ecard-link").show();$("#order-summary-title-blank").show();$("#order-summary-title").hide();$("#subtotals").hide();}else{$("#order-summary-title-blank").hide();$("#order-summary-title").show();$("#subtotals").show();}$.each(ordersummary.entries,function(i,row){payselectpage.htmlOrderSummaryRow(i,row);});if(ordersummary.primesignup){domOrderSummary.find("[subtotalsprimesignup]").insertBefore("#order-summary [subtotalsseparator=copy]");domOrderSummary.find("[subtotalsprimesignup]").show();}else{domOrderSummary.find("[subtotalsprimesignup]").hide();}};payselectpage.uiDefaultPaymentMethod=function uiDefaultPaymentMethod(currentpaymentmethod,recommendedpaymentmethod,availablebalance){if(payselectpage.NEW_PAYMENT_METHOD_ID=="availablebalance"&&(!availablebalance||!availablebalance.availablebalancecoverstotal)){payselectpage.NEW_PAYMENT_METHOD_ID=null;}var defaultPaymentMethodId=null;var rewardsPaymentMethod=null;if(payselectpage.NEW_PAYMENT_METHOD_ID){defaultPaymentMethodId=payselectpage.NEW_PAYMENT_METHOD_ID;payselectpage.NEW_PAYMENT_METHOD_ID=null;}else{if(currentpaymentmethod.id){defaultPaymentMethodId=currentpaymentmethod.id;if(currentpaymentmethod.rewardsAccount){rewardsPaymentMethod={id:currentpaymentmethod.rewardsAccount.id,amount:currentpaymentmethod.rewardsAccount.amount,isMaxSelected:currentpaymentmethod.rewardsAccount.isMaxSelected};}}else{if(recommendedpaymentmethod&&recommendedpaymentmethod.paymentmethodid){defaultPaymentMethodId=recommendedpaymentmethod.paymentmethodid;if(recommendedpaymentmethod.rewardaccountpaymentmethodid&&recommendedpaymentmethod.rewardaccountamount){rewardsPaymentMethod={id:recommendedpaymentmethod.rewardaccountpaymentmethodid,amount:recommendedpaymentmethod.rewardaccountamount,isMaxSelected:false};}}}}if(availablebalance.flexiblepayments){var htm=$("#existing-balance [flexiblepayments='copy']");if($("#existing-instruments [paymentmethodid='"+defaultPaymentMethodId+"']").attr("paymentMethodType")=="creditCard"){htm.find("input").attr("checked",true);}else{htm.find("input").attr("checked",false);}}payselectpage.uiSelectDefaultPaymentMethod(defaultPaymentMethodId);if(rewardsPaymentMethod){payselectpage.uiSelectRewards(rewardsPaymentMethod.id,rewardsPaymentMethod.isMaxSelected,rewardsPaymentMethod.amount);}};payselectpage.jsonPurchasePaymentAttributes=function jsonPurchasePaymentAttributes(purchasepaymentattributes){payselectpage.CAN_INPUT_PCARD_REFERENCE_NUMBER=purchasepaymentattributes.caninputpcardreferencenumber;};payselectpage.jsonCobrandAds=function jsonCobrandAds(cobrandads){if(cobrandads.ads){if(cobrandads.bottom){$("#marketing_bottom").html(decodeJSonResponse(cobrandads.ads)).show();}else{$("#marketing").html(decodeJSonResponse(cobrandads.ads));}}};payselectpage.jsonAvailableBalance=function jsonAvailableBalance(availablebalance){var useFlexiblePayments=$("#existing-balance [flexiblepayments='copy'] input").is(":checked")||availablebalance.useflexiblepayments;$("#existing-instruments [existingbalance='copy']").remove();$("#existing-instruments [flexiblepayments='copy']").remove();if(availablebalance.total||availablebalance.flexiblepayments||availablebalance.canuseamazonpoints){$("#existing-instruments table.balance").show();if(availablebalance.total){payselectpage.htmlAvailableBalance(availablebalance.total,availablebalance.totalraw,availablebalance.giftcard,availablebalance.promotion,availablebalance.availablebalancecoverstotal,availablebalance.usepromotions,availablebalance.usegiftcard,availablebalance.purchasetotal,availablebalance.purchasetotalraw);}if(availablebalance.flexiblepayments){payselectpage.htmlFlexiblePayments(availablebalance.flexiblepayments,useFlexiblePayments);}if(availablebalance.canuseamazonpoints){$("#amazon-points-marketing").show();}}else{$("#existing-instruments table.balance").hide();}};payselectpage.jsonNewPaymentMethods=function jsonNewPaymentMethods(newpaymentmethods){if(newpaymentmethods.creditcard&&newpaymentmethods.creditcard.types){if(newpaymentmethods.creditcard.showindashboard){$("#new-verified-credit-cards-table").show();$("#acceptvcc").show();payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY.clearErrors();payselectdiv.find("#vcc").find("input").val("");payselectdiv.find("#vcc").find("select").val("");payselectdiv.find("#vccerrorblock").parents("div.create").hide();if(!newpaymentmethods.creditcard.requirescvv){$("#new-card-cvv-title").hide();$("#vcccvvnum").hide();}$("#newVerifiedCreditCardImages *[issuer='']").siblings().hide();$("#newVerifiedCreditCardImages *[issuer='']").show();var cctypeSel=$("#vcctype");cctypeSel.find("option").hide();cctypeSel.find("option[value='']").attr("display",1).show();$.each(newpaymentmethods.creditcard.types,function(){cctypeSel.find("option[value='"+this.issuer+this.brand+"']").attr("display",1).show();});cctypeSel=$("#vdctype");cctypeSel.find("option").hide();cctypeSel.find("option[value='']").attr("display",1).show();$.each(newpaymentmethods.creditcard.types,function(){cctypeSel.find("option[value='"+this.issuer+this.brand+"']").attr("display",1).show();});}else{$("#cc").show();var cctypeSel=$("#cctype");cctypeSel.find("option").hide();cctypeSel.find("option[value='']").attr("display",1).show();$.each(newpaymentmethods.creditcard.types,function(){cctypeSel.find("option[value='"+this.issuer+this.brand+"']").attr("display",1).show();});if(newpaymentmethods.creditcard.needsecuritycode){$("#securitycodefield").show();}}}if(newpaymentmethods.lineofcredit){$("#loc").show();}if(newpaymentmethods.gcpromo){$("#gc_entry").show();if(!newpaymentmethods.isgcsupport){$("#gc_entry .logo").hide();$("#gc_entry h2, #gc_entry .offer, #gc_entry .create").css({"margin-left":0});}}if(newpaymentmethods.bankaccount){$("#bank-account").show();}if(newpaymentmethods.creditaccount){$("#cctype option[value='G21']").attr("display",1).show();$("#credit-account").show();}if(newpaymentmethods.directdebit){$("#direct-debit").show();$.each(newpaymentmethods.directdebit,function(){$("#country-code option[value='"+this.countrycode+"']").attr("display",1).show();});}if(newpaymentmethods.invoiceaccount&&!payselectpage.UNFINISHED_INVOICE_ADDRESS_ID){$("#invoice").show();}$("#cctype option").remove("[display!=1]");$("#direct-debit option").remove("[display!=1]");};payselectpage.jsonPurchaseAttributes=function jsonPurchaseAttributes(ordermethod){if(ordermethod=="oneclick"){payselectdiv.find("span.review-before-final").hide();}else{payselectdiv.find("span.review-before-final").show();}};payselectpage.jsonOnetimePaymentMethods=function jsonOnetimePaymentMethods(data){$("#one-time-payment-methods").hide();$("#convenience-store-payment tr").hide();$("#cash-on-delivery tr").hide();$("#check-payment tr").hide();if(data.cashondelivery||data.conveniencestorepayment||data.check){$("#one-time-payment-methods").show();}if(data.hideonetimepaymenthead){$("#one-time-payment-head").hide();}else{$("#one-time-payment-head").show();}if(data.cashondelivery&&data.cashondelivery.cash&&data.cashondelivery.cash.isvalid){$("#cash-on-delivery-cash-enabled").show();if(data.cashondelivery.cash.showcodcashmessage2ndline){$("#cash-on-delivery-cash-enabled").bind("click",payselectpage.actionViewCODMessage);$("#cash-on-delivery-cash-enabled").attr("showcodcashmessage2ndline","true");}}else{if(data.cashondelivery&&data.cashondelivery.cash&&data.cashondelivery.cash.disabled){$("#cash-on-delivery-cash-disabled").show();if(data.cashondelivery.cash.showcodcashmessage2ndline){$("#cod-cash-message-disable").hide();$("#cod-message-2nd-line-disable").show();$("#cash-on-delivery-cash-disabled").css({"color":"#666666"});}else{$("#cod-message-2nd-line-disable").hide();$("#cod-cash-message-disable").show();}}}if(data.cashondelivery&&data.cashondelivery.mpos&&data.cashondelivery.mpos.isvalid){$("#cash-on-delivery-mpos-enabled").show();}else{if(data.cashondelivery&&data.cashondelivery.mpos&&data.cashondelivery.mpos.disabled){$("#cash-on-delivery-mpos-disabled").show();}}if(data.conveniencestorepayment&&data.conveniencestorepayment.isvalid){$("#convenience-store-payment-enabled").show();}else{if(data.conveniencestorepayment&&data.conveniencestorepayment.disabled){$("#convenience-store-payment-disabled").show();}}if(data.check){$("#check-payment").show();}};payselectpage.jsonDashboard=function jsonDashboard(data){PIPELINE.pipedata=data;if(data.hidepaymentexpirationdate){$("#existing-credit-cards-expiration-date-title").hide();}if(data.isdelegatedpurchase&&data.hasnovalidpaymentmethods){$("#no-valid-payment-msg").show();}if(data.isdelegatedpurchase&&data.payselectinstructions){$("#purchase-delegation-pi-not-shown").html(data.payselectinstructions).show();}if(data.instrumenttitles){payselectpage.jsonInstrumentTitles(data.instrumenttitles);}var current=$("#existing-instruments tr.current");var currentPaymentMethod={};currentPaymentMethod.id=(current.size()>0)?current.attr("paymentmethodid"):null;currentPaymentMethod.rewardsAccount=(current.size()>0&&!data.hiderewardsaccount)?payselectpage.getRewardsUsageData(current):null;setmarker("af");if(data.cobrandads){payselectpage.jsonCobrandAds(data.cobrandads);}if(data.availablebalance){payselectpage.jsonAvailableBalance(data.availablebalance);}if(data.creditcards){payselectpage.jsonExistingCreditCards(data.creditcards,data.hiderewardsaccount);}if(data.lineofcreditaccounts){var currentpaymentmethodid=null;if(data.recommendedpaymentmethod){currentpaymentmethodid=data.recommendedpaymentmethod.paymentmethodid;}payselectpage.jsonExistingLocAccounts(data.lineofcreditaccounts,currentpaymentmethodid,data.purchaseordernumber);}if(data.checkingaccounts){payselectpage.jsonExistingCheckingAccounts(data.checkingaccounts);}if(data.directdebits){payselectpage.jsonExistingDirectDebits(data.directdebits);}if(data.invoiceaccount){payselectpage.jsonExistingInvoiceAccount(data.invoiceaccount);}if(data.payselectordersummary){payselectpage.jsonOrderSummary(data.payselectordersummary);}if(data.purchasepaymentattributes){payselectpage.jsonPurchasePaymentAttributes(data.purchasepaymentattributes);}if(data.newpaymentmethods){payselectpage.jsonNewPaymentMethods(data.newpaymentmethods);}if(data.ordermethod){payselectpage.jsonPurchaseAttributes(data.ordermethod);}if(data.onetimepaymentmethods){payselectpage.jsonOnetimePaymentMethods(data.onetimepaymentmethods);}if(data.thirdpartyaccounts){payselectpage.jsonThirdPartyAccounts(data.thirdpartyaccounts);}if(data.domesticcards){payselectpage.jsonDomesticCards(data.domesticcards);}if(data.chinamerchantsbankinstallments){payselectpage.jsonChinaMerchantsBankInstallments(data.chinamerchantsbankinstallments);}if(data.wirebybank){payselectpage.jsonWireByBankOrPostOffice(data.wirebybank);}if(data.verifieddebitcard){payselectpage.jsonVerifiedDebitCards(data.verifieddebitcard);}if(data.netbanking){payselectpage.jsonNetBanking(data.netbanking);}payselectpage.DASHBOARD_CLICK_COUNT=0;payselectpage.DASHBOARD_CHANGE_RETRY_COUNT=0;payselectpage.uiDefaultPaymentMethod(currentPaymentMethod,data.recommendedpaymentmethod,data.availablebalance);if(payselectpage.NEW_VERIFIED_CREDIT_CARD_CVV_NUMBER){$("#existing-instruments tr.current").find("#existingcccvvnum").val(payselectpage.NEW_VERIFIED_CREDIT_CARD_CVV_NUMBER);payselectpage.NEW_VERIFIED_CREDIT_CARD_CVV_NUMBER=null;}if(data.pagestate){payselectpage.jsonPageState(data.pagestate[PIPELINE.nextpage.page],data.availablebalance.availablebalancecoverstotal);}payselectpage.CONTINUE_ERROR_AUTHORITY.runAllValidators(false);$("#newCreditCardNumber").unbind("focusout").bind("focusout",payselectpage.actionCreditCardNumberChanged);$("#cctype").hide();$("#newVerifiedCreditCardNumber").unbind("focusout").bind("focusout",payselectpage.actionCreditCardNumberChanged);$("#newVerifiedDebitCardNumber").unbind("focusout").bind("focusout",payselectpage.actionCreditCardNumberChanged);if(data.weblabs&&data.weblabs.payselect){for(var weblab in data.weblabs.payselect){eval("payselectpage."+weblab+"(data.weblabs.payselect[weblab])");}}setmarker("cf");if(!payselectpage.CONTINUE_ERROR_AUTHORITY.hasErrors()&&!$("#existing-instruments tr.current").attr("requirescvv")){payselectpage.asyncActionContinue(data.pagestate[PIPELINE.nextpage.page].useajaxcontinue);}payselectpage.uiDashboardSpinner(false);payselectpage.uiOrderSummarySpinner(false);payselectpage.uiExistingInstrumentsSpinner(false);$("#existing-instruments").css("min-height","60px");$("#existing-instruments").css("height","60px");$("#other-payment-options").show();$("#ft").removeClass("loading");$("#continue-bar").show();payselectdiv.find(".continue").show();eventPageLoaded();payselectpage.jsonDisplayAd(data);payselectpage.uiDashboardResize();$("#checkoutpage").attr("pagename","payselect").attr("version","2");if(PIPELINE.pipedata&&PIPELINE.pipedata.weblabs&&PIPELINE.pipedata.weblabs.payselect&&PIPELINE.pipedata.weblabs.payselect.CHECKOUT_10180=="T1"){requestStaticContent("/gp/buy/pipeline/billingaddrselect.html","billingaddressselect");}};payselectpage.jsonDisplayAd=function(data){var ad=data.displayad;if(ad&&ad.endpoint&&!data.pagestate.payselect.addresschallenge){var aanSlot="display-ad-right";if(window.jQuery){jQuery(function(){var baseUrl="https://"+ad.endpoint+"/2009-09-09/ad/";jQuery.getScript(baseUrl+ad.client+"/jsc?pt=static&slot=lib&pt2=aanjs",function(){if(window.d16g){d16g.requestAanAd({elemId:"ad-top",baseUrl:baseUrl,afterOnload:true,client:ad.client,pt:"checkout",slot:aanSlot,pt2:"payselect"});}});});}}};payselectpage.jsonInstrumentTitles=function(data){var titles=["credit-card","loc","checking-account","direct-debit","invoice-account","available-balance","available-balance-use-your","available-balance-suffix","flexible-payment","gift-card","new-gift-card"];for(var i=0;i<titles.length;i++){if(data[titles[i]]){var replaceStr=decodeJSonResponse(data[titles[i]]);if($("#title-"+titles[i]).length>0){$("#title-"+titles[i]).text(replaceStr);}else{$(".title-"+titles[i]).text(replaceStr);}}}};payselectpage.jsonAddInvoiceAccount=function jsonAddInvoiceAccount(data){setmarker("be");$("#new-invoice img.loading-small").hide();if(payselectpage.treatment_9393){$("#new-invoice input.add-instrument-button").parent().parent().show();}else{$("#new-invoice input.add-instrument-button").show();}payselectpage.NEW_PAYMENT_METHOD_ID=data.unfinishedinvoiceaddressid;payselectpage.UNFINISHED_INVOICE_ADDRESS_ID=data.unfinishedinvoiceaddressid;payselectpage.refreshExistingInstruments();if(payselectpage.treatment_9393){payselectdiv.find("#invoice").find('input[type!="button"]').val("");}else{payselectdiv.find("#invoice").find("input").val("");}payselectdiv.find("#invoice").find("select").val("");payselectdiv.find("#invoiceaccounterrorblock").parents("div.create").hide();payselectdiv.find("#invoiceaccounterrorblock").parents("div.create").siblings("div.offer").show();};payselectpage.jsonAddInvoiceAccountError=function jsonAddInvoiceAccountError(errors){setmarker("be");$("#new-invoice img.loading-small").hide();if(payselectpage.treatment_9393){$("#new-invoice input.add-instrument-button").parent().parent().show();}else{$("#new-invoice input.add-instrument-button").show();}payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY.addErrors(errors);eventPageLoaded();};payselectpage.jsonAddCreditCard=function jsonAddCreditCard(data){setmarker("be");var table;if(!payselectpage.getActionSource()){table=$("#new-cc");}else{if(payselectpage.getActionSource()=="vcc"){table=$("#new-vcc");payselectpage.NEW_VERIFIED_CREDIT_CARD_CVV_NUMBER=$("#vcccvvnum").val();}else{if(payselectpage.getActionSource()=="vdc"){table=$("#new-vdc");payselectpage.NEW_VERIFIED_CREDIT_CARD_CVV_NUMBER=$("#vdccvvnum").val();}}}table.find("img.loading-small").hide();if(payselectpage.treatment_9393){table.find("input.add-instrument-button").parent().parent().show();}else{table.find("input.add-instrument-button").show();}payselectpage.NEW_PAYMENT_METHOD_ID=data.newpaymentmethodid;if(data.pipedata){payselectpage.jsonDashboard(data.pipedata);}else{payselectpage.refreshExistingInstruments();}payselectpage.updateCreditCardType("");if(!payselectpage.getActionSource()){if(payselectpage.treatment_9393){payselectdiv.find("#cc").find('input[type!="button"]').val("");}else{payselectdiv.find("#cc").find("input").val("");}payselectdiv.find("#cc").find("select").val("");payselectdiv.find("#creditcarderrorblock").parents("div.create").hide();payselectdiv.find("#creditcarderrorblock").parents("div.create").siblings("div.offer").show();payselectdiv.find("#maestrofields input").val("");payselectdiv.find("#maestrofields select").val("");payselectdiv.find("#securitycodefield input").val("");payselectdiv.find("#maestrofields").hide();}else{if(payselectpage.getActionSource()=="vcc"){payselectdiv.find("#vcc").find("input").val("");payselectdiv.find("#vcc").find("select").val("");payselectdiv.find("#vccerrorblock").parents("div.create").hide();payselectdiv.find("#vccerrorblock").parents("div.create").siblings("div.offer").show();}else{if(payselectpage.getActionSource()=="vdc"){payselectdiv.find("#vdc").find("input").val("");payselectdiv.find("#vdc").find("select").val("");payselectdiv.find("#verified_debitCard_banking_select").val("");payselectdiv.find("#new-vdc-otherbanks").hide();}}}payselectpage.setActionSource("");};payselectpage.jsonAddLineOfCredit=function jsonAddLineOfCredit(data){setmarker("be");$("#new-loc img.loading-small").hide();if(payselectpage.treatment_9393){$("#new-loc input.add-instrument-button").parent().parent().show();}else{$("#new-loc input.add-instrument-button").show();}payselectpage.NEW_PAYMENT_METHOD_ID=data.newpaymentmethodid;payselectpage.refreshExistingInstruments();payselectpage.updateCreditCardType("");payselectdiv.find("#loc").find("input").val("");payselectdiv.find("#loc").find("select").val("");payselectdiv.find("#lineofcrediterrorblock").parents("div.create").hide();payselectdiv.find("#lineofcrediterrorblock").parents("div.create").siblings("div.offer").show();};payselectpage.jsonAddDirectDebit=function jsonAddDirectDebit(data){setmarker("be");$("#new-direct-debit img.loading-small").hide();if(payselectpage.treatment_9393){$("#new-direct-debit input.add-instrument-button").parent().parent().show();}else{$("#new-direct-debit input.add-instrument-button").show();}payselectpage.NEW_PAYMENT_METHOD_ID=data.newpaymentmethodid;payselectpage.refreshExistingInstruments();if(payselectpage.treatment_9393){payselectdiv.find("#direct-debit").find('input[type!="button"]').val("");}else{payselectdiv.find("#direct-debit").find("input").val("");}payselectdiv.find("#direct-debit").find("select").val("");payselectdiv.find("#directdebiterrorblock").parents("div.create").hide();payselectdiv.find("#directdebiterrorblock").parents("div.create").siblings("div.offer").show();};payselectpage.jsonAddDirectDebitError=function jsonAddDirectDebitError(errors){setmarker("be");$("#new-direct-debit img.loading-small").hide();if(payselectpage.treatment_9393){$("#new-direct-debit input.add-instrument-button").parent().parent().show();}else{$("#new-direct-debit input.add-instrument-button").show();}payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY.addErrors(errors);eventPageLoaded();};payselectpage.jsonAddCreditCardError=function jsonAddCreditCardError(errors){setmarker("be");var authority;var table;if(!payselectpage.getActionSource()){table=$("#new-cc");authority=payselectpage.CREDIT_CARD_ERROR_AUTHORITY;}else{if(payselectpage.getActionSource()=="vcc"){table=$("#new-vcc");authority=payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY;}else{if(payselectpage.getActionSource()=="vdc"){table=$("#new-vdc");authority=payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY;}}}table.find("img.loading-small").hide();if(payselectpage.treatment_9393){table.find("input.add-instrument-button").parent().parent().show();}else{table.find("input.add-instrument-button").show();}payselectpage.setActionSource("");authority.addErrors(errors);eventPageLoaded();};payselectpage.jsonAddLineOfCreditError=function jsonAddLineOfCreditError(errors){setmarker("be");$("#new-loc img.loading-small").hide();if(payselectpage.treatment_9393){$("#new-loc input.add-instrument-button").parent().parent().show();}else{$("#new-loc input.add-instrument-button").show();}payselectpage.LINE_OF_CREDIT_ERROR_AUTHORITY.addErrors(errors);eventPageLoaded();};payselectpage.jsonGetCreditCardType=function jsonGetCreditCardType(data){payselectpage.updateCreditCardType(data.issuer+data.brand,data.issuerdisplayimage);};payselectpage.jsonGetCreditCardTypeError=function jsonGetCreditCardTypeError(errors){payselectpage.updateCreditCardType("");if(!payselectpage.getActionSource()){payselectpage.CREDIT_CARD_ERROR_AUTHORITY.addErrorsWithoutValidating(errors);}else{if(payselectpage.getActionSource()=="vcc"){payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY.addErrorsWithoutValidating(errors);}else{if(payselectpage.getActionSource()=="vdc"){payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY.addErrorsWithoutValidating(errors);}}}payselectpage.setActionSource("");};payselectpage.jsonGetCreditCardTypeSystemError=function jsonGetCreditCardTypeSystemError(){logEvents.enqueue(new LogEntry(logEvents.SYSTEM_ERROR_HANDLER,"CCType_ServiceError",[]));payselectpage.WAITING_FOR_TYPE=false;payselectpage.displayCreditCardIcon("");payselectpage.setActionSource("");};payselectpage.jsonUseAvailableBalance=function jsonUseAvailableBalance(data){payselectpage.refreshOrderSummary();};payselectpage.jsonUseAvailableBalanceError=function jsonUseAvailableBalanceError(error){var htm;htm+="<tr>"+"<td>"+"<strong>"+error+"</strong>"+"</td>"+"</tr>";$(htm).appendTo("#existing-balance");};payselectpage.jsonAddGiftPromotion=function jsonAddGiftPromotion(data){setmarker("be");$("#gc_entry img.loading-small").hide();if(payselectpage.treatment_9393){$("#gc_entry input.apply").parent().parent().show();}else{$("#gc_entry input.apply").show();}payselectpage.NEW_PAYMENT_METHOD_ID=data.newpaymentmethodid;payselectpage.refreshDashboard();payselectdiv.find("#gcpromoinput").val("");};payselectpage.jsonAddGiftPromotionError=function jsonAddGiftPromotionError(errors){setmarker("be");$("#gc_entry img.loading-small").hide();if(payselectpage.treatment_9393){$("#gc_entry input.apply").parent().parent().show();}else{$("#gc_entry input.apply").show();}payselectpage.GIFTCARD_PROMO_ERROR_AUTHORITY.addErrors(errors);eventPageLoaded();};payselectpage.jsonAddBankAccount=function jsonAddBankAccount(data){setmarker("be");$("#bank-account img.loading-small").hide();if(payselectpage.treatment_9393){$("#bank-account input.add-instrument-button").parent().parent().show();}else{$("#bank-account input.add-instrument-button").show();}payselectpage.NEW_PAYMENT_METHOD_ID=data.newpaymentmethodid;payselectpage.refreshExistingInstruments();if(payselectpage.treatment_9393){payselectdiv.find("#bank-account").find('input[type!="button"]').val("");}else{payselectdiv.find("#bank-account").find("input").val("");}payselectdiv.find("#bank-account").find("select").val("0");payselectdiv.find("#bankaccounterrorblock").parents("div.create").hide();payselectdiv.find("#bankaccounterrorblock").parents("div.create").siblings("div.offer").show();};payselectpage.jsonAddBankAccountError=function jsonAddBankAccountError(errors){setmarker("be");$("#bank-account img.loading-small").hide();if(payselectpage.treatment_9393){$("#bank-account input.add-instrument-button").parent().parent().show();}else{$("#bank-account input.add-instrument-button").show();}payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY.addErrors(errors);eventPageLoaded();};payselectpage.ready=function(){if(payselectpage.readyLoaded===1){return ;}setmarker("ns");var date=new Date();var currentYear=parseInt(date.getFullYear(),10);populateYearDropdown($("#ccyear"),currentYear,currentYear+20);populateYearDropdown($("#vccyear"),currentYear,currentYear+20);populateYearDropdown($("#vdcyear"),currentYear,currentYear+20);populateYearDropdown($("#startyear"),currentYear-5,currentYear);populateYearDropdown($("#invoice-day-of-birth"),1,31);populateYearDropdown($("#invoice-month-of-birth"),1,12);populateYearDropdown($("#invoice-year-of-birth"),currentYear-100,currentYear-18);payselectdiv.find(".continue-enabled").hover(payselectpage.maybeDisplayContinueDisabled,function f(){});payselectdiv.find(".continue-disabled").hover(function f(){},payselectpage.displayContinueEnabled);payselectdiv.find(".cvvhelp").hover(payselectpage.displayCVVHelp,payselectpage.hideCVVHelp);payselectdiv.find(".continue-enabled").unbind("click").bind("click",payselectpage.actionContinueWrapper);$("#direct-debit input.add-instrument-button").unbind("click").bind("click",payselectpage.actionAddDirectDebit);$("#new-invoice input.add-instrument-button").unbind("click").bind("click",payselectpage.actionAddInvoiceAccount);$("#new-cc input.add-instrument-button").unbind("click").bind("click",payselectpage.actionAddCreditCard);$("#new-loc input.add-instrument-button").unbind("click").bind("click",payselectpage.actionAddLineOfCredit);$("#existing-credit-cards input.validate-instrument-button").unbind("click").bind("click",payselectpage.actionConfirmCreditCard);$("#gc_entry input.apply").unbind("click").bind("click",payselectpage.actionAddGiftPromotion);$("#bank-account input.add-instrument-button").unbind("click").bind("click",payselectpage.actionAddBankAccount);$("#existing-instruments tbody").unbind("click").bind("click",payselectpage.actionSelectExistingPayment);$("#existing-credit-cards input[name^='cardCurrencyRadio']").unbind("click").bind("click",payselectpage.actionCurrencyRadioClick);$("#existing-credit-cards select[name^='cardCurrencyDropDown']").unbind("change").bind("change",payselectpage.actionCurrencyDropdownChange);$("#existing-credit-cards .changeCurrencyLink").unbind("click").bind("click",payselectpage.actionChangeCurrencyLinkClick);$("#existing-credit-cards div.rewardsusage tbody").unbind("click");$("#creditAccountApplyButton").unbind("click").bind("click",payselectpage.actionApplyCreditAccount);$("#cctype").unbind("change").bind("change",payselectpage.actionCCTypeDropdownChanged);$("#existing-credit-cards input[name='rewardscustom']").unbind("keyup").bind("keyup",payselectpage.actionUpdatePointsDisplay);$("#existing-credit-cards input[name='rewardscustom']").unbind("focus").bind("focus",payselectpage.actionSelectRewardsCustom);$("#existing-credit-cards .registerrewardslink").unbind("click").bind("click",payselectpage.actionRegisterRewardsConfigure);$("#existing-credit-cards .autoregisterrewardslink").unbind("click").bind("click",payselectpage.actionAutoRegisterRewardsSignup);payselectdiv.find(".toggle_use_ecard").unbind("click").bind("click",payselectpage.actionUseECard);$("#third-party-select").bind("change",payselectpage.actionThirdPartyAccountsDropdownChanged);$("#domestic-card-select").bind("change",payselectpage.actionDomesticCardsDropdownChanged);$("#wire-by-bank-info-link").bind("click",payselectpage.actionViewInfoWireByBank);$("#new-verified-credit-cards-table input.add-instrument-button").unbind("click").bind("click",payselectpage.actionAddCreditCard);$("#new-verified-debit-cards-table input.add-instrument-button").unbind("click").bind("click",payselectpage.actionAddCreditCard);$("#new-verified-credit-card").bind("click",payselectpage.actionViewAddNewCreditCard);$("#verified_debitCard_banking_select").bind("change",payselectpage.actionVerifiedDebitCardBankDropdownChanged);$("#netBanking_select").bind("change",payselectpage.actionNetBankingDropdownChanged);$("input[name='purchaseOrderNumber']").unbind("focus").bind("focus",payselectpage.actionUpdatePurchaseOrderNumber);$("input[name='purchaseOrderNumber']").unbind("blur").bind("blur",payselectpage.actionUpdatePurchaseOrderNumber);$("input[name='purchaseOrderNumber']").bind("change",payselectpage.actionChangedPurchaseOrderNumber);disableLabelEventsGlobally();$("#existing-instruments tbody input[type='checkbox']").unbind("click").bind("click",function(event){$(event.target).attr("alreadyToggled","true");});payselectdiv.find(".toggle_create").unbind("click").bind("click",function(){$(this).parents("div.offer").hide().siblings("div.create").show().find(":input:first").focus();logEvents.enqueue(new LogEntry(logEvents.SECTION_EXPANDED,$(this).attr("id"),[]));return false;});$("#cc *.logo").unbind("click").bind("click",function(){$(this).siblings("div.offer").hide().siblings("div.create").show().find(":input:first").focus();logEvents.enqueue(new LogEntry(logEvents.SECTION_EXPANDED,$(this).attr("class"),[]));return false;});payselectpage.CONTINUE_ERROR_AUTHORITY=new ErrorAuthority($("#continue-blocker-box"));payselectpage.CONTINUE_CVV_ERROR_AUTHORITY=new ErrorAuthority($("#continue-blocker-box"));payselectpage.CREDIT_CARD_ERROR_AUTHORITY=new ErrorAuthority($("#cc"));payselectpage.LINE_OF_CREDIT_ERROR_AUTHORITY=new ErrorAuthority($("#loc"));payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY=new ErrorAuthority($("#bank-account"));payselectpage.GIFTCARD_PROMO_ERROR_AUTHORITY=new ErrorAuthority($("#gc_entry"));payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY=new ErrorAuthority($("#direct-debit"));payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY=new ErrorAuthority($("#invoice"));payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY=new ErrorAuthority($("#vcc"));payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY=new ErrorAuthority($("#vdc"));payselectpage.createValidators();$(window).resize(function(){var w=$(window).width();var h=$(window).height();if(w!=PIPELINE.windowwidth||h!=PIPELINE.windowheight){PIPELINE.windowwidth=w;PIPELINE.windowheight=h;payselectpage.uiDashboardResize();}});payselectpage.readyLoaded=1;setmarker("ne");};payselectpage.startEngine=function startEngine(pipedata){if(!payselectdiv){payselectdiv=$("#payselectpagecontent");}window.cx={};var date=new Date();cx.startTime=date.getTime();cx.complete=false;payselectdiv.find(".continue-spinner").hide();payselectdiv.find(".continue-enabled").show();var htm=payselectdiv.find(".current");if(htm.size()>0){htm.removeClass("current");}payselectpage.uiDashboardResize();if(pipedata){payselectpage.uiDashboardSpinner(true);uiScrollToTop();payselectpage.jsonDashboard(pipedata);}else{payselectpage.refreshDashboard();}$(document).trigger("page-loaded");};function expirationValid(month,year){var date=new Date();return parseInt(year,10)>date.getFullYear()||(parseInt(year,10)==date.getFullYear()&&parseInt(month,10)>=(date.getMonth()+1));}function startdateValid(month,year){var date=new Date();return parseInt(year,10)<date.getFullYear()||(parseInt(year,10)==date.getFullYear()&&parseInt(month,10)<=(date.getMonth()+1));}function validatePaymentMethodSelected(elementsToValidate){var paymentMethod=$("#existing-instruments tr.current");var paymentMethodId=$("#existing-instruments tr.current").attr("paymentmethodid");return paymentMethod.size()>0&&paymentMethodId;}function validateFlexiblePaymentsHasCreditCard(elementsToValidate){var useFlexiblePayments=$("#existing-balance [flexiblepayments=copy] input").is(":checked");var paymentMethodType=$("#existing-credit-cards tr.current").attr("paymentmethodtype");return !(useFlexiblePayments&&(paymentMethodType!="creditCard"));}function validateExpirationDate(elementsToValidate){var current=$("#existing-credit-cards tr.current");var cardexpired=current.attr("cardexpired")=="true";var month=current.find("#new-cc-month").val();var year=current.find("#new-cc-year").val();return !(cardexpired&&!expirationValid(month,year));}function validateBadCVVNumber(elementsToValidate){var current=$("#existing-credit-cards tr.current");if(!current.attr("requirescvv")){return true;}var cvv=current.find("#existingcccvvnum").val();if(!cvv.match(/^[0-9]+$/)){return false;}return cvv.length==current.attr("validcvvlength");}function validateBadCombinationCheckExistingBalance(elementsToValidate){var isSelectCheck=$("#pm_pay_by_check").is(":checked");var isSelectBalance=$("#existing-balance [paymentmethodid='availablebalance']").find("input").is(":checked");return !(isSelectCheck&&isSelectBalance);}function validateAddressChallenge(elementsToValidate){var current=$("#existing-instruments tr.current");return !current.attr("isaddresschallenge")||current.attr("isaddresschallenge")!="true";}function validateGCorPromoBalance(elementsToValidate){var balancetotal=parseFloat($("#continue-blocker-box [datafield='gcpromototal']").attr("total"));var ordertotal=parseFloat($("#continue-blocker-box [datafield='purchasetotal']").attr("total"));return validatePaymentMethodSelected(elementsToValidate)||isNaN(balancetotal)||isNaN(ordertotal)||balancetotal>=ordertotal;}function isLuhnMatch(number){if(number.length===0){return false;}var sum=0;var alt=false;for(var i=number.length-1;i>=0;--i){var digit=number.charAt(i);if(alt){digit*=2;if(digit>9){digit-=9;}}sum+=parseInt(digit,10);alt=!alt;}return(sum%10)===0;}function cleanupCreditCardNumber(rawNumber){var patternForSpace=new RegExp(String.fromCharCode(32),"g");var patternForDash=new RegExp(String.fromCharCode(45),"g");return rawNumber.replace(patternForSpace,"").replace(patternForDash,"");}function validateIsNotEmpty(elementsToValidate){return elementsToValidate.val().length>0;}function validateCreditCardLength(elementsToValidate){return elementsToValidate.val().length>=10;}function validateCreditCardHasType(elementsToValidate){return elementsToValidate.val()!==""||!elementsToValidate.is(":visible");}function validateCreditCardMatchesLuhn(elementsToValidate){return isLuhnMatch(cleanupCreditCardNumber(elementsToValidate.val()));}function validateIsNotExpired(elementsToValidate){var month=elementsToValidate.eq(0).find("[name=ccmonth]").val();var year=elementsToValidate.eq(0).find("[name=ccyear]").val();var cctype=elementsToValidate.eq(1).find("option:selected").val();var date=new Date();return cctype=="G21"||parseInt(year,10)>date.getFullYear()||(parseInt(year,10)==date.getFullYear()&&parseInt(month,10)>=(date.getMonth()+1));}function validateHasIssueNumberOrValidStartDate(elementsToValidate){if(elementsToValidate.size()==0){return true;}var month=elementsToValidate.find("#startmonth").attr("value");var year=elementsToValidate.find("#startyear").attr("value");var issueNumber=elementsToValidate.find("#issuenumber").val();var date=new Date();var hasIssueNumber=issueNumber.length>0;var hasValidStartDate=(month.length>0&&year.length>0)&&(parseInt(year,10)<date.getFullYear()||(parseInt(year,10)==date.getFullYear()&&parseInt(month,10)<=(date.getMonth()+1)));return !elementsToValidate.is(":visible")||hasIssueNumber||hasValidStartDate;}function validateCreditCardCVV2(elementsToValidate){if(!elementsToValidate.eq(0).is(":visible")){return true;}var row=elementsToValidate.eq(0).parents("tr");var issuer=row.attr("isaddresschallenge")==="true"?row.attr("issuer"):elementsToValidate.eq(1).val().charAt(0);if(issuer=="R"){return true;}if(!elementsToValidate.eq(0).val().match(/^[0-9]+$/)){return false;}if(issuer=="A"){return elementsToValidate.eq(0).val().length===4;}else{return elementsToValidate.eq(0).val().length===3;}}function validateCreditCardMatchesTail(elementsToValidate){var cardNumber=cleanupCreditCardNumber(elementsToValidate.val());if(!cardNumber){return false;}var tail=elementsToValidate.parents("tr").attr("tail");var numberTail=cardNumber.substr(cardNumber.length-tail.length);return numberTail==tail;}function validateNotEmpty(elementsToValidate){return elementsToValidate.val().length>0;}function hasRewardsAccount(rewardsusage){return rewardsusage.attr("paymentmethodid")!==undefined;}function isRewardsCustomUsed(rewardsusage){var rewardsselect=rewardsusage.find("input[type=radio]:checked");return rewardsselect.val()=="rewardscustom";}function getRewardsEntry(rewardsusage){return parseFloat(rewardsusage.find("input[name=rewardscustom]").val());}function validateRewardsCurrencyInput(elementsToValidate){var rewardsEntry=elementsToValidate.val();var currencyRegex=new RegExp("^[0-9]*("+String.fromCharCode(92)+".[0-9]{1,2})?$");if(elementsToValidate.attr("useintegervalidation")){currencyRegex=new RegExp("^[0-9]*$");}return currencyRegex.test(rewardsEntry);}function validateRewardsInput(elementsToValidate){return elementsToValidate.val()&&!isNaN(elementsToValidate.val())&&elementsToValidate.val()>=0&&validateRewardsCurrencyInput(elementsToValidate);}function validateRewardsMin(elementsToValidate){var rewardsusage=$("#payselectpagecontent #existing-credit-cards tr.current .rewardsusage");if(hasRewardsAccount(rewardsusage)&&isRewardsCustomUsed(rewardsusage)){rewardsEntry=getRewardsEntry(rewardsusage);if(isNaN(rewardsEntry)){return false;}else{return(rewardsEntry>=payselectpage.REWARDS_ACCOUNTS[rewardsusage.attr("paymentmethodid")].mindollars);}}return true;}function validateRewardsMax(elementsToValidate){var rewardsusage=$("#payselectpagecontent #existing-credit-cards tr.current .rewardsusage");if(hasRewardsAccount(rewardsusage)&&isRewardsCustomUsed(rewardsusage)){rewardsEntry=getRewardsEntry(rewardsusage);if(isNaN(rewardsEntry)){return false;}else{return rewardsEntry<=payselectpage.REWARDS_ACCOUNTS[rewardsusage.attr("paymentmethodid")].maxusabledollars;}}return true;}function validateRewardsValue(elementsToValidate){var rewardsusage=$("#payselectpagecontent #existing-credit-cards tr.current .rewardsusage");if(hasRewardsAccount(rewardsusage)){var selectval=rewardsusage.find("input[type=radio]:checked").val();if(selectval=="rewardscustom"){var textinput=rewardsusage.find("input[name=rewardscustom]");return validateNotEmpty(textinput)&&validateRewardsCurrencyInput(textinput);}else{if(selectval=="rewardsmax"||selectval=="rewardsnone"){return true;}else{return false;}}}return true;}function validateAccountNumberMatch(elementsToValidate){return elementsToValidate.eq(0).val()==elementsToValidate.eq(1).val();}function validateRoutingNumberLength(elementsToValidate){return elementsToValidate.val().length==9;}function validateDLStateNotEmpty(elementsToValidate){return elementsToValidate.val()!="0";}function isPositiveInteger(textToValidate){return/^\d+$/.test(textToValidate);}function validateQuantityInputIsValid(elementsToValidate){var quantityInput=$.trim(elementsToValidate.val());return isPositiveInteger(quantityInput)&&quantityInput>=0&&quantityInput<=999;}function validateQuantityIsValidPerQtyFactor(elementsToValidate){var qtyvalue=parseInt($.trim(elementsToValidate.val()));var qtyfactor=parseInt(elementsToValidate.attr("quantityfactor"));return qtyvalue%qtyfactor==0;}function getCurrencySymbol(){return"$";}function getNumberWithSeparators(amount,decimalPlaces){if(!isNaN(decimalPlaces)){amount=Number(amount).toFixed(decimalPlaces);}amount=amount.toString();var intLength=amount.lastIndexOf(".")>=0?amount.lastIndexOf("."):amount.length;if(intLength<=3){return amount;}return getNumberWithSeparators(amount.substring(0,intLength-3),0)+","+amount.substring(intLength-3);}function getAmountWithCurrency(amount){return getCurrencySymbol()+getNumberWithSeparators(amount,2);}payselectpage.CREDIT_CARD_ERROR_AUTHORITY=null;payselectpage.BANK_ACCOUNT_ERROR_AUTHORITY=null;payselectpage.GIFTCARD_PROMO_ERROR_AUTHORITY=null;payselectpage.DIRECT_DEBIT_ERROR_AUTHORITY=null;payselectpage.INVOICE_ACCOUNT_ERROR_AUTHORITY=null;payselectpage.CONTINUE_ERROR_AUTHORITY=null;payselectpage.CREDIT_CARD_CONFIRM_ERROR_AUTHORITY=null;payselectpage.CONTINUE_CVV_ERROR_AUTHORITY=null;payselectpage.VERIFIED_CREDIT_CARD_ERROR_AUTHORITY=null;payselectpage.VERIFIED_DEBIT_CARD_ERROR_AUTHORITY=null;payselectpage.CAN_INPUT_PCARD_REFERENCE_NUMBER=0;payselectpage.NEW_PAYMENT_METHOD_ID=null;payselectpage.UNFINISHED_INVOICE_ADDRESS_ID=null;payselectpage.CURRENTLY_USES_PROMO_BALANCE=null;payselectpage.CONTINUE="";payselectpage.NEW_VERIFIED_CREDIT_CARD_CVV_NUMBER=null;payselectpage.NEW_CARD_ACTION_SOURCE=null;payselectpage.REWARDS_REGISTRATION=null;payselectpage.REWARDS_ACCOUNTS={};payselectpage.WAITING_FOR_TYPE=false;payselectpage.WAITING_FOR_ASYNC_CONTINUE=false;payselectpage.ASYNC_CONTINUE_VALID=false;payselectpage.ASYNC_CONTINUE_PIPEDATA=null;payselectpage.CONTINUE_CLICKED=false;payselectpage.CONTINUE_EVENT=null;payselectpage.ASYNC_CONTINUE_TIMEOUT=null;payselectpage.RETRYOPTIMISTICCHANGE=5;payselectpage.TIMEOUTRETRYCOUNT=0;payselectpage.RETRYOPTIMISTICTIMEOUT=5;payselectpage.WAITING_FOR_VALIDATION=false;spcpage.disableOrderSpinner=function disableOrderSpinner(){spcdiv.find("div.whitebox").css("opacity",1);spcdiv.find("img.order-spinner").hide();var shipoptions=spcdiv.find("div.ship-options");shipoptions.find("input[src*=radio-off]").not("input[isscheduledelivery=1]").unbind("click").bind("click",spcpage.actionSetShipOptions);var itemquantity=spcdiv.find("p.quantity");itemquantity.find(".changelink[name=updateQuantity]").unbind("click").bind("click",spcpage.actionUpdateQuantity);itemquantity.find(".changelink[name=removeItem]").unbind("click").bind("click",spcpage.actionRemoveItem);if(amznJQ.jQuery(".acr-popover").acrPopover){amznJQ.jQuery(".acr-popover").acrPopover();}};spcpage.showOrderSpinner=function showOrderSpinner(event){var orderdiv;if(event&&event.target){orderdiv=$(event.target).parents("[order=copy]");}else{orderdiv=$(event).parents("[order=copy]");}var orderwhitebox=orderdiv.find(".whitebox");orderwhitebox.css("opacity",0.33);var orderspinner=orderdiv.find(".order-spinner");orderspinner.show();var topoforderspinner=orderwhitebox.height()/2-orderspinner.height()/2;var leftoforderspinner=orderwhitebox.width()/2-orderspinner.width()/2;if(topoforderspinner<2){orderspinner.css({"top":"2px","left":leftoforderspinner+"px"});}else{if(topoforderspinner<50){orderspinner.css({"top":topoforderspinner+"px","left":leftoforderspinner+"px"});}else{orderspinner.css({"top":"50px","left":leftoforderspinner+"px"});}}var allorderdivs=spcdiv.find("div[order=copy]");allorderdivs.find("input[src*=radio]").unbind("click");allorderdivs.find(".changelink[name=updateQuantity]").unbind("click");allorderdivs.find(".changelink[name=removeItem]").unbind("click");};spcpage.uiDashboardSpinner=function uiDashboardSpinner(enable){if(enable){$("#bottom-place-order").hide();$("#purchase-context").hide();$("#dashboard").hide();$("#important-message-callout").hide();$("#global-error").hide();$("#message-box").hide();if(spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY){spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY.clearErrors();}$("#spc-gcpromoinput").val("");$("#spc-order-summary").css("opacity",0.33);$("#spinner").show();}else{$("#spc-subtotals").fadeOut("fast");$("#spinner").hide();$("#spc-order-summary").css("opacity",1);$("#dashboard").show();$("#purchase-context").show();spcpage.disableOrderSpinner();$("#spc-subtotals").fadeIn("fast");}};spcpage.createValidators=function createValidators(){spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#spc-gcpromoinput"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNotEmpty,errorIdentifier:"addGiftCardOrPromo_NoCode"})]}));};function validateIsNumber(elementsToValidate){var text=$(elementsToValidate.selector).val();return(/^\s*$/).test(text)||!isNaN(text);}function validatePointsMin(elementsToValidate){var text=$("#spc-points-input").val();if((/^\s*$/).test(text)){return true;}var points=parseFloat(text);if(isNaN(points)||!spcpage.REWARDS_DATA.creditcard.rewardsaccount.mindollaramount){return true;}return points==0||points>=spcpage.REWARDS_DATA.creditcard.rewardsaccount.mindollaramount;}function validatePointsMax(elementsToValidate){var text=$("#spc-points-input").val();if((/^\s*$/).test(text)){return true;}var points=parseFloat(text);if(isNaN(points)||!spcpage.REWARDS_DATA.creditcard.rewardsaccount.maxusabledollars){return true;}return points<=spcpage.REWARDS_DATA.creditcard.rewardsaccount.maxusabledollars;}spcpage.createDynamicValidators=function createDynamicValidators(){$.each(spcdiv.find("div[itemdisplay=copy]"),function(){spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[$(this).attr("entityid")]=new ErrorAuthority($(this));spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[$(this).attr("entityid")].addValidator(new Validator({elementsToValidate:$(this).find("input[name=quantity]"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateQuantityInputIsValid,errorIdentifier:"changeQuantity_quantityNotInRange"})]}));if(spcpage.PAGE_STATE.productbundleenabled&&($(this).find("input[name=quantity]").attr("quantityfactor")!=null)){spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[$(this).attr("entityid")].addValidator(new Validator({elementsToValidate:$(this).find("input[name=quantity]"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateQuantityIsValidPerQtyFactor,errorIdentifier:"changeQuantity_quantityNumberWrong"})]}));}});};spcpage.refreshPage=function refreshPage(){spcpage.uiDashboardSpinner(true);setmarker("xm");uiScrollToTop();var url="/gp/buy/pipeline/handlers/json-pipedata.html";var extradata="page=spc&object=billingaddress&object=shippingaddresses&object=paymentmethod&object=orders&object=ordersummary&object=messages&object=pagestate&object=nullpromotions&object=orderingpreferences";var callback="spcpage.jsonPage";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";setmarker("xn");getData(url,callback,errorhandler,systemerrorhandler,extradata);};spcpage.htmlHidePageLevelElements=function htmlHidePageLevelElements(){$("#message-box").hide();$("#important-message-callout").hide();$("#jersey-footnote").hide();$("#tfx-terms-of-use-footnote").hide();$("#show-seller-name-footnote").hide();};spcpage.htmlDisplayChangeLink=function htmlDisplayChangeLink(elementid,matchingelements){var idparts=/(.*)-(.*)-(.*)/.exec(elementid);var format=idparts[1];if(format=="block"){matchingelements.each(function(i,matchingelement){var element=$(matchingelement);var lastline=element.find("li:last");lastline.append("&nbsp;");lastline.append(element.siblings(".changelink").clone().show());element.parent(".single-address").show();});}else{matchingelements.each(function(i,matchingelement){var element=$(matchingelement);element.append("&nbsp;");var parentelement=element.parent(".shipping-group-recipient");element.append(parentelement.find(".changelink").show());parentelement.show();});}};spcpage.htmlDisplayStoreAddressReminder=function htmlDisplayStoreAddressReminder(orders){var storeaddressReminder=$("#storeaddress-reminder");if(storeaddressReminder.is(":hidden")){for(var index=0;index<orders.length;index++){if(orders[index].customername){storeaddressReminder.find("label[datafield='customername']").html(orders[index].customername);storeaddressReminder.parent(".storeaddress-remind-message").show();storeaddressReminder.show();break;}}}};spcpage.htmlItem=function htmlItem(i,item,shipmenthtml){var htm=shipmenthtml.find("div[itemdisplay='template']").clone(true);htm.attr("itemdisplay","copy");htm.attr("testid","item-"+item.asin);htm.find("h4[datafield='title']").append(item.title);if(item.image){htm.find("img.asin").attr("src",item.image).attr("alt",item.title);}var everyp=htm.find("p");var everyspan=htm.find("span");if(item.creator){var creatorhtm=everyp.filter("[datafield=creator]");creatorhtm.append(item.creator.name).show();if(item.creator.isauthor){creatorhtm.find("span").show();}}everyspan.filter("[datafield=price]").append(item.price);if(item.quantity){everyspan.filter("[datafield=quantity]").append(item.quantity);}else{if(item.isdigital){everyspan.filter("[datafield=quantity]").parent(".quantity").find("b").hide();everyspan.filter("[datafield=quantity]").hide();}else{everyspan.filter("[datafield=quantity]").parent(".quantity").hide();}}if(item.printdigitalbundle){htm.find("ul.printdigitalbundle").show();everyspan.filter("[datafield=printdigitalbundle]").append(item.printdigitalbundle);}if(item.availability&&item.availability.message){var availabilityhtm=everyspan.filter("[datafield=availability]");availabilityhtm.append(item.availability.message).show();if(item.availability.cssclass){availabilityhtm.addClass(item.availability.cssclass);}}if(item.promo){everyp.filter("[promo=template]").attr("promo",item.promo);}if(item.seller){var soldby=htm.find("p.sold-by").show();if(weblabs&&weblabs.spc&&weblabs.spc["SELLER_USAGE_NAME_13250"]=="T1"){soldby.find("[datafield='seller']").append(item.seller);}else{if(item.showbothmerchantnames){soldby.find("[datafield='seller']").append(item.seller+"("+item.merchantlegalname+")");}else{soldby.find("[datafield='seller']").append(item.seller);}}if(item.sellerurl){var sellerlink=soldby.find("a#sellerlink");sellerlink.attr("href",item.sellerurl);sellerlink.attr("onclick","return amz_js_PopWin('"+item.sellerurl+"','AmazonHelp','width=590,height=420,resizable=1,scrollbars=1,toolbar=1,status=1');");soldby.find("span[datafield='sellerwithoutlink']").hide();soldby.find("span[datafield='sellerwithlink']").show();}else{soldby.find("span[datafield='sellerwithlink']").hide();soldby.find("span[datafield='sellerwithoutlink']").show();}soldby.show();}if(item.prime){everyp.filter(".prime").show();htm.find("[prime='"+item.prime+"']").show();}if(item.primeupsell){htm.find(".primeitemupsell").attr("primeitemupsell",item.primeupsell);}var conditionhtm=everyspan.filter("[condition="+item.condition+"]");if(item.condition&&conditionhtm.size()>0){everyp.filter("[datafield=condition]").show();conditionhtm.show();var subconditionhtm=everyspan.filter("[subcondition="+item.subcondition+"]");if(item.subcondition&&subconditionhtm.size()>0){everyspan.filter("[datafield=subcondition]").show();subconditionhtm.show();}}setmarker("xu");var extragiftargs="editOrderID="+item.orderid+"&editOrderLineItemID="+item.orderlineitemid;if(item.giftoptions&&(item.giftoptions.giftwrap||item.giftoptions.giftmessage)){htm.find("a#add-gift").css("display","none");var changegift=htm.find("a#change-gift");changegift.attr("href",changegift.attr("href")+"?"+extragiftargs).show();if(item.giftoptions.giftwrap){everyp.filter("[datafield=gift-wrap]").append("<span testid='gift-wrap'>"+item.giftoptions.giftwrap+"</span>").show();}if(item.giftoptions.giftmessage){everyp.filter("[datafield=gift-message]").append("<span testid='gift-message'>"+item.giftoptions.giftmessage+"</span>").show();}}else{if(item.giftoptions&&item.giftoptions.giftable){var addgift=htm.find("a#add-gift");addgift.attr("href",addgift.attr("href")+"?"+extragiftargs).show();htm.find("a#change-gift").hide();}else{htm.find("a#add-gift").css("display","none");everyp.filter(".gift, .gift-message").hide();if(!item.isdigital){if(item.ismagazine){everyp.filter("#not-giftable-magazine").show();}else{everyp.filter("#not-giftable-digital").show();}}}}if(item.referencedata){var refblock=htm.find("ul[datafield='refdata']");$.each(item.referencedata,function(i,data){var refitem=htm.find("li[refdata='template']").clone();refitem.attr("refdata","copy");refitem.find(".refkey").append(item.referencedata[i].key);refitem.find(".refvalue").append(item.referencedata[i].value);refitem.appendTo(refblock);refitem.show();});refblock.show();}if(item.jersey){$("#jersey-footnote").show();}htm.show();htm.appendTo(shipmenthtml.find("div.asins"));setmarker("xv");};spcpage.htmlPromise=function htmlPromise(i,promise,dates,shipmenthtml){if(!dates){return ;}var earliest=dates.earliest;var latest=dates.latest;if(earliest){var htm=shipmenthtml.find("div[promisedisplay='template']").clone(true);htm.attr("promisedisplay","copy");var earliestdisplay=htm.find("span[promiselanguage='"+promise.language+"']");var latestdisplay=earliestdisplay.clone(true);earliestdisplay.find("span[datafield='promiseday']").html(earliest.day);earliestdisplay.find("span[datafield='promisemonth']").html(earliest.month);earliestdisplay.find("span[datafield='promiseyear']").html(earliest.year);if(latest){latestdisplay.find("span[datafield='promiseday']").html(latest.day);latestdisplay.find("span[datafield='promisemonth']").html(latest.month);latestdisplay.find("span[datafield='promiseyear']").html(latest.year);earliestdisplay.append("&nbsp;-&nbsp;");earliestdisplay.append(latestdisplay.html());}if(dates.type=="scheduled"&&earliest.starttime&&earliest.endtime){var timedisplay=htm.find("span[datafield='deliverytime']");timedisplay.find("span[datafield='starttime']").html(earliest.starttime);timedisplay.find("span[datafield='endtime']").html(earliest.endtime);timedisplay.show();}htm.find("span[promisetype='"+dates.type+"']").show();earliestdisplay.show();htm.show();htm.prependTo(shipmenthtml);}spcpage.stealScheduledDeliveryPromise();};spcpage.htmlShipmentHam=function htmlShipmentHam(htm,shipment){var message=htm.find("p[message='"+shipment.ham.id+"']");message.show();message.find("span[datafield='date']").html(shipment.ham.holidaydate);if(shipment.ham.merchantname){message.find("span[datafield='merchantname']").html(shipment.ham.merchantname);}htm.find("div[hamitem='template']").show();};spcpage.getFastTrackCountdown=function getFastTrackCountdown(secondsLeft){hoursLeft=secondsLeft>3600?(secondsLeft-secondsLeft%3600)/3600:0;secondsLeft=secondsLeft-hoursLeft*3600;minutesLeft=secondsLeft>60?(secondsLeft-secondsLeft%60)/60:0;secondsLeft=secondsLeft-minutesLeft*60;var countdown="";if(hoursLeft>0){if(hoursLeft==1){countdown=hoursLeft+" "+spcdiv.find("span[fasttrack='hour']").html()+" ";}else{countdown=hoursLeft+" "+spcdiv.find("span[fasttrack='hours']").html()+" ";}if(minutesLeft>0){countdown=countdown+" "+spcdiv.find("span[fasttrack='and']").html()+" ";}}if(minutesLeft>0){if(minutesLeft==1){countdown=countdown+minutesLeft+" "+spcdiv.find("span[fasttrack='minute']").html()+" ";}else{countdown=countdown+minutesLeft+" "+spcdiv.find("span[fasttrack='minutes']").html()+" ";}if(hoursLeft<1){countdown=countdown+" "+spcdiv.find("span[fasttrack='and']").html()+" ";}}if(hoursLeft<1){if(secondsLeft==1){countdown=countdown+secondsLeft+" "+spcdiv.find("span[fasttrack='second']").html();}else{countdown=countdown+secondsLeft+" "+spcdiv.find("span[fasttrack='seconds']").html();}}return countdown;};spcpage.htmlShipment=function htmlShipment(i,shipment,orderhtml){setmarker("xr");var htm=orderhtml.find("div[shipment='template']").clone(true);htm.attr("shipment","copy");if(shipment.ham&&shipment.ham.id){spcpage.htmlShipmentHam(htm,shipment);}if(shipment.promise){var ftshown=false;if(shipment.promise.fasttrack){var deliveryGuaranteeDateHtml=spcdiv.find("span[ftguaranteedatelanguage='"+shipment.promise.language+"']").clone();deliveryGuaranteeDateHtml.find("span[datafield='fasttrackday']").html(shipment.promise.fasttrack.deliveryGuaranteeDate.day);deliveryGuaranteeDateHtml.find("span[datafield='fasttrackmonth']").html(shipment.promise.fasttrack.deliveryGuaranteeDate.month);htm.find("span[datafield='deliveryGuaranteeDate']").html(deliveryGuaranteeDateHtml.html());htm.find("span[datafield='deliveryGuaranteeYear']").html(shipment.promise.fasttrack.deliveryGuaranteeDate.year);if(shipment.promise.fasttrack.ftexpiration&&shipment.promise.fasttrack.ftexpiration>0){htm.find("div[class='shipment-promise']").show();htm.find("div[class='shipment-promise-div']").hide();htm.find("div[class='fasttrack-div']").show();var timeoutFunction=function(timeToExpire,countdownThreshold,shipmentHtm){timeToExpire--;if(timeToExpire<=0){shipmentHtm.find("span[class='fasttrackavailable']").hide();shipmentHtm.find("span[class='fasttrackexpired']").show();}else{if(countdownThreshold&&(timeToExpire>countdownThreshold)){shipmentHtm.find("span[class='ftcountdown']").hide();shipmentHtm.find("span[class='fasttrackavailable']").show();}else{countdown=spcpage.getFastTrackCountdown(timeToExpire);shipmentHtm.find("span[datafield='ftcountdown']").html(countdown);shipmentHtm.find("span[class='ftcountdown']").show();shipmentHtm.find("span[class='fasttrackavailable']").show();}setTimeout(function(){timeoutFunction(timeToExpire,countdownThreshold,shipmentHtm);},1000);}};timeoutFunction(shipment.promise.fasttrack.ftexpiration,shipment.promise.fasttrack.countdownThreshold,htm);ftshown=true;}}if(!ftshown&&shipment.promise.promisequality){if(shipment.promise.promisequality=="normal"){if(shipment.promise.type=="scheduleddelivery"&&shipment.promise.text){var sdHtm=htm.find("div[promisedisplay='template']").clone(true);sdHtm.attr("promisedisplay","copy");sdHtm.find("span[promisetype='scheduleddelivery']").html(decodeJSonResponse(shipment.promise.text)).show();sdHtm.show();sdHtm.prependTo(htm);}else{$.each([shipment.promise.shipdate,shipment.promise.deliverydate],function(i,data){spcpage.htmlPromise(i,shipment.promise,data,htm);});}}else{var deliverypromise=htm.find("[promisedisplay='template']").clone(true);deliverypromise.attr("promisedisplay","copy").show();deliverypromise.prependTo(htm);}htm.find("[promisedisplay='copy'] [promisequality='"+shipment.promise.promisequality+"']").show();if(htm.find("[promisedisplay='copy']").eq(1)){htm.find("[promisedisplay='copy']").eq(1).addClass("secondary-shipment-promise");}}}if(shipment.showwinetreatment_shipment){htm.find("div[weatherlink='template']").show();}for(var item in shipment.items){if(shipment.items[item].showsellernamefootnote){$("#show-seller-name-footnote").show();break;}}setmarker("xs");var itemsdisplayHTML=shipment.itemsdisplayHTML;if(itemsdisplayHTML){htm.find("div.asins").replaceWith(decodeJSonResponse(itemsdisplayHTML));}else{$.each(shipment.items,function(i,item){spcpage.htmlItem(i,item,htm);});}if(spcpage.PAGE_STATE.productbundleenabled){amznJQ.onReady("popover",function(){htm.find("span.pbgroup-title").each(function(i,pbtitle){var pbgroupid=$(this).attr("pbgroupid");amznJQ.jQuery(this).amazonPopoverTrigger({showOnHover:true,showCloseButton:true,width:350,locationOffset:[55,-20],location:"bottom",localContent:"#"+pbgroupid,closeEventInclude:["MOUSE_LEAVE","CLICK_OUTSIDE"]});});});}htm.show();htm.appendTo(orderhtml.find("div.shipping-group"));setmarker("xt");};spcpage.jsonShipments=function jsonShipments(shipments,orderhtml){$.each(shipments,function(i,shipment){spcpage.htmlShipment(i,shipment,orderhtml);});};spcpage.htmlShippingSpeed=function htmlShippingSpeed(speedindex,speed,name,orderhtml,order,orderindex){var htm="";if(speed.isprimeisoa){if(speed.description){htm+=speed.description;}}else{var imgsrc="";if(speed.currentselection){imgsrc=spcdiv.find("#radio-on").attr("src");orderhtml.find("input[name='currentshippingspeed']").attr("value",speed.key);}else{imgsrc=spcdiv.find("#radio-off").attr("src");}var description="";if(speed.description){description=speed.description;}var radiobutton="<input type='image' src='"+imgsrc+"' style='border-width: 0px; width: 14px; height: 14px;' ";radiobutton+="name='"+name+"' value='"+speed.key+"' alt='"+description+"' ";radiobutton+="issss='"+speed.issss+"' ";radiobutton+="isscheduledelivery='"+speed.isscheduledelivery+"' ";radiobutton+="shippingofferingid='"+speed.shippingofferingid+"' guaranteetype='"+speed.guaranteetype+"'>";var indexofspeed=(speed.key&&order.trialshippingspeeds)?$.inArray(speed.key,order.trialshippingspeeds):-1;if(indexofspeed>=0&&orderindex==0){htm+="<tr shipping-speed='copy' trialshippingspeed='"+indexofspeed+"'>";}else{htm+="<tr shipping-speed='copy'>";}htm+="<td style='width: 14px; vertical-align: top;'>"+radiobutton+"</td>";htm+="<td class='shipping-speed-text'>";if(speed.promotion){htm+="<span datafield='description' class='shipPromoDescription'>"+description+"</span>&nbsp;";}else{htm+="<span datafield='description'>"+description+"</span>&nbsp;";}if(speed.deliveryarea){htm+="&nbsp;--&nbsp;<span datafield='deliveryarea'>"+speed.deliveryarea+"</span>&nbsp;";}if(speed.scheduledeliveryhtml){htm+="<span datafield='scheduledeliverywidget'>"+speed.scheduledeliveryhtml+"</span>";}else{if(speed.duration){htm+="<span datafield='duration'>"+speed.duration+"</span>";}if(speed.promisedeliverydate){htm+="<span datafield='promisedeliverydate'>"+speed.promisedeliverydate+"</span>";}if(speed.helplink){htm+="<span datafield='helplink'>"+speed.helplink+"</span>";}if(speed.upsell){htm+="<span datafield='upsell' class='alertgreen'>"+speed.upsell+"</span>";}if(speed.promotion){htm+="<br /><span datafield='promotion'>"+speed.promotion+"</span>";}if(speed.showphonenumber&&!order.isconfidential){var heavybulkycopy=orderhtml.find("div[heavybulky='template']").clone(true);heavybulkycopy.attr("heavybulky","copy");if(!order.phonenumber){var link=heavybulkycopy.find(".withoutphonelink");var url=link.find(".add-phone");url.attr("href",url.attr("href")+"?addressID="+order.address);htm+="&nbsp;"+link.html();}else{var msg=heavybulkycopy.find(".withphone");msg.find("[datafield=phonenumber]").append(order.phonenumber);var link=heavybulkycopy.find(".withphonelink");var url=link.find(".change-phone");url.attr("href",url.attr("href")+"?addressID="+order.address);htm+="<br />"+msg.html();htm+="&nbsp;"+link.html();}}}htm+="</td></tr>";}return htm;};spcpage.htmlDeliveryInstructions=function htmlDeliveryInstructions(orderhtml,deliveryinstructionoptions,orderid){var deliveryInstructionsHtml=orderhtml.find("div.delivery-instructions");var preferencesHtml="";$.each(deliveryinstructionoptions.deliverytimepreferences,function(i,preference){var name="order."+orderid+".deliveryTimePreference";var id=name+"."+preference.value;preferencesHtml+='<input height="14" border="0" width="14" type="radio" ';preferencesHtml+='name="'+name+'" id="'+id+'" alt="'+preference.displaystring+'" ';preferencesHtml+='value="'+preference.value+'"'+(i==0?' checked="checked">':">");preferencesHtml+='&nbsp;<label for="'+id+'">'+preference.displaystring+"</label><br />";});if(preferencesHtml&&deliveryinstructionoptions.freetextdeliveryinstructionsupported){preferencesHtml+="<br />";}deliveryInstructionsHtml.find("div.delivery-time-preferences-options").html(preferencesHtml);if(preferencesHtml){deliveryInstructionsHtml.find("div.delivery-time-preferences").show();}else{deliveryInstructionsHtml.find("div.delivery-time-preferences").hide();}var remarkHtml=deliveryInstructionsHtml.find("div.delivery-instruction-remark");if(deliveryinstructionoptions.freetextdeliveryinstructionsupported){remarkHtml.find("input").attr("name","order."+orderid+".deliveryInstructionRemark");remarkHtml.show();}else{remarkHtml.hide();}deliveryInstructionsHtml.show();};spcpage.htmlOrderHam=function htmlOrderHam(htm,order){var ham=htm.find("div[hamorder='template']");var message=ham.find("p[message='"+order.ham.id+"']");message.show();message.find("span[datafield='date']").html(order.ham.holidaydate);ham.find("span[datafield='holidayname']").html(order.ham.holidayname);if(order.ham.merchantname){message.find("span[datafield='merchantname']").html(order.ham.merchantname);}ham.show();};spcpage.htmlOrder=function htmlOrder(i,order,isshiptomultiple,isdigitalpurchase,hasprimeupsellineligibleitem){var htm=spcdiv.find("div[order='template']").clone(true);htm.attr("order","copy");htm.attr("orderid",order.orderid);htm.attr("testid","order-box-"+i);var name="order"+i;setmarker("xo");if(order.isdigital){htm.find("h4[name='nondigital-order']").hide();htm.find("h4[name='digital-order']").show();}else{htm.find("h4[name='digital-order']").hide();htm.find("h4[name='nondigital-order']").show();var shippingspeeds="";$.each(order.shippingspeeds,function(j,speed){shippingspeeds+=spcpage.htmlShippingSpeed(j,speed,name,htm,order,i);});htm.find(".shipping-speeds").html(shippingspeeds);htm.find("input[src*=radio-off]").not("input[isscheduledelivery=1]").bind("click",spcpage.actionSetShipOptions);if(order.deliveryinstructionoptions){spcpage.htmlDeliveryInstructions(htm,order.deliveryinstructionoptions,order.orderid);}}setmarker("xp");var containjerseyitem=0;if(order.shipments){for(var shipmentindex=0;shipmentindex<order.shipments.length;shipmentindex++){if(containjerseyitem){break;}for(var itemindex=0;itemindex<order.shipments[shipmentindex].items.length;itemindex++){if(order.shipments[shipmentindex].items[itemindex].jersey){containjerseyitem=1;break;}}}}if(containjerseyitem){htm.find("div[wrapper='order'] h2").hide();}else{if(order.marketplace&&order.shipsfrom){htm.find("span[datafield='shipsfrom']").html(order.shipsfrom);}}if(order.isdigital&&!isdigitalpurchase){var digitaldelivery=spcdiv.find("#digitaldelivery");htm.find(".shipping-group-recipient b").html(digitaldelivery.find("span[datafield='delivery']").html());htm.find(".shipping-group-recipient span[datafield='address']").html(digitaldelivery.find("span[datafield='downloaditem']").html());htm.find(".shipping-group-recipient").show();}else{if(isshiptomultiple){var addressspan=htm.find("span[datafield='address']");addressspan.html(order.addressHTML);addressspan.append("&nbsp;").append(htm.find(".shipping-group-recipient .changelink"));addressspan.find(".changelink").show();htm.find(".shipping-group-recipient").show();}}if(order.orderlineitemids){htm.find("input[name='orderlineitemids']").attr("value",order.orderlineitemids);}htm.find("div[shipoptions='template']").attr("shipoptions","copy");htm.find("[name='shipment-splitting']").find("input").attr("name","shipsplit"+i);if(order.shipsplitpreferences){htm.find("div[name='ship-split-preferences']").show();}var radioonsrc=spcdiv.find("#radio-on").attr("src");if(order.shiptogether){htm.find("tr[name='ship-together']").find("input").attr("src",radioonsrc).unbind("click");htm.find("input[name='currentshipsplitpreference']").attr("value","shipWhenComplete");}else{htm.find("tr[name='ship-together']").find("input").unbind("click").bind("click",spcpage.actionSetShipOptions);}if(order.shipseparately){htm.find("tr[name='ship-separately']").find("input").attr("src",radioonsrc).unbind("click");htm.find("input[name='currentshipsplitpreference']").attr("value","shipWhenever");}else{htm.find("tr[name='ship-separately']").find("input").unbind("click").bind("click",spcpage.actionSetShipOptions);}if(order.minimumShipmentsHelp){htm.find("#minimum-shipments-help").show();}if(order.merchantChargeHelp){htm.find("#merchant-charge-help").show();}if(order.itemQuantityEditable){htm.find("#change-quantity").show();}setmarker("xq");if(order.shipments){spcpage.jsonShipments(order.shipments,htm);}setmarker("xw");if(order.ham&&order.ham.id){spcpage.htmlOrderHam(htm,order);}if(order.primegroupcontent){htm.find("span.primebannerslot").html(decodeJSonResponse(order.primegroupcontent));if(hasprimeupsellineligibleitem&&order.primegroupcontent.match(/primeAdLauncher/gi)){htm.find("p[primeitemupsell='eligible']").show();}htm.find("input[name='changeCardNoEndDatePrime']").unbind("click").bind("click",spcpage.actionPrimeChangeCardNoEndDate);}if(order.primeheadercontent){htm.find("h4.shipping-speeds-header").html(decodeJSonResponse(order.primeheadercontent));}htm.show();htm.appendTo($("#orders"));};spcpage.jsonPurchaseShippingAddresses=function jsonPurchaseShippingAddresses(shippingaddresses,purchaseitemscount,shippingaddressHTML,isdigitalpurchase,weblabs){$("#multiple-addresses").hide();if(shippingaddresses.length===0){if(isdigitalpurchase){var digitaldelivery=spcdiv.find("#digitaldelivery");$("#purchase-shipping-address h3").html(digitaldelivery.find("span[datafield='delivery']").html());$("#purchase-shipping-address span[datafield='address']").html(digitaldelivery.find("span[datafield='downloaditem']").html());$("#purchase-shipping-address .single-address").show();}}else{if(shippingaddresses.length===1){var addresshtml;if(shippingaddressHTML){addresshtml=shippingaddressHTML;}else{var shippingaddresshtm=$("#block-address-"+shippingaddresses[0]);if(shippingaddresshtm.size()>0){addresshtml=$(shippingaddresshtm.get(0)).clone(true).removeAttr("id").html();}}if(addresshtml){$("#purchase-shipping-address [datafield='address']").html(addresshtml);var htm=$("#purchase-shipping-address .single-address");htm.find(".changelink:visible").remove();if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]=="T1"){$("#purchase-shipping-address .single-address-changelink-t1").show();}else{htm.find("li:last").append("&nbsp;").append(htm.find(".changelink").clone().show());}htm.show();}else{$("#purchase-shipping-address [datafield='address']").attr("addressmissing","block-address-"+shippingaddresses[0]);}if(purchaseitemscount>1){$("#ship-to-multiple-address-link").show();}else{$("#ship-to-multiple-address-link").hide();}}else{if(shippingaddresses.length>1){var htm=$("#multiple-addresses");if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]=="T1"){$("#purchase-shipping-address .multiple-address-change-link-t1").show();}else{htm.append($("#multiple-address-change-link").show());}htm.show();}}}$("#purchase-shipping-address").show();};spcpage.jsonBillingAddress=function jsonBillingAddress(billingaddress,billingaddressHTML,weblabs){if(billingaddress.suppressbillingaddress){$("#billing-information [datafield='address']").html("");$("#billing-information .single-address").hide();$("#billing-information .duplicate-address").hide();}else{if(billingaddress.issameasshippingaddress){$("#billing-information .single-address").hide();$("#billing-information .duplicate-address").show();if(billingaddress.suppresschangelink){$("#billing-information .duplicate-address").find(".changelink").hide();}else{if(weblabs&&weblabs.spc&&weblabs.spc["CHECKOUT_9443"]=="T1"){$("#billing-information .duplicate-address").find(".changelink").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddress);}if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]=="T1"){$("#billing-information .duplicate-address .duplicate-billing-address-change-t1").show();$("#duplicate-billing-address-change").hide();}else{$("#duplicate-billing-address-change").show();$("#billing-information .duplicate-address .duplicate-billing-address-change-t1").hide();}}}else{$("#billing-information .duplicate-address").hide();var addresshtml;if(billingaddressHTML){addresshtml=billingaddressHTML;}else{var billingaddresshtm=$("#block-address-"+billingaddress.billingaddressid);if(billingaddresshtm.size()>0){addresshtml=$(billingaddresshtm.get(0)).clone(true).removeAttr("id").html();}}if(addresshtml){$("#billing-information [datafield='address']").html(addresshtml);var htm=$("#billing-information .single-address");htm.find(".changelink").hide();if(!billingaddress.suppresschangelink){if(weblabs&&weblabs.spc&&weblabs.spc["CHECKOUT_9443"]=="T1"){if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]=="T1"){htm.find(".single-billing-address-change-t1").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddress).show();}else{if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]!="T1"){htm.find("li:last").append("&nbsp;").append(htm.find("#single-billing-address-change").clone().attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddress).show());}}}else{if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]=="T1"){htm.find(".single-billing-address-change-t1").show();}else{if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]!="T1"){htm.find("li:last").append("&nbsp;").append(htm.find("#single-billing-address-change").clone().show());}}}}htm.show();}else{$("#billing-information [datafield='address']").attr("addressmissing","block-address-"+billingaddress.billingaddressid);}}}};spcpage.jsonSpcCobrandAd=function jsonSpcCobrandAd(){if(spcpage.spccobrandad.ad&&$("#spc-cobrand-ad").length&&!spcpage.COBRAND_POPOVER_SHOWN){var ad=decodeJSonResponse(spcpage.spccobrandad.ad);var title=$("#title",$(ad)).html();var message=$("#message",$(ad)).html();$("#spc-cobrand-ad .msg").html(message);if(window.amznJQ){var changeAnchor;if(!amznJQ.jQuery("#payment-method .single-line-changelink").is(":hidden")){changeAnchor=amznJQ.jQuery("#payment-method .single-line-changelink .changelink:first");}else{changeAnchor=amznJQ.jQuery('#payment-method .payment-instrument[display="1"] .changelink:first');}if(changeAnchor.length){var skin='<div class="ap_popover ap_popover_sprited cobrand-popover" surround="6,16,18,16" tabindex="0">'+'     <div class="ap_header">'+'        <div class="ap_left"></div>'+'        <div class="ap_middle"></div>'+'        <div class="ap_right"></div>'+"    </div>"+'    <div class="ap_body">'+'        <div class="ap_left"></div>'+'        <div class="ap_content"></div>'+'        <div class="ap_right"></div>'+"    </div>"+'    <div class="ap_footer">'+'        <div class="ap_left"></div>'+'        <div class="ap_middle"></div>'+'        <div class="ap_right"></div>'+"    </div>"+'    <div class="ap_titlebar">'+'        <div class="ap_title"></div>'+"    </div>"+'    <div class="ap_close"><a href="#"><span class="ap_closetext"></span><span class="ap_closebutton"><span></span></span></a></div>'+"</div>";amznJQ.jQuery.AmazonPopover.displayPopover({skin:skin,modal:false,draggable:false,showCloseButton:true,closeEventExclude:"MOUSE_LEAVE",closeEventInclude:"CLICK_OUTSIDE",title:title,localContent:"#spc-cobrand-ad",width:300,group:"spc-cobrand-ad",location:function(popover,settings){var triggerMiddle=changeAnchor.offset().left+(changeAnchor.outerWidth()/2);var popoverLeft=triggerMiddle-150;return{left:popoverLeft,top:changeAnchor.offset().top+changeAnchor.outerHeight()-2};},onHide:function(popover,settings){spcpage.COBRAND_POPOVER_SHOWN=true;}});$(".cobrand-popover .ap_titlebar").show();}}}};spcpage.jsonPaymentMethod=function jsonPaymentMethod(paymentmethod,weblabs){if(paymentmethod.giftcertificate){$("#giftcertificate").attr("display",1).show();}else{$("#giftcertificate").attr("display",0).hide();}if(paymentmethod.rewardsaccount){$("#rewardsaccount").attr("display",1).show();}else{$("#rewardsaccount").attr("display",0).hide();}if(paymentmethod.amazonpayments){$("#amazonpayments").attr("display",1).show();}else{$("#amazonpayments").attr("display",0).hide();}if(paymentmethod.bankaccount){$("#bankaccount").attr("display",1).show();if(paymentmethod.bankaccounttail){$("#bankaccount span[datafield='backaccounttail']").html(paymentmethod.bankaccounttail);}}else{$("#bankaccount").attr("display",0).hide();}if(paymentmethod.creditcard){$("#redirectMessage span[datafield='3rdpartyname']").html(paymentmethod.creditcard.type);var cardtype=creditCardType(paymentmethod.creditcard.type);$("#creditcard [datafield='cclogo'] *").hide();if(paymentmethod.creditcard.issuerdisplayimage){$("#creditcard [datafield='cclogo']").append("<img src="+paymentmethod.creditcard.issuerdisplayimage+" alt="+paymentmethod.creditcard.issuerdisplayname+" />").show();}else{if(paymentmethod.creditcard.type){$("#creditcard [datafield='cclogo']").find("[cclogo='"+cardtype+"']").attr("alt",paymentmethod.creditcard.type).attr("style","display:inline-block");}}$("#creditcard [datafield='tail']").html(paymentmethod.creditcard.tail);$("#creditcard").attr("display",1).show();}else{$("#creditcard").attr("display",0).hide();}if(paymentmethod.lineofcredit){$("#lineofcredit [datafield='tail']").html(paymentmethod.lineofcredit.tail);$("#lineofcredit [datafield='type']").html(paymentmethod.lineofcredit.type);if(paymentmethod.lineofcredit.ponumber){$("#lineofcredit [datafield='ponumber']").html(paymentmethod.lineofcredit.ponumber);$("#lineofcredit span.ponumber").show();}else{$("#lineofcredit span.ponumber").hide();}$("#lineofcredit").attr("display",1).show();}else{$("#lineofcredit").attr("display",0).hide();}if(paymentmethod.cod){$("#cashondelivery").attr("display",1).show();}else{$("#cashondelivery").attr("display",0).hide();}if(paymentmethod.mpos){$("#cashondelivery-mpos").attr("display",1).show();}else{$("#cashondelivery-mpos").attr("display",0).hide();}if(paymentmethod.cash){$("#cashondelivery-cash").attr("display",1).show();}else{$("#cashondelivery-cash").attr("display",0).hide();}if(paymentmethod.cvs){$("#conveniencestore").attr("display",1).show();}else{$("#conveniencestore").attr("display",0).hide();}if(paymentmethod.invoice){$("#invoice2").attr("display",1).show();}else{$("#invoice2").attr("display",0).hide();}if(paymentmethod.externalpayment){$("#externalpayment span[datafield='externalpaymentname']").html(paymentmethod.externalpayment);$("#externalpayment").attr("display",1).show();$("#popover-title-billing-address .normal-billing-address-title").hide();$("#popover-title-billing-address .ep-billing-address-title").show();$("#popover-add-new-billing-address-link .normal-add-billing-address").hide();$("#popover-add-new-billing-address-link .ep-add-billing-address").show();}else{$("#externalpayment").attr("display",0).hide();$("#popover-title-billing-address .ep-billing-address-title").hide();$("#popover-title-billing-address .normal-billing-address-title").show();$("#popover-add-new-billing-address-link .ep-add-billing-address").hide();$("#popover-add-new-billing-address-link .normal-add-billing-address").show();}if(paymentmethod.netbanking){$("#spc_netbanking span[datafield='netbankingname']").html(paymentmethod.netbanking);$("#redirectMessage span[datafield='3rdpartyname']").html(paymentmethod.netbanking);$("#spc_netbanking").attr("display",1).show();}else{$("#spc_netbanking").attr("display",0).hide();}if(paymentmethod.debitcardbank){$("#spc_debitcardbank span[datafield='debitcardbankname']").html(paymentmethod.debitcardbank);$("#redirectMessage span[datafield='3rdpartyname']").html(paymentmethod.debitcardbank);$("#spc_debitcardbank").attr("display",1).show();}else{$("#spc_debitcardbank").attr("display",0).hide();}$("#payment-method .payment-instrument [datafield='changelink']").hide();if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]=="T1"){$("#billing-information .change-payment-method-t1").show();$("#billing-information .change-payment-method-t1").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);}else{if(paymentmethod.issinglepaymentmethod){$("#payment-method .payment-instrument[display='1']").find("[datafield='changelink']").show();$("#payment-method .single-line-changelink").hide();}else{$("#payment-method .single-line-changelink").show();}}if(paymentmethod.paymentdisplayname){$("#paymentDisplayName").val(paymentmethod.paymentdisplayname);}};spcpage.jsonOrders=function jsonOrders(orders,isshiptomultiple,showbottomplaceorder,isdigitalpurchase,hasprimeupsellineligibleitem){$.each(spcdiv.find("div[order='copy']"),function(){var placeholderdiv=$("<div></div>");placeholderdiv.attr("order","placeholder");placeholderdiv.height($(this).height());placeholderdiv.width($(this).width());$(this).replaceWith(placeholderdiv);});$.each(orders,function(i,order){spcpage.htmlOrder(i,order,isshiptomultiple,isdigitalpurchase,hasprimeupsellineligibleitem);});if(PIPELINE.pipedata.isgiftingenabled==1){spcpage.bindInlineGiftingAction();}spcdiv.find("div[order=placeholder]").remove();if(showbottomplaceorder){$("#bottom-place-order").show();}else{$("#bottom-place-order").hide();}if(orders.length<=1){$("#spcpagecontent [wrapper='order'] h2").hide();}};spcpage.jsonMessages=function jsonMessages(messageData,sssmessageData,orders){$("#global-error [message='copy']").remove();$("#important-message-callout [callout='copy']").remove();$("#message-box div").hide();if(messageData.messages){if(messageData.messages.length==1){$("#global-error-title-plural").hide();$("#global-error-title-singular").show();}else{$("#global-error-title-plural").show();$("#global-error-title-singular").hide();}$.each(messageData.messages,function(i,message){htm=$("#global-error [message='template']").clone();htm.attr("message","copy");htm.show();htm.html(message);htm.appendTo("#global-error");});$("#global-error").show();}else{$("#global-error").hide();}if(messageData.identifiers){$.each(messageData.identifiers,function(i,identifier){$("#"+identifier).show();});}if(messageData.callouts){$.each(messageData.callouts,function(i,callout){htm=$("#important-message-callout [callout='template']").clone();htm.attr("callout","copy");htm.show();htm.html(callout);htm.appendTo("#info-callout-list");});}if(sssmessageData&&sssmessageData.callouts){$.each(sssmessageData.callouts,function(i,callout){htm=$("#important-message-callout [callout='template']").clone();htm.attr("callout","copy");htm.show();htm.html(callout);htm.appendTo("#info-callout-list");});}if(messageData.callouts||(sssmessageData&&sssmessageData.callouts)){$("#important-message-callout").show();}else{$("#important-message-callout").hide();}if(messageData.professionalProducts){for(index in messageData.professionalProducts){var bulletPoint=messageData.professionalProducts[index];if($("#professional-user-certification-message [professionalproduct='"+bulletPoint.ASIN+"']").size()==0){htm=$("#professional-user-certification-message [professionalproduct='template']").clone();htm.attr("professionalproduct",bulletPoint.ASIN);htm.show();htm.html(bulletPoint.title);var content=bulletPoint.title;if(bulletPoint.safetyinformationlink){content+=" ("+bulletPoint.safetyinformationlink+")";}htm.html(content);htm.appendTo("#professional-product-list");}}}};spcpage.jsonNullPromotions=function jsonNullPromotions(model){var messagebox=$("#message-box");var promoordersummary=$("#null-promo-order-summary");var items=spcdiv.find("div.whitebox").find("div.asin");messagebox.find("p[nullpromo='copy']").remove();promoordersummary.find("li[nullpromo='copy']").remove();items.find("p[nullpromo='item']").html("");promoordersummary.hide();messagebox.hide();items.find("p[nullpromo='item']").hide();if(model){if(model.page){$.each(model.page,function(i,promo){htm=messagebox.find("p[nullpromo='page']").clone();htm.attr("nullpromo","copy");htm.show();htm.html(promo);htm.appendTo(messagebox);});messagebox.show();}if(model.orderSummary){$.each(model.orderSummary,function(i,promo){htm=promoordersummary.find("li[nullpromo='order-summary']").clone();htm.attr("nullpromo","copy");htm.show();htm.html(promo);htm.appendTo("#null-promo-order-summary-list");});promoordersummary.show();}if(model.item){$.each(model.item,function(lineitemid,promos){var promoinfo=promos.join("<br/>");spcdiv.find("div.asin").find("p[promo='"+lineitemid+"']").html(promoinfo).show();});}}};spcpage.jsonOrderingPreferences=function jsonOrderingPreferences(data){var htm=$("#save-defaults-box");if(data.savedefaultsbox){htm.show();$("#message-box").show();}else{htm.hide();}htm.find("input[name='isfirsttimecustomer']").val(data.isfirsttimecustomer);};spcpage.jsonStuff=function jsonStuff(data){setmarker("xx");var stuff=$("#stuff");stuff.html(decodeJSonResponse(data));spcdiv.find("div[order=copy]").each(function(i,order){setmarker("xy");var id=$(this).attr("orderid");$(this).find("div.ship-options").html(stuff.find("span[shippingoptions='"+id+"']"));$(this).find(".primebannerslot").html(stuff.find("span[primebanner='"+id+"']"));var str=spcdiv.find("span[primebanner='"+id+"']").html();if(str&&str.match(/primeAdLauncher/gi)){$(this).find("p[primeitemupsell='eligible']").show();}setmarker("xz");});spcdiv.find("input[name^=changeShipSplitPreference]:image").attr("onclick","");spcdiv.find("input[name^=changeShippingSpeed][src*=radio-off]:image").unbind("click").bind("click",spcpage.actionSetShipOptions);spcdiv.find("input[name^=changeShipSplitPreference][src*=radio-off]:image").unbind("click").bind("click",spcpage.actionSetShipOptions);spcdiv.find("input[name='changeCardNoEndDatePrime']").unbind("click").bind("click",spcpage.actionPrimeChangeCardNoEndDate);spcdiv.find("input[name='changeCardShowEndDatePrime']").unbind("click").bind("click",spcpage.actionPrimeChangeCardShowEndDate);};spcpage.stealScheduledDeliveryPromise=function stealScheduledDeliveryPromise(){spcdiv.find("div[order='copy']").each(function(i,order){var sdpromise=$(this).find("div[id^=sd_widgets]:visible [class*=sdMessage] p");var nonwhitespace=new RegExp("S");if(sdpromise.length>0&&nonwhitespace.test(sdpromise.text())){$(this).find("div[promisedisplay='copy'] [class='shipment-promise-div']").html(sdpromise);}});};spcpage.jsonChinaInvoice=function jsonChinaInvoice(data){var invoiceDiv=$("#china-invoice");var requiredCheck=$("#china-invoice-required");var titleInput=$("#china-invoice-title");var categoryDropdown=$("#china-invoice-category");var checkToShowCheckedContentFunc=function(){if(requiredCheck.attr("checked")){invoiceDiv.find("div.checked-content").show();}else{invoiceDiv.find("div.checked-content").hide();}};var checkToShowSaveAsDefaultFunc=function(){if(!/^\s*$/.test(titleInput.attr("value"))&&!/^\s*$/.test(categoryDropdown.attr("value"))){invoiceDiv.find("div.save-as-default").show();}else{invoiceDiv.find("div.save-as-default").hide();}};requiredCheck.unbind("click").bind("click",checkToShowCheckedContentFunc);titleInput.unbind("keyup").bind("keyup",checkToShowSaveAsDefaultFunc);categoryDropdown.unbind("change").bind("change",checkToShowSaveAsDefaultFunc);invoiceDiv.show();if(data.isrequired){requiredCheck.attr("checked","checked");checkToShowCheckedContentFunc();titleInput.attr("value",$("<span>"+data.defaulttitle+"</span>").html());}if(data.hasmerchantoffereditems){invoiceDiv.find("p.note-for-merchants").show();}if(data.categories){$.each(data.categories,function(i,category){categoryDropdown.append($("<option value='"+category.categoryid+"'"+(category.categoryid==data.defaultcategoryid?" selected='selected'":"")+">"+category.categoryname+"</option>"));});}checkToShowSaveAsDefaultFunc();};spcpage.pipedataValidator=function pipedataValidator(data){if(data.nextpage&&data.nextpage.page&&data.nextpage.page!="spc"){conductor(data);return true;}var missingdata=false;if(!data.paymentmethod){missingdata=true;}if(!data.orders||data.orders.length==0){missingdata=true;}else{$.each(data.orders,function(i,order){if(!order.shipments||order.shipments.length==0){missingdata=true;}else{$.each(order.shipments,function(i,shipment){if(!shipment.items||shipment.items.length==0){missingdata=true;}else{$.each(shipment.items,function(i,item){if(!item){missingdata=true;}});}});}});}if(!data.ordersummary){missingdata=true;}if(missingdata){if(!data.nextpage||data.nextpage.page=="spc"){window.location.href="/gp/buy/pipeline/handlers/error.html?errorType=spc:MissingData";}else{window.location.href="/gp/buy/shared/handlers/dispatch.html?hasWorkingJavascript=1";}}return missingdata;};spcpage.jsonUpdateQuantity=function jsonUpdateQuantity(data){spcpage.disableOrderSpinner();spcpage.enableBuyButton();if(data&&data.pipedata){spcpage.jsonPage(data.pipedata);}if(data&&data.messages&&data.messages.entityids){$.each(data.messages.entityids,function(){spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[this].clearErrors();spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[this].addErrors(data.messages[this]);});}};spcpage.actionDoNotDeleteAddon=function actionDoNotDeleteAddon(){if(spcpage.PAGE_STATE.updatequantityentity){var targetQuantity=spcdiv.find("[itemdisplay=copy][entityid='"+spcpage.PAGE_STATE.updatequantityentity+"']");if(targetQuantity.size()>0){var oldQuantity=targetQuantity.find("[datafield=quantity][mode=quantity-display]").html();targetQuantity.find("[name=quantity][mode=quantity-edit]").val(oldQuantity);spcpage.htmlCollapseQuantity(targetQuantity);}}spcpage.closeAddonPopover();};spcpage.jsonUpdateQuantityError=function jsonUpdateQuantityError(errors){spcpage.disableOrderSpinner();spcpage.enableBuyButton();if(errors&&errors.addon&&errors.addon.type&&errors.addon.entityids){spcpage.closeAddonPopover();var newQuantity=spcdiv.find("[itemdisplay=copy][entityid='"+errors.addon.entityids[0]+"']").find("[name=quantity][mode=quantity-edit]").val();if(newQuantity!=0){$("#addon-popover-"+errors.addon.type).find("h6[header=delete]").hide();$("#addon-popover-"+errors.addon.type).find("h6[header=reduce]").show();}else{$("#addon-popover-"+errors.addon.type).find("h6[header=delete]").show();$("#addon-popover-"+errors.addon.type).find("h6[header=reduce]").hide();}spcpage.addonpopover=amznJQ.jQuery.AmazonPopover.displayPopover({title:"&nbsp;",showOnHover:false,showCloseButton:true,skin:"default",location:"right",attached:true,locationElement:spcdiv.find("[itemdisplay=copy][entityid='"+errors.addon.entityids[0]+"'] a[name=removeItem]"),locationMargin:18,alignMargin:30,forceAlignment:true,closeText:spcdiv.find("#popover-close-text").html(),localContent:"#addon-popover-"+errors.addon.type,align:"top"});}if(errors&&errors.entityids){$.each(errors.entityids,function(){spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[this].clearErrors();spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[this].addErrors(errors[this]);});}};spcpage.htmlCollapseQuantity=function htmlCollapseQuantity(targetQuantity){targetQuantity.find("[mode=quantity-display]").show();targetQuantity.find("[mode=quantity-edit]").hide();};spcpage.actionClickChangeQuantity=function actionClickChangeQuantity(event){event.preventDefault();var quantity=$(event.target).parents(".quantity");quantity.find("[mode=quantity-display]").hide();quantity.find("[mode=quantity-edit]").show();quantity.find("input[name=quantity]").trigger("focus");};spcpage.callUpdateQuantity=function callUpdateQuantity(event,element,quantity){event.preventDefault();var entityid=element.attr("entityid");spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[entityid].clearErrors();spcpage.showOrderSpinner(event);spcpage.disableBuyButton();var url="/gp/buy/pipeline/handlers/update-quantity.html";var extradata="?"+entityid+"="+quantity+"&entityids="+entityid;if(spcpage.PAGE_STATE.hasaddonitems){if(!spcpage.PAGE_STATE.forceupdate){spcpage.PAGE_STATE.updatequantityentity=entityid;extradata+="&istrial=1";}else{spcpage.PAGE_STATE.forceupdate=0;}}var callback="spcpage.jsonUpdateQuantity";var errorhandler="spcpage.jsonUpdateQuantityError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};spcpage.actionUpdateQuantity=function actionUpdateQuantity(event){event.preventDefault();var quantityParent=$(event.target).parents("[itemdisplay=copy]");var quantity=quantityParent.find("input[name=quantity]");var itemid=quantityParent.attr("entityid");if(quantityParent.find("[datafield=quantity]").text()==quantity.val()){spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[itemid].clearErrors();spcpage.htmlCollapseQuantity(quantityParent);spcpage.PAGE_STATE.forceupdate=0;return ;}spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[itemid].runAllValidators(true);if(!spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY[itemid].hasErrors()){var pbgroupid=quantityParent.find("span.pbgroup-title").attr("pbgroupid");if(spcpage.PAGE_STATE.productbundleenabled&&pbgroupid){if(spcpage.pbupdatepopover){spcpage.pbupdatepopover.close();spcpage.pbupdatepopover=null;}spcpage.pbupdatepopover=amznJQ.jQuery.AmazonPopover.displayPopover({title:"&nbsp;",showOnHover:false,showCloseButton:true,skin:"default",location:"right",attached:true,locationElement:quantityParent.find("a[name=updateQuantity]"),locationMargin:18,alignMargin:30,forceAlignment:true,localContent:"#update-action-popup-"+pbgroupid,align:"top",onShow:function(){$("#update-action-popup-"+pbgroupid).find("h6[header=delete]").hide();$("#update-action-popup-"+pbgroupid).find("h6[header=update]").show();$("#update-action-popup-"+pbgroupid).find("input[name=deletePB]").unbind("click").bind("click",function(){var qtyvalue=parseInt(quantity.val());if(quantity.attr("quantityfactor")){var qtyfactor=parseInt(quantity.attr("quantityfactor"));qtyvalue=qtyvalue/qtyfactor;}spcpage.callUpdateQuantity(event,quantityParent,qtyvalue);spcpage.pbupdatepopover.close();});$("#update-action-popup-"+pbgroupid).find("input[name=doNotDeletePB]").unbind("click").bind("click",function(){quantity.attr("value",quantityParent.find("[datafield=quantity]").text());spcpage.pbupdatepopover.close();});}});}else{spcpage.callUpdateQuantity(event,quantityParent,quantity.val());}}};spcpage.actionRemoveItem=function actionRemoveItem(event){event.preventDefault();var quantityParent=$(event.target).parents("[itemdisplay=copy]");var pbgroupid=quantityParent.find("span.pbgroup-title").attr("pbgroupid");if(spcpage.PAGE_STATE.productbundleenabled&&pbgroupid){if(spcpage.pbdeletepopover){spcpage.pbdeletepopover.close();spcpage.pbdeletepopover=null;}spcpage.pbdeletepopover=amznJQ.jQuery.AmazonPopover.displayPopover({title:"&nbsp;",showOnHover:false,showCloseButton:true,skin:"default",location:"right",attached:true,locationElement:quantityParent.find("a[name=removeItem]"),locationMargin:18,alignMargin:30,forceAlignment:true,localContent:"#update-action-popup-"+pbgroupid,align:"top",onShow:function(){$("#update-action-popup-"+pbgroupid).find("h6[header=delete]").show();$("#update-action-popup-"+pbgroupid).find("h6[header=update]").hide();$("#update-action-popup-"+pbgroupid).find("input[name=deletePB]").unbind("click").bind("click",function(){quantityParent.find("input[name=quantity]").val(0);spcpage.callUpdateQuantity(event,quantityParent,0);spcpage.pbdeletepopover.close();});$("#update-action-popup-"+pbgroupid).find("input[name=doNotDeletePB]").unbind("click").bind("click",function(){spcpage.pbdeletepopover.close();});}});}else{quantityParent.find("input[name=quantity]").val(0);spcpage.callUpdateQuantity(event,quantityParent,0);}};spcpage.bindInlineGiftingAction=function bindInlineGiftingAction(){var data=PIPELINE.pipedata;if(data){var orders=data.orders;if(orders){for(var i=0;i<orders.length;i++){var shipments=orders[i].shipments;if(shipments){for(var j=0;j<shipments.length;j++){var items=shipments[j].items;if(items){for(var k=0;k<items.length;k++){if(items[k].quantity&&items[k].quantity==1){var giftLinks=$('#orders div[entityid="'+items[k].lineitementityid+'"] #gift-link a');giftLinks.attr("href","#").unbind("click").bind("click",{obfuscatedEntityId:items[k].lineitementityid},spcpage.actionChangeGiftOptionsPopover);}}}}}}}}};spcpage.actionForceRemoveAddon=function actionForceRemoveAddon(){spcpage.PAGE_STATE.forceupdate=1;spcpage.closeAddonPopover();var itemdiv=spcdiv.find("[itemdisplay=copy][entityid='"+spcpage.PAGE_STATE.updatequantityentity+"']");if(itemdiv.find("input[name=quantity]").val()==0){itemdiv.find(".changelink[name=removeItem]").trigger("click");}else{itemdiv.find(".changelink[name=updateQuantity]").trigger("click");}};spcpage.RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181=function RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181(treatment){};spcpage.PURPLE_10732=function PURPLE_10732(treatment){if(treatment=="T1"){$("#addon-popover-normal, #addon-popover-special").find("input[name=deleteAddon]").bind("click",spcpage.actionForceRemoveAddon);$("#addon-popover-normal").find("input[name=doNotDeleteAddon]").bind("click",spcpage.actionDoNotDeleteAddon);}};spcpage.CHECKOUT_9443=function CHECKOUT_9443(treatment){};spcpage.CHECKOUT_10180=function CHECKOUT_10180(treatment){};spcpage.RCX_CHECKOUT_CORE_POINTS_ON_SPC_12713=function(treatment){if(treatment=="T1"){$("#spc-points-entry input.apply").unbind("click").bind("click",spcpage.actionApplyPoints);$("#spc-points-entry input.update").unbind("click").bind("click",spcpage.actionApplyPoints);$("#spc-points-input").unbind("keyup").bind("keyup",spcpage.actionUpdatePointsDisplay);spcpage.POINTS_ERROR_AUTHORITY=new ErrorAuthority($("#spc-points-entry"));$("#spc-points-entry .registerrewardslink").unbind("click").bind("click",spcpage.actionRegisterRewardsConfigure);spcpage.POINTS_ERROR_AUTHORITY.addValidator(new Validator({elementsToValidate:$("#spc-points-input"),validateFunctionWrappers:[new ValidateFunctionWrapper({validateFunction:validateIsNumber,errorIdentifier:"setPoints_badValue"}),new ValidateFunctionWrapper({validateFunction:validatePointsMin,errorIdentifier:"setPoints_badMin"}),new ValidateFunctionWrapper({validateFunction:validatePointsMax,errorIdentifier:"setPoints_badMax"})]}));}};spcpage.CHECKOUT_9393=function CHECKOUT_9393(treatment){if(treatment=="T1"){spcpage.treatment_9393=true;}else{spcpage.treatment_9393=false;}};spcpage.PLACE_YOUR_ORDER_POST_10189=function PLACE_YOUR_ORDER_POST_10189(treatment){if(treatment=="T1"){spcpage.PAGE_STATE.CONFIRM_POST=1;}};spcpage.SHIPOPTION_CACHE_COUNT=function SHIPOPTION_CACHE_COUNT(treatment){};spcpage.SS_SHIPPING_ADDRESS=function SS_SHIPPING_ADDRESS(treatment){};spcpage.SS_ORDER_SUMMARY=function SS_ORDER_SUMMARY(treatment){if(treatment!="T1"){return ;}var ordersummary=PIPELINE.pipedata.ordersummary;var isFXEligible=ordersummary.fx&&ordersummary.fx.isFXEligible;var isFXPurchase=ordersummary.fx&&ordersummary.fx.purchaseIsFX;var isFXForeignContext=isFXEligible&&isFXPurchase&&$("#currencyChanged").attr("value")!="true";var hasTaxableRegulatoryFeeBreakdown=ordersummary.subtotals&&ordersummary.subtotals.regulatoryfeebreakdown&&ordersummary.subtotals.regulatoryfeebreakdown.taxable;var hasNonTaxableRegulatoryFeeBreakdown=ordersummary.subtotals&&ordersummary.subtotals.regulatoryfeebreakdown&&ordersummary.subtotals.regulatoryfeebreakdown.nontaxable;var hasTaxableRegulatoryFeeBreakdownFX=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.regulatoryfeebreakdown&&ordersummary.fx.subtotals.regulatoryfeebreakdown.taxable;var hasNonTaxableRegulatoryFeeBreakdownFX=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.regulatoryfeebreakdown&&ordersummary.fx.subtotals.regulatoryfeebreakdown.nontaxable;if(hasTaxableRegulatoryFeeBreakdown){spcpage.createRegulatoryFeePopover("#SPCSubtotals-marketplace .taxable.rollup","#SPCTaxableRegulatoryFeeBreakdown-marketplace-table");}if(hasNonTaxableRegulatoryFeeBreakdown){spcpage.createRegulatoryFeePopover("#SPCSubtotals-marketplace .nonTaxable.rollup","#SPCNonTaxableRegulatoryFeeBreakdown-marketplace-table");}if(hasTaxableRegulatoryFeeBreakdownFX){spcpage.createRegulatoryFeePopover("#SPCSubtotals-transactional .taxable.rollup","#SPCTaxableRegulatoryFeeBreakdown-transactional-table");}if(hasNonTaxableRegulatoryFeeBreakdownFX){spcpage.createRegulatoryFeePopover("#SPCSubtotals-transactional .nonTaxable.rollup","#SPCNonTaxableRegulatoryFeeBreakdown-transactional-table");}if(ordersummary.showVatPopover){$("#vatBreakdownNote").show();$("#vatBreakdown").hide();}else{$("#vatBreakdownNote").hide();}if(isFXEligible){$("#tfx-conversion-rate-trigger").click(function(event){event.preventDefault();$("#tfx-conversion").show();$("#tfx-conversion-rate-trigger").hide();});spcdiv.undelegate("#checkoutCurrencyMarketplace","click").delegate("#checkoutCurrencyMarketplace","click",spcpage.submitChangeCurrency2);spcdiv.undelegate("#checkoutCurrencyTransactional","click").delegate("#checkoutCurrencyTransactional","click",spcpage.submitChangeCurrency2);$("#switch-currency-button").show();$("#tfx-currency-switcher").hide();}if(window.amznJQ){amznJQ.onReady("popover",function(){amznJQ.jQuery("#vatBreakdownLink").removeAmazonPopoverTrigger().amazonPopoverTrigger({title:$("#vatTitle").html(),showOnHover:false,showCloseButton:true,skin:"default",location:"bottom",align:"right",width:450,localContent:"#vatBreakdown"});});}spcdiv.find("div[buybuttondiv='notfx']").find("input").unbind("click").bind("click",spcpage.actionConfirmPurchase);spcdiv.find("div[buybuttondiv='fx']").find("input").unbind("click").bind("click",spcpage.actionConfirmPurchase);spcdiv.find("div[buybuttondiv$=fx]").find("input").unbind("hover").hover(function(){spcpage.validatePlaceYourOrderButton();var blockerBox=$("#place-order-blocker-box");if(blockerBox.find("p[on=yes]").length>0){blockerBox.show();var y=blockerBox.height()/2;var x=blockerBox.width();blockerBox.css({top:$(this).offset().top-y,left:$(this).offset().left-x-20});}},function(){spcpage.enableBuyButton();$("#place-order-blocker-box").hide();});};spcpage.submitChangeCurrency2=function submitChangeCurrency2(event){event.preventDefault();var currencyType=$(this).attr("data-currency-type");var radioId=$(this).attr("id");spcpage.submitChangeCurrency(currencyType,radioId);};spcpage.SS_PAYMENT_METHOD=function SS_PAYMENT_METHOD(treatment){if(treatment!="T1"){return ;}$("#payment-method .changelink").attr("href","#").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);var paymentmethod=PIPELINE.pipedata.paymentmethod;var weblabs=PIPELINE.pipedata.weblabs;if(paymentmethod.externalpayment){$("#popover-title-billing-address .normal-billing-address-title").hide();$("#popover-title-billing-address .ep-billing-address-title").show();$("#popover-add-new-billing-address-link .normal-add-billing-address").hide();$("#popover-add-new-billing-address-link .ep-add-billing-address").show();}else{$("#popover-title-billing-address .ep-billing-address-title").hide();$("#popover-title-billing-address .normal-billing-address-title").show();$("#popover-add-new-billing-address-link .ep-add-billing-address").hide();$("#popover-add-new-billing-address-link .normal-add-billing-address").show();}if(weblabs&&weblabs.spc&&weblabs.spc["RCX_CHECKOUT_CORE_SPC_CHANGE_LINK_12181"]=="T1"){$("#billing-information .change-payment-method-t1").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);}if(paymentmethod.paymentdisplayname){$("#paymentDisplayName").val(paymentmethod.paymentdisplayname);}if(weblabs&&weblabs.spc&&weblabs.spc["CHECKOUT_9443"]=="T1"){$("#billing-information .duplicate-address").find(".changelink").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddress);}};spcpage.asyncSetDeliveryTrial=function asyncSetDeliveryTrial(){if(!PIPELINE.pipedata||!PIPELINE.pipedata.scopeid){return ;}spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS=0;if(spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA_TIMEOUT){clearTimeout(spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA_TIMEOUT);spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA_TIMEOUT=0;}spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA=new Object();var orders=spcdiv.find("div[order='copy']");var groupcount=0;var extradata="";var trialinputs4topoption=[];var trialinputs=[];$.each(orders,function(orderindex,order){var htm=$(order);var input="";var speeds=(orderindex==0?htm.find("[shipping-speed='copy'][trialshippingspeed] input"):htm.find(".shipping-speeds input[src*=radio-on]"));var splitpref=htm.find("[name='shipment-splitting']").find("input[src*=radio-on]");if(splitpref.length!=1){splitpref=null;}input+="&lineitemids"+groupcount+"="+htm.find("input[name='orderlineitemids']").attr("value");if(speeds.length){speeds.each(function(){var speed=$(this);var speedparams="";speedparams+="&shippingspeed"+groupcount+"="+speed.attr("value");speedparams+="&shippingofferingid"+groupcount+"="+speed.attr("shippingofferingid");speedparams+="&guaranteetype"+groupcount+"="+speed.attr("guaranteetype");speedparams+="&issss"+groupcount+"="+speed.attr("issss");var splitval="shipWhenComplete";if(splitpref){splitval=splitpref.attr("value");}speedparams+="&shippriority"+groupcount+"="+splitval;if(orderindex==0){var trialkey=PIPELINE.pipedata.scopeid+":"+speed.attr("name")+":"+speed.attr("value");var trialpriority=speed.parent().parent().attr("trialshippingspeed");var cachecount=PIPELINE.pipedata.weblabs&&PIPELINE.pipedata.weblabs.spc?PIPELINE.pipedata.weblabs.spc["SHIPOPTION_CACHE_COUNT"]:0;if(trialpriority<cachecount){trialinputs4topoption.push({"trialkey":trialkey,"speedparams":speedparams});}else{trialinputs.push({"trialkey":trialkey,"speedparams":speedparams});}}else{extradata+=speedparams;}});}extradata+=input;groupcount++;});if(groupcount>0){extradata+="&groupcount="+groupcount;}extradata+="&istrial=1";if(extradata.indexOf("&")===0){extradata=extradata.substr(1);}var url="/gp/buy/spc/handlers/set-delivery-options.html/ref=ox_spc_set_trial_ship_option";var callback="spcpage.jsonAsyncSetDeliveryTrial";var errorhandler="spcpage.jsonAsyncErrorHandler";var systemerrorhandler="spcpage.jsonAsyncErrorHandler";$.each(trialinputs4topoption,function(index,trialinput){var data=extradata+trialinput.speedparams+"&trialkey="+trialinput.trialkey+"&returnpipedata=1";getData(url,callback,errorhandler,systemerrorhandler,encodeURI(data));spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA[trialinput.trialkey]=null;spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS++;});url="/gp/buy/spc/handlers/set-delivery-options.html/ref=ox_spc_set_trial_ship_option_no_data";$.each(trialinputs,function(index,trialinput){var data=extradata+trialinput.speedparams+"&trialkey="+trialinput.trialkey+"&returnpipedata=0";getData(url,null,null,null,encodeURI(data));});};spcpage.jsonAsyncSetDeliveryTrial=function jsonAsyncSetDeliveryTrial(data){if(spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA&&spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA.hasOwnProperty(data.trialkey)){if(data.pipedata&&spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS>0){spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS--;spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA[data.trialkey]=data.pipedata;if(!spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA_TIMEOUT){spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA_TIMEOUT=setTimeout("spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA = null",60000);}}else{if(spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS>0){spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS--;}}}};spcpage.jsonAsyncErrorHandler=function jsonAsyncErrorHandler(data){if(spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS>0){spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS--;}};spcpage.asyncPayselectData=function asyncPayselectData(){var url="/gp/buy/shared/handlers/continue-prepare.html?from=spc&to=payselect";var callback="spcpage.jsonAsyncPayselectData";var errorhandler="spcpage.jsonAsyncPayselectErrorHandler";var systemerrorhandler="spcpage.jsonAsyncPayselectErrorHandler";spcpage.ASYNC_PAYSELECT_DATA_VALID=true;spcpage.WAITING_FOR_ASYNC_PAYSELECT_DATA=true;if(spcpage.ASYNC_PAYSELECT_DATA_TIMEOUT){clearTimeout(spcpage.ASYNC_PAYSELECT_DATA_TIMEOUT);}getData(url,callback,errorhandler,systemerrorhandler,null);};spcpage.jsonAsyncPayselectData=function jsonAsyncPayselectData(data){if(data.pipedata){spcpage.ASYNC_PAYSELECT_PIPEDATA=data.pipedata;}else{spcpage.ASYNC_PAYSELECT_DATA_VALID=false;}spcpage.WAITING_FOR_ASYNC_PAYSELECT_DATA=false;spcpage.ASYNC_PAYSELECT_DATA_TIMEOUT=setTimeout("spcpage.ASYNC_PAYSELECT_DATA_VALID = false",300000);if(spcpage.CHANGE_PAYMENT_CLICKED){if(data.pipedata){spcpage.actionChangePayment(spcpage.CHANGE_PAYMENT_EVENT);}}};spcpage.jsonAsyncPayselectErrorHandler=function jsonAsyncPayselectErrorHandler(data){spcpage.WAITING_FOR_ASYNC_PAYSELECT_DATA=false;spcpage.ASYNC_PAYSELECT_DATA_VALID=false;if(spcpage.CHANGE_PAYMENT_CLICKED){if(data.pipedata){spcpage.actionChangePayment(spcpage.CHANGE_PAYMENT_EVENT);}}};spcpage.lockerPromo=function lockerPromo(lockerpromo){if(!lockerpromo.enabled){return ;}if(lockerpromo.treatment=="T1"||lockerpromo.treatment=="T2"){if(lockerpromo.nearbystoreids.length>0){var treatment=lockerpromo.treatment.toLowerCase();$("#store-location-counter-"+treatment).html(lockerpromo.nearbystoreids.length);$("#store-ids").val(lockerpromo.nearbystoreids.join());$("#store-search-criterion").val("storeIds");$("#store-zip").val(lockerpromo.zipcode);$("#store-country").val(lockerpromo.countrycode);$("#locker-promo-"+treatment).show();if(lockerpromo.treatment=="T1"){amznJQ.jQuery("#locker-promo-carrot-t1").amazonPopoverTrigger({showOnHover:true,localContent:"#locker-promo-content-t1",width:300,showCloseButton:false,location:"right",attached:true,align:"middle",locationElement:"#locker-promo-carrot-t1",locationOffset:[15,0]});}}}else{if(lockerpromo.treatment=="T3"){$("#locker-promo-t3").show();$("#store-zip").val(lockerpromo.zipcode);$("#store-country").val(lockerpromo.countrycode);$("#store-search-criterion").val("storeZip");}}if(lockerpromo.treatment){var treatment=lockerpromo.treatment.toLowerCase();var action=$("#stores-promo-form").attr("action");action=action.replace("locker_spc_reftag","locker_spc_search_"+treatment);$("#stores-promo-form").attr("action",action);}};spcpage.submitStoresPromoForm=function submitStoresPromoForm(){$("#stores-promo-form").submit();};spcpage.jsonPage=function jsonPage(data){setmarker("x9");if(spcpage.pipedataValidator(data)){return ;}PIPELINE.pipedata=data;spcdiv.unbind("pageloaded.scheduledelivery");var showbottomplaceorder;if(data.pagestate){spcpage.PAGE_STATE=data.pagestate[PIPELINE.nextpage.page];showbottomplaceorder=spcpage.PAGE_STATE.showbottomplaceorder;}spcpage.htmlHidePageLevelElements();if(data.ordersummaryHTML&&data.weblabs.spc.SS_ORDER_SUMMARY=="T1"){$("#spc-order-summary").replaceWith(decodeJSonResponse(data.ordersummaryHTML));if(data.bottombuybuttonHTML){$("#bottom-place-order").html(decodeJSonResponse(data.bottombuybuttonHTML));}}else{if(data.ordersummary){spcpage.jsonOrderSummary(data.ordersummary);$("#spc-order-summary").show();$(".ordersummaryheader").show();$("#os-content-wrapper").show();}}var dupOrderCheckArgs="";var hasAddOnItems=false;var isdigitalpurchase=true;var hasprimeupsellineligibleitem=false;for(var o=0;data.orders&&o<data.orders.length;o++){for(var s=0;data.orders[o].shipments&&s<data.orders[o].shipments.length;s++){for(var i=0;data.orders[o].shipments[s].items&&i<data.orders[o].shipments[s].items.length;i++){var item=data.orders[o].shipments[s].items[i];if(item&&item.asin&&item.quantity&&item.shipaddressid&&item.merchantid){dupOrderCheckArgs+=item.asin+"|"+item.quantity+"|"+item.shipaddressid+"|"+item.merchantid+",";}if(item&&item.isaddon){hasAddOnItems=true;}if(isdigitalpurchase&&item&&!item.isdigital){isdigitalpurchase=false;}if(!hasprimeupsellineligibleitem&&item&&!item.primeupsell){hasprimeupsellineligibleitem=true;}}}}spcpage.PAGE_STATE.dupordercheckargs=dupOrderCheckArgs;spcpage.PAGE_STATE.hasaddonitems=hasAddOnItems;if(data.purchasedelegation&&data.purchasedelegation.isdelegatedpurchase){$("#purchase-shipping-address span[datafield=account]").html(data.purchasedelegation.payingcustomername);$(".pd-personal-account").hide();$(".pd-account-name").show();}if(spcpage.PAGE_STATE.hasaddonitems){spcpage.jsonAddon(data);}setmarker("xa");if(data.shipaddressHTML&&data.weblabs.spc.SS_SHIPPING_ADDRESS=="T1"){$("#purchase-shipping-address").html(decodeJSonResponse(data.shipaddressHTML));}else{if(data.shippingaddress&&data.shippingaddress.ids){spcpage.jsonPurchaseShippingAddresses(data.shippingaddress.ids,data.itemscount.totalitems,data.shippingaddress.html,isdigitalpurchase,data.weblabs);}}setmarker("xb");if(data.billinginformationHTML&&data.weblabs.spc.SS_PAYMENT_METHOD=="T1"){$("#billing-information").html(decodeJSonResponse(data.billinginformationHTML));}else{if(data.billingaddress){spcpage.jsonBillingAddress(data.billingaddress,data.billingaddressHTML,data.weblabs);}setmarker("xc");if(data.paymentmethod){spcpage.jsonPaymentMethod(data.paymentmethod,data.weblabs);}}setmarker("ne");if(data.orders){if(data.pagestate.spc.storemessagingallowed==1){spcpage.htmlDisplayStoreAddressReminder(data.orders);}spcpage.jsonOrders(data.orders,data.shippingaddress.ids.length>1,showbottomplaceorder,isdigitalpurchase,hasprimeupsellineligibleitem);}setmarker("af");setmarker("xf");if(!(data.ordersummaryHTML&&data.weblabs.spc.SS_ORDER_SUMMARY=="T1")){spcpage.jsonNullPromotions(data.nullpromotions);}if(spcpage.PAGE_STATE.productbundleenabled&&data.pbgroupsDisplayHTML){spcdiv.find("#pb-groups").html(decodeJSonResponse(data.pbgroupsDisplayHTML));}setmarker("xg");if(data.messages){spcpage.jsonMessages(data.messages,data.sssmessages,data.orders);}setmarker("xh");if(data.orderingpreferences){spcpage.jsonOrderingPreferences(data.orderingpreferences);}setmarker("xi");if(data.stuff){spcpage.jsonStuff(data.stuff);}if(data.primepagecontent){spcdiv.find("#primepagecontent").html(decodeJSonResponse(data.primepagecontent));}setmarker("cf");if(data.chinainvoice){spcpage.jsonChinaInvoice(data.chinainvoice);}if(data.weblabs&&data.weblabs.spc){for(var weblab in data.weblabs.spc){eval("spcpage."+weblab+"(data.weblabs.spc[weblab])");}}spcpage.bindChangeShippingAndBillingAddressActions();spcpage.bindChangeQuantityActions();setmarker("xk");spcpage.uiDashboardSpinner(false);setmarker("xl");eventPageLoaded();if(PIPELINE.initialspcpageload){$(window).load(function(){setTimeout("spcpage.windowReadyEvents()",100);});}else{spcpage.windowReadyEvents();}PIPELINE.initialspcpageload=false;};spcpage.bindChangeShippingAndBillingAddressActions=function bindChangeShippingAndBillingAddressActions(treatment){$("#purchase-shipping-address .single-address .changelink").attr("href","#").unbind("click").bind("click",spcpage.actionChangeShippingAddress);$("#purchase-shipping-address .single-address-changelink-t1").attr("href","#").unbind("click").bind("click",spcpage.actionChangeShippingAddress);$("#billing-information .single-address .changelink").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddressPopover);$("#billing-information .duplicate-address .changelink").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddressPopover);};spcpage.bindChangeQuantityActions=function bindChangeQuantityActions(){var quantity=spcdiv.find(".quantity");quantity.find(".changelink[mode=quantity-display]").attr("href","#").bind("click",spcpage.actionClickChangeQuantity);quantity.find(".changelink[name=updateQuantity]").attr("href","#").bind("click",spcpage.actionUpdateQuantity);quantity.find(".changelink[name=removeItem]").attr("href","#").bind("click",spcpage.actionRemoveItem);spcpage.createDynamicValidators();quantity.find("input[name=quantity][mode=quantity-edit]").bind("keyup",function(e){var preventKeyUp=quantity.data("preventKeyUp");if(e.which==13&&(!preventKeyUp||preventKeyUp!="true")){quantity.find(".changelink[name=updateQuantity]").trigger("click");}});quantity.find("input[name=quantity]").bind("keydown",function(e){if(e.which==13){quantity.data("preventKeyUp","false");e.preventDefault();}});quantity.find(".changelink[mode=quantity-display]").bind("keydown",function(e){if(e.which==13){quantity.data("preventKeyUp","true");}});};spcpage.windowReadyEvents=function windowReadyEvents(){spcdiv.trigger("pageloaded");$("#checkoutpage").attr("pagename","singlepagecheckout").attr("version","2");if(spcpage.PAGE_STATE.showcsrepscripts){$("#csphone-app-order").show();$("#csphone-app-order-1").show();$("#csphone-app-order-2").show();$("#csphone-app-order-3").show();$("#csphone-app-order-4").show();}requestStaticContent("/gp/buy/pipeline/payselect.html","payselect");if(PIPELINE.pipedata&&PIPELINE.pipedata.weblabs&&PIPELINE.pipedata.weblabs.spc&&PIPELINE.pipedata.weblabs.spc.CHECKOUT_10180=="T1"){requestStaticContent("/gp/buy/pipeline/billingaddrselect.html","billingaddressselect");}if(amznJQ.available("ShownPresentationsLogger",function(){if(ShownPresentationsLogger.logShownPresentations&&typeof (ShownPresentationsLogger.logShownPresentations)=="function"){ShownPresentationsLogger.logShownPresentations();}})){}spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA=null;if(PIPELINE.pipedata.orders[0].trialshippingspeeds){spcpage.asyncSetDeliveryTrial();}spcpage.ASYNC_PAYSELECT_PIPEDATA=null;if(spcpage.ASYNC_PAYSELECT_PREFETCH){spcpage.asyncPayselectData();}if(PIPELINE.pipedata.spccobrandad&&PIPELINE.pipedata.spccobrandad.ad){spcpage.spccobrandad=PIPELINE.pipedata.spccobrandad;setTimeout("spcpage.jsonSpcCobrandAd()",500);}if(spcpage.PAGE_STATE.isbbq){bbqCacheCurrentPage("spc",data);}if(PIPELINE.pipedata.lockerpromo){spcpage.lockerPromo(PIPELINE.pipedata.lockerpromo);}if(PIPELINE.pipedata.shadowtestpagetype=="spc"){var url="/gp/buy/pipeline/handlers/json-pipedata.html";var extradata="page=spc&shadowModePairingId="+PIPELINE.pipedata.shadowmodepairingid;getData(url,null,null,null,extradata);}$("#spc-points-entry").hide();$("#spc-points-unregistered").hide();$("#spc-points-errorblock").hide();$("#spc-points-balance").hide();$("#spc-points").hide();$("#spc-points-footer").hide();$("#spc-points-applied").hide();if(spcpage.treatment_9393){$("#spc-points-entry input.apply").parent().parent().hide();$("#spc-points-entry input.update").parent().parent().hide();}else{$("#spc-points-entry input.apply").hide();$("#spc-points-entry input.update").hide();}if(PIPELINE.pipedata.points&&PIPELINE.pipedata.points.creditcardpaymentmethodid&&PIPELINE.pipedata.points.creditcard){var cc=PIPELINE.pipedata.points.creditcard;if(cc.rewardsaccount){if(cc.rewardsaccount.displaydata){var htmdatafields=$("#spc-points-entry").find("[datafield]");for(var stringKey in cc.rewardsaccount.displaydata){htmdatafields.filter("[datafield="+stringKey+"]").html(cc.rewardsaccount.displaydata[stringKey]);}}spcpage.REWARDS_DATA=PIPELINE.pipedata.points;if(cc.rewardsaccount.constraintviolation=="RewardAccountZeroBalanceConstraintViolation"){cc.rewardsaccount.maxusabledollars="0.00";cc.rewardsaccount.dollarbalance="0.00";cc.rewardsaccount.registered=1;cc.rewardsaccount.pointsbalance="0";cc.rewardsaccount.rewardsdecimalplaces=0;}if(cc.rewardsaccount.registered){var points=PIPELINE.pipedata.points.rewardaccountamountformatted?PIPELINE.pipedata.points.rewardaccountamountformatted:getNumberWithSeparators(cc.rewardsaccount.maxusabledollars,2);if(points>0){if(PIPELINE.pipedata.points.rewardaccountamountformatted){$("#spc-points-applied").show();}else{if(spcpage.treatment_9393){$("#spc-points-entry input.apply").parent().parent().show();}else{$("#spc-points-entry input.apply").show();}}if(cc.rewardsaccount.pointsbalance>0){$("#spc-points-footer").show();$("#spc-points").show();}if(spcpage.treatment_9393){$("#spc-points-entry input.update").parent().parent().hide();}}$("#spc-points-available").html(getNumberWithSeparators(cc.rewardsaccount.pointsbalance,cc.rewardsaccount.rewardsdecimalplaces));$("#spc-points-available-in-currency").html(getAmountWithCurrency(cc.rewardsaccount.dollarbalance));$("#spc-points-entry .currency").html(getCurrencySymbol());$("#spc-points-input").val(points);$("#spc-points-balance").show();$("#spc-points-raw-points").html(spcpage.convertDollarsToPoints(points));$("#spc-points-entry").show();if(typeof this.spc_points_entry_input=="undefined"){$("#spc-points-input").width($("#spc-points-input").width()-$("#spc-points .currency").width());this.spc_points_entry_input=1;}}else{if(cc.rewardsaccount.hasconstraintviolation){}else{if(!cc.rewardsaccount.registered){$("#spc-points-unregistered").show();$("#spc-points-entry").show();}else{$("#spc-points-balance").show();$("#spc-points-entry").show();}}}}}};spcpage.convertDollarsToPoints=function convertDollarsToPoints(dollars){var decimalPlaces=0;if(spcpage.REWARDS_DATA.creditcard.rewardsaccount.rewardsdecimalplaces){decimalPlaces=spcpage.REWARDS_DATA.creditcard.rewardsaccount.rewardsdecimalplaces;}return getNumberWithSeparators((dollars/spcpage.REWARDS_DATA.creditcard.rewardsaccount.conversionratio),decimalPlaces);};spcpage.jsonConfirmPurchase=function jsonConfirmPurchase(data){var extradata="?pageType="+spcpage.PAGE_STATE.pagetype;var url;if(data.phone==1){url="/gp/phoneorders/ordering/checkout/wrapup-contact.html";extradata+="&phoneOrder="+data.phone;extradata+="&orderList="+data.orderids.join("&orderList=");}else{if($("#needsThirdPartyRedirect").val()==1){url="/gp/buy/thirdparty/handlers/display.html";var paymentdisplayname=$("#paymentDisplayName").attr("value");extradata+="&paymentDisplayName="+paymentdisplayname;}else{if(data.ismetro){url="/gp/am/metro/checkout/success";}else{url="/gp/buy/thankyou/handlers/display.html";}}}if(data.asins&&data.orderids){extradata+="&orderId="+data.orderids.join("&orderId=")+"&asins="+data.asins.join("&asins=");}if(data.purchaseid){extradata+="&purchaseId="+data.purchaseid;}var count=0;$.each(PIPELINE.pipedata.orders,function(i,order){var shipments=order.shipments;$.each(shipments,function(i,shipment){if(shipment.promise&&shipment.promise.fasttrack&&shipment.promise.fasttrack.deliveryGuaranteeInSecondsSinceEpoch){var deliveryGuaranteeInSecondsSinceEpoch=shipment.promise.fasttrack.deliveryGuaranteeInSecondsSinceEpoch;$.each(shipment.items,function(i,item){var asin=item.asin;extradata+="&promiseTime-"+count+"="+deliveryGuaranteeInSecondsSinceEpoch;extradata+="&promiseAsin-"+count+"="+asin;count++;});}});});extradata+="&promiseType=spc";window.location.href=url+extradata;};spcpage.closeAddonPopover=function closeAddonPopover(){if(spcpage.addonpopover){spcpage.addonpopover.close();spcpage.addonpopover=null;}};spcpage.jsonAddon=function jsonAddon(data){if(data.addonwarning){spcpage.closeAddonPopover();$(".addon-warning").remove();if(data.addonwarning.normal){$("#addon-wrapper").append(data.addonwarning.normal);}if(data.addonwarning.special){$("#addon-wrapper").append(data.addonwarning.special);}}};spcpage.jsonPrimeChangeCardNoEndDate=function jsonPrimeChangeCardNoEndDate(data){spcpage.disableOrderSpinner();spcpage.jsonPage(data.pipedata);};spcpage.jsonPrimeChangeCardNoEndDateError=function jsonPrimeChangeCardNoEndDateError(errors){spcpage.disableOrderSpinner();spcpage.enableBuyButton();};spcpage.actionPrimeChangeCardNoEndDate=function actionPrimeChangeCardNoEndDate(event){uiScrollToTop();spcpage.showOrderSpinner(event);var url="/gp/buy/spc/handlers/stuff-handler.html/ref=ox_spc_prime_renew_nodate";var callback="spcpage.jsonPrimeChangeCardNoEndDate";var errorhandler="spcpage.jsonPrimeChangeCardNoEndDateError";var systemerrorhandler="generalErrorHandling";var extradata="changeCardNoEndDatePrime=1";getData(url,callback,errorhandler,systemerrorhandler,extradata);};spcpage.jsonPrimeChangeCardShowEndDate=function jsonPrimeChangeCardShowEndDate(data){spcpage.jsonPage(data.pipedata);};spcpage.jsonPrimeChangeCardShowEndDateError=function jsonPrimeChangeCardShowEndDateError(errors){};spcpage.actionPrimeChangeCardShowEndDate=function actionPrimeChangeCardShowEndDate(event){uiScrollToTop();var url="/gp/buy/spc/handlers/stuff-handler.html/ref=ox_spc_prime_renew_showdate";var callback="spcpage.jsonPrimeChangeCardShowEndDate";var errorhandler="spcpage.jsonPrimeChangeCardShowEndDateError";var systemerrorhandler="generalErrorHandling";var extradata="changeCardShowEndDatePrime=1";getData(url,callback,errorhandler,systemerrorhandler,extradata);};spcpage.jsonAddGiftPromotion=function jsonAddGiftPromotion(data){setmarker("be");$("#spc-gc_entry img.loading-small").hide();if(spcpage.treatment_9393){$("#spc-gc_entry input.apply").parent().parent().show();}else{$("#spc-gc_entry input.apply").show();}spcpage.jsonPage(data.pipedata);$("#spc-gcpromoinput").val("");};spcpage.jsonApplyPoints=function jsonApplyPoints(data){setmarker("be");$("#spc-points-entry img.loading-small").hide();$("#spc-points-applied").show();spcpage.jsonPage(data.pipedata);spcpage.enableBuyButton();};spcpage.jsonAddGiftPromotionError=function jsonAddGiftPromotionError(errors){setmarker("be");$("#spc-gc_entry img.loading-small").hide();if(spcpage.treatment_9393){$("#spc-gc_entry input.apply").parent().parent().show();}else{$("#spc-gc_entry input.apply").show();}spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY.addErrors(errors);eventPageLoaded();};spcpage.jsonApplyPointsError=function jsonApplyPointsError(errors){setmarker("be");$("#spc-points-entry img.loading-small").hide();if(spcpage.treatment_9393){$("#spc-points-entry input.apply").parent().parent().show();}else{$("#spc-points-entry input.apply").show();}spcpage.POINTS_ERROR_AUTHORITY.addErrors(errors);eventPageLoaded();spcpage.enableBuyButton();};spcpage.actionAddGiftPromotion=function actionAddGiftPromotion(event){spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY.runAllValidators(true);if(!spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY.hasErrors()){var claimcode=encodeURIComponent($("#spc-gcpromoinput").val());$("#spc-gcpromoerrorblock").hide();var url="/gp/buy/spc/handlers/add-giftcard-promotion.html/"+getRefTag($(event.target));var callback="spcpage.jsonAddGiftPromotion";var errorhandler="spcpage.jsonAddGiftPromotionError";var systemerrorhandler="generalErrorHandling";var extradata="claimcode="+claimcode;logEvents.enqueue(new LogEntry(logEvents.CLICKED,spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY.section.attr("id"),[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);if(spcpage.treatment_9393){$("#spc-gc_entry input.apply").parent().parent().hide();}else{$("#spc-gc_entry input.apply").hide();}$("#spc-gc_entry img.loading-small").show();}};spcpage.actionApplyPoints=function actionApplyPoints(event){$("#spc-points-errorblock").hide();spcpage.POINTS_ERROR_AUTHORITY.runAllValidators(true);if(spcpage.POINTS_ERROR_AUTHORITY.hasErrors()){return ;}var pd=PIPELINE.pipedata;var paymentMethodId=pd.points&&pd.points.creditcardpaymentmethodid?pd.points.creditcardpaymentmethodid:"";var paymentMethodType="";var rewardsAccountId="";var rewardsAmount=$("#spc-points-input").val();var rewardsRate="";var useGCBalance=pd.paymentmethod.giftcertificate?pd.paymentmethod.giftcertificate:"";var cc=pd.points.creditcard;if(cc&&cc.paymentmethodid==paymentMethodId){rewardsAccountId=cc.rewardsaccount.paymentmethodid;rewardsRate=cc.rewardsaccount.conversionratio;paymentMethodType=cc.paymentmethodtype;}var url="/gp/buy/pipeline/handlers/update-reward-points.html/"+getRefTag($(event.target));var callback="spcpage.jsonApplyPoints";var errorhandler="spcpage.jsonApplyPointsError";var systemerrorhandler="generalErrorHandling";var extradata="paymentMethodId="+paymentMethodId+"&paymentMethodType="+paymentMethodType+"&rewardAccountId="+rewardsAccountId+"&rewardAccountAmount="+rewardsAmount+"&rewardAccountRate="+rewardsRate+"&useGCBalance="+useGCBalance+"&usePromoBalance="+useGCBalance+"&returnjson=1&returnpipedata=1"+"&hasWorkingJavascript=1";getData(url,callback,errorhandler,systemerrorhandler,extradata);if(spcpage.treatment_9393){$("#spc-points-entry input.apply").parent().parent().hide();$("#spc-points-entry input.update").parent().parent().hide();}else{$("#spc-points-entry input.apply").hide();$("#spc-points-entry input.update").hide();}$("#spc-points-entry img.loading-small").show();spcpage.showOrderSpinner(event);spcpage.disableBuyButton();};spcpage.actionRegisterRewardsConfigure=function actionRegisterRewardsConfigure(event){spcpage.REWARDS_REGISTRATION={};spcpage.REWARDS_REGISTRATION.step="loading";event.preventDefault();var issuerid=spcpage.REWARDS_DATA.creditcard.rewardsaccount.issuerid;var programid=spcpage.REWARDS_DATA.creditcard.rewardsaccount.programid;amznJQ.onReady("popover",function(){amznJQ.jQuery.AmazonPopover.displayPopover({title:$("#rewards-registration-title").text(),localContent:"#rewards-registration-lightbox",width:500,zIndex:1000,showOnHover:false,modal:true,clone:true,draggable:false,showCloseButton:true,location:"centered",closeText:$("#rewards-popover-close").text(),closeEventExclude:"CLICK_OUTSIDE",group:"RewardsRegistration",onHide:spcpage.actionRegisterRewardsClose});});var htm=$("#rewards-registration-lightbox");htm.attr("issuerid",issuerid);htm.attr("programid",programid);htm.attr("parentpaymentmethodid",spcpage.REWARDS_DATA.creditcard.paymentmethodid);htm.show();htm.find("[name='rewardsname']").val(spcpage.REWARDS_DATA.creditcard.name);var expirationDateRegex=new RegExp("[0-9]{2}"+String.fromCharCode(92)+"/[0-9]{4}");var expirationDate=spcpage.REWARDS_DATA.creditcard.expiration;if(expirationDate){var expirationSplit=expirationDate.split("/");var expirationMonth=expirationSplit[0];var expirationYear=expirationSplit[1];htm.find("[name='rewardsexpdate']").attr("value",expirationYear+"-"+expirationMonth);}htm.find("#rewards-registration-main [name='rewardssignup']").bind("click",spcpage.actionRegisterRewardsSignup);amznJQ.available("popover",function(){amznJQ.jQuery(htm.find(".cvv2help")).amazonPopoverTrigger({localContent:htm.find(".cvv2helpcontent"),zIndex:1000,showOnHover:true,width:250,height:150,modal:false,clone:false,draggable:false,showCloseButton:false,location:"auto"});});htm.find("#rewards-registration-loading .loading-large").show();htm.find("#rewards-registration-loading").show();var url="/gp/buy/payselect/handlers/get-rewards-configuration.html";var extradata="programid="+programid+"&partner="+issuerid+"&ccpaymentinstrumentid="+spcpage.REWARDS_DATA.creditcard.paymentmethodid+"&issuer="+spcpage.REWARDS_DATA.creditcard.issuer+"&brand="+spcpage.REWARDS_DATA.creditcard.brand;var callback="spcpage.jsonRegisterRewardsConfigure";var errorhandler="spcpage.jsonRegisterRewardsError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);spcpage.REWARDS_REGISTRATION.popover=htm;logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_learnmore",[]));};spcpage.actionRegisterRewardsClose=function actionRegisterRewardsClose(trigger,popover){if(spcpage.REWARDS_REGISTRATION.step=="success"){spcpage.refreshPage();}spcpage.REWARDS_REGISTRATION=null;logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_close",[]));};spcpage.actionRegisterRewardsSignup=function actionRegisterRewardsSignup(event){var htm=spcpage.REWARDS_REGISTRATION.popover.children("#rewards-registration-main");htm.hide();htm.siblings("#rewards-registration-intermission").find(".loading-large").show();htm.siblings("#rewards-registration-intermission").show();var extradata="programid="+encodeURIComponent(htm.parent().attr("programid"));extradata+="&paymentinstrumentid="+encodeURIComponent(htm.parent().attr("parentpaymentmethodid"));var datafields=htm.find("[datafield]");datafields.each(function(){if($(this).attr("datafield")=="CVV2"){extradata+="&registerRewardsCreditCardVerificationNumber="+encodeURIComponent($(this).val());}else{if($(this).attr("datafield")=="TERMS_AND_CONDITIONS"){if($(this).is(":checked")){extradata+="&"+$(this).attr("datafield")+"=true";}}else{extradata+="&"+$(this).attr("datafield")+"="+encodeURIComponent($(this).val());}}});var url="/gp/buy/payselect/handlers/register-rewards-account.html";var callback="spcpage.jsonRegisterRewardsSignup";var errorhandler="spcpage.jsonRegisterRewardsError";var systemerrorhandler="generalErrorHandling";logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_intermission",[]));getData(url,callback,errorhandler,systemerrorhandler,extradata);spcpage.REWARDS_REGISTRATION.step="intermission";};spcpage.jsonRegisterRewardsSignup=function jsonRegisterRewardsSignup(data){var htm=spcpage.REWARDS_REGISTRATION.popover;var successhtm=htm.find("#rewards-registration-success");successhtm.find(".customername").text(data.customername);if(data.dollarbalance&&data.pointsbalance){successhtm.find("[datafield='rewardsamount']").html(getAmountWithCurrency(data.dollarbalance));successhtm.find("[datafield='pointsamount']").html(getNumberWithSeparators(data.pointsbalance,data.rewardsdecimalplaces));successhtm.find(".rewardsuccessbalance").show();}if(data.showwarnmessage){successhtm.find(".warnmessage").show();}htm.find("#rewards-registration-intermission").hide();successhtm.show();spcpage.NEW_PAYMENT_METHOD_ID=htm.attr("parentpaymentmethodid");spcpage.REWARDS_REGISTRATION.step="success";};spcpage.jsonRegisterRewardsConfigure=function jsonRegisterRewardsConfigure(data){var htm=spcpage.REWARDS_REGISTRATION.popover.children("#rewards-registration-main");htm.siblings("#rewards-registration-loading").hide();var programid=htm.parents("[programid]").attr("programid");for(var i in data.fields){var element=data.fields[i];var datafield=htm.find("[datafield='"+element.type+"']");if(element.value){datafield.filter("input").attr("value",element.value);}datafield.parents(".rewardsfield").show();}if(data.termshtml){htm.find(".rewardstermstext").html(decodeJSonResponse(data.termshtml));}if(data.billingzip){htm.find("[datafield=BILLING_POSTAL_CODE]").attr("value",data.billingzip);}if(data.displaydata){var datafieldhtm=spcpage.REWARDS_REGISTRATION.popover.find("[datafield]");for(var stringKey in data.displaydata){datafieldhtm.filter("[datafield="+stringKey+"]").html(data.displaydata[stringKey]);}}if(data.marketinglink){htm.find("[datafield='rewards_marketing_link']").html(data.marketinglink);}htm.show();spcpage.REWARDS_REGISTRATION.step="main";logEvents.enqueue(new LogEntry(logEvents.CLICKED,"rewards_main",[]));};spcpage.jsonRegisterRewardsError=function jsonRegisterRewardsError(error){var htm=spcpage.REWARDS_REGISTRATION.popover;htm.children("div").hide();var errorhtm=htm.children("#rewards-registration-error");if(error===null){errorhtm.find("[error='rewards_SystemUnavailable']").show();}else{errorhtm.find("[error='"+error+"']").show();}errorhtm.show();spcpage.REWARDS_REGISTRATION.step="error";logEvents.enqueue(new LogEntry(logEvents.SERVER_SIDE_VALIDATION,"registerRewardsError-"+error));};spcpage.actionUpdatePointsDisplay=function actionUpdatePointsDisplay(event){switch(event.keyCode?event.keyCode:event.which){case 13:case 10:if((spcpage.treatment_9393&&($("#spc-points-entry input.update").parent().parent().is(":visible")||$("#spc-points-entry input.apply").parent().parent().is(":visible")))||$("#spc-points-entry input.update").is(":visible")||$("#spc-points-entry input.apply").is(":visible")){spcpage.actionApplyPoints(event);}break;}var pointsEntry=$(this).val();var oldPoints=$("#spc-points-raw-points").html();if(!(/^\s*$/).test(pointsEntry)&&!isNaN(pointsEntry)&&pointsEntry>0){var points=spcpage.convertDollarsToPoints(pointsEntry);$("#spc-points-raw-points").html(points);}else{$("#spc-points-raw-points").html("0");}if($("#spc-points-applied").is(":visible")&&oldPoints!=$("#spc-points-raw-points").html()){$("#spc-points-applied").hide();if(spcpage.treatment_9393){$("#spc-points-entry input.apply").parent().parent().hide();$("#spc-points-entry input.update").parent().parent().show();}else{$("#spc-points-entry input.apply").hide();$("#spc-points-entry input.update").show();}}};spcpage.actionSaveDefaults=function actionSaveDefaults(event){var url="/gp/buy/spc/handlers/set-ordering-preferences.html";var extradata="";getData(url,null,null,null,extradata);};spcpage.actionConfirmPurchase=function actionConfirmPurchase(event){spcdiv.find("div[buybuttondiv='notfx']").hide();spcdiv.find("div[buybuttondiv='fx']").hide();spcdiv.find("div[buybuttondiv='spinner']").show();if(($("#save-defaults-box:visible").length&&$("#save-defaults-box").find("input:checked").length)||$("#save-defaults-box").find("input[name='isfirsttimecustomer']").val()==1){spcpage.actionSaveDefaults(event);}var url="/gp/buy/spc/handlers/place-your-order.html";var extradata="oneClickASIN="+(spcpage.PAGE_STATE.oneclickasin?spcpage.PAGE_STATE.oneclickasin:"")+"&purchaseTotal="+(spcpage.PAGE_STATE.purchasetotal?spcpage.PAGE_STATE.purchasetotal:"")+"&purchaseTotalCurrency="+(spcpage.PAGE_STATE.purchasetotalcurrency?spcpage.PAGE_STATE.purchasetotalcurrency:"")+"&dupOrderCheckArgs="+(spcpage.PAGE_STATE.dupordercheckargs?spcpage.PAGE_STATE.dupordercheckargs:"");if($("#needsThirdPartyRedirect").val()==1){extradata+="&needsThirdPartyRedirect=1";}if($("#paymentDisplayName").attr("value")){var paymentDisplayName=$("#paymentDisplayName").val();extradata+="&paymentDisplayName="+paymentDisplayName;}var groupcount=0;spcdiv.find("div[order='copy']").each(function(i,order){var orderid=$(this).attr("orderid");if(orderid&&$(this).find("input[name='order."+orderid+".deliveryTimePreference'][type='radio']:checked")){var currentShippingSpeed=$(this).find("input[name='currentshippingspeed']").attr("value");var currentShipSplitPreference=$(this).find("input[name='currentshipsplitpreference']").attr("value");var speed=$(this).find("[shipping-speed='copy']").find("input[src*=radio-on]");if(speed.length){extradata+="&shippingofferingid"+groupcount+"="+speed.attr("shippingofferingid");extradata+="&guaranteetype"+groupcount+"="+speed.attr("guaranteetype");var splitpref=$(this).find("[name='shipment-splitting']").find("input[src*=radio-on]");var splitval="shipWhenComplete";if(splitpref.length==1){splitval=splitpref.attr("value");}extradata+="&shippriority"+groupcount+"="+splitval;extradata+="&lineitemids"+groupcount+"="+$(this).find("input[name='orderlineitemids']").attr("value");extradata+="&deliverytimepreference"+groupcount+"="+($(this).find("input[name='order."+orderid+".deliveryTimePreference'][type='radio']:checked").attr("value")||"");extradata+="&deliveryinstructions"+groupcount+"="+($(this).find("input[name='order."+orderid+".deliveryInstructionRemark']").attr("value")||"");groupcount++;if(speed.attr("isscheduledelivery")=="1"){var hiddeninputs=$(this).find("[id^=sd_widgets_] input[type=hidden]");$.each(hiddeninputs,function(i,hiddeninput){var element=$(hiddeninput);extradata+="&"+element.attr("name")+"="+element.attr("value");});}}}});extradata+="&groupcount="+groupcount;var currencySwitcher=$("#tfx-currency-switcher").find("input:radio:checked");if(currencySwitcher.length>0){if($("#currencyChanged").attr("value")=="true"){extradata+="&currencySelection="+currencySwitcher.attr("value");}}else{currencySwitcher=$("#tfx-currency-switcher").find("input[src*=radio-on]");if(currencySwitcher.length>0){if($("#currencyChanged").attr("value")=="true"){extradata+="&currencySelection="+currencySwitcher.attr("data-currency-type");}}}var callback="spcpage.jsonConfirmPurchase";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";if($("#china-invoice-required").size()>0){if($("#china-invoice-required").attr("checked")){extradata+="&needChinaInvoice=1"+"&chinaInvoiceTitle="+$("#china-invoice-title").attr("value")+"&chinaInvoiceCategoryID="+$("#china-invoice-category").attr("value");if($("#china-invoice-as-default").attr("checked")){extradata+="&saveAsDefaultChinaInvoice=1";}}}if(spcpage.PAGE_STATE.CONFIRM_POST){var count=0;$.each(PIPELINE.pipedata.orders,function(i,order){var shipments=order.shipments;$.each(shipments,function(i,shipment){if(shipment.promise&&shipment.promise.fasttrack&&shipment.promise.fasttrack.deliveryGuaranteeInSecondsSinceEpoch){var deliveryGuaranteeInSecondsSinceEpoch=shipment.promise.fasttrack.deliveryGuaranteeInSecondsSinceEpoch;$.each(shipment.items,function(i,item){var asin=item.asin;extradata+="&promiseTime-"+count+"="+deliveryGuaranteeInSecondsSinceEpoch;extradata+="&promiseAsin-"+count+"="+asin;count++;});}});});extradata+="&promiseType=spc";return spcpage.confirmPurchaseSubmit(extradata);}getData(url,callback,errorhandler,systemerrorhandler,extradata);};spcpage.confirmPurchaseSubmit=function confirmPurchaseSubmit(args){var url="/gp/buy/spc/handlers/place-your-order-submit.html";var formHtm='<form id="confirmForm" name="confirmForm" action="'+url+'" method="POST">';var argsArray=args.split("&");for(var i=0;i<argsArray.length;i++){var params=argsArray[i].split("=");formHtm+='<input name="'+params[0]+'" value="'+params[1]+'" type="hidden" />';}formHtm+="</form>";spcdiv.append(formHtm);$("#confirmForm").submit();};spcpage.actionChangePaymentWrapper=function actionChangePaymentWrapper(event){event.preventDefault();if(spcpage.ASYNC_PAYSELECT_PREFETCH){spcpage.uiDashboardSpinner(true);setscope(ASYNCSCOPE);setctb();resetue();}spcpage.actionChangePayment(event);};spcpage.actionChangePayment=function actionChangePayment(event){if(spcpage.PAGE_STATE.isbbq){setBbqPage("payselect");}else{PIPEDATA_RETURN_RID="1";PIPELINE.pipedata=null;if(spcpage.WAITING_FOR_ASYNC_PAYSELECT_DATA){spcpage.CHANGE_PAYMENT_CLICKED=true;spcpage.CHANGE_PAYMENT_EVENT=event;return ;}spcpage.CHANGE_PAYMENT_CLICKED=false;spcpage.CHANGE_PAYMENT_EVENT=null;if(spcpage.ASYNC_PAYSELECT_DATA_VALID&&spcpage.ASYNC_PAYSELECT_PIPEDATA){PIPELINE.pipedata=spcpage.ASYNC_PAYSELECT_PIPEDATA;}gotoPage("payselect");}};spcpage.actionChangeBillingAddress=function actionChangeBillingAddress(event){event.preventDefault();if(spcpage.PAGE_STATE.isbbq){setBbqPage("billingaddressselect");}else{PIPEDATA_RETURN_RID="1";PIPELINE.pipedata=null;gotoPage("billingaddressselect");}};spcpage.actionChangeBillingAddressPopover=function actionChangeShippingAddressPopover(event){event.preventDefault();ordereditpopover.startLoading();ordereditpopover.showBillingAddressPopover();var url="/gp/buy/pipeline/handlers/billing-address-select-content.html";var callback="ordereditpopover.jsonBillingAddressPopover";var errorhandler="ordereditpopover.jsonBillingAddressPopoverError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,null);};spcpage.jsonUpdateBillingAddress=function jsonUpdateBillingAddress(data){if(data&&!data.isSameAddress){if(data.isSameAsShipping){$("#billing-information .single-address").hide();var htm=$("#billing-information .duplicate-address");htm.find(".changelink").hide();if(data.isChangeLinkRelocationWebLabOn){htm.find(".duplicate-billing-address-change-t1").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddressPopover).show();}else{htm.find("#duplicate-billing-address-change").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddressPopover).show();}htm.show();}else{if(data.addressHTML){$("#billing-information .duplicate-address").hide();var htm=$("#billing-information .single-address");$("#billing-information [datafield='address']").html(data.addressHTML);htm.find(".changelink").hide();if(data.isChangeLinkRelocationWebLabOn){htm.find(".single-billing-address-change-t1").attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddressPopover).show();}else{htm.find("li:last").append("&nbsp;").append(htm.find("#single-billing-address-change").clone().attr("href","#").unbind("click").bind("click",spcpage.actionChangeBillingAddressPopover).show());}htm.show();}}}ordereditpopover.stopLoading();ordereditpopover.hidePopover();eventPageLoaded();};spcpage.actionChangeShippingAddress=function actionChangeShippingAddress(event){ordereditpopover.startLoading();ordereditpopover.showShippingAddressPopover();var url="/gp/buy/pipeline/handlers/shipping-address-select-content.html";var callback="ordereditpopover.jsonShippingAddressPopover";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,null);};spcpage.jsonUpdateShippingAddress=function jsonUpdateShippingAddress(data){if(data&&data.pipedata&&spcpage.pipedataValidator(data.pipedata)){return ;}if(data&&!data.isSameAddress&&data.pipedata){spcpage.jsonPage(data.pipedata);}else{eventPageLoaded();}ordereditpopover.stopLoading();ordereditpopover.hidePopover();};spcpage.disableBuyButton=function disableBuyButton(issetshipoption){var placeOrderButton=spcdiv.find("div[buybuttondiv$=fx]").find("input");if(issetshipoption){placeOrderButton.attr("issetshipoption",1);}placeOrderButton.addClass("disabled-button").fadeTo("fast",0.33).unbind("click");};spcpage.actionChangeGiftOptionsPopover=function actionChangeGiftOptionsPopover(event){event.preventDefault();ordereditpopover.startLoading();ordereditpopover.showGiftPopover();var extradata="?";if(event&&event.data&&event.data.obfuscatedEntityId){extradata+="obfuscatedEntityId="+event.data.obfuscatedEntityId;}var url="/gp/buy/pipeline/handlers/gift-select-content.html"+extradata;var callback="ordereditpopover.jsonGiftPopover";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,null);};spcpage.jsonUpdateGift=function jsonUpdateGift(data){if(data&&data.pipedata&&spcpage.pipedataValidator(data.pipedata)){return ;}if(data&&!data.noChange&&data.pipedata){spcpage.jsonPage(data.pipedata);}else{eventPageLoaded();}ordereditpopover.stopLoading();ordereditpopover.hidePopover();};spcpage.enableBuyButton=function enableBuyButton(setshipoptiondone){var placeOrderButton=spcdiv.find("div[buybuttondiv$=fx]").find("input");if(setshipoptiondone){placeOrderButton.removeAttr("issetshipoption");}placeOrderButton.removeClass("disabled-button").fadeTo("fast",1);spcdiv.find("div[buybuttondiv='notfx']").find("input").css("filter","");spcdiv.find("div[buybuttondiv='fx']").find("input").css("filter","");spcdiv.find("div[buybuttondiv='notfx']").find("input").unbind("click").bind("click",spcpage.actionConfirmPurchase);spcdiv.find("div[buybuttondiv='fx']").find("input").unbind("click").bind("click",spcpage.actionConfirmPurchase);};spcpage.jsonSetShipOptionsError=function jsonSetShipOptionsError(errors){setmarker("be");spcpage.disableOrderSpinner();spcpage.enableBuyButton(true);eventPageLoaded();};spcpage.jsonSetShipOptions=function jsonSetShipOptions(data){spcpage.enableBuyButton(true);if(data.success&&data.trialkey&&spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA&&spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA[data.trialkey]){setmarker("be");spcpage.jsonPage(spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA[data.trialkey]);}else{if(data.pipedata){setmarker("be");spcpage.jsonPage(data.pipedata);}else{spcpage.disableOrderSpinner();eventPageLoaded();}}};spcpage.scheduledDeliveryEnableSOCallback=function scheduledDeliveryEnableSOCallback(data){};spcpage.scheduledDeliverySetSOCallback=function scheduledDeliverySetSOCallback(data,id){spcpage.actionSetShipOptions(null,id,data);};spcpage.actionSetShipOptions=function actionSetShipOptions(event,scheduleddeliverywidgetid,scheduleddeliverydata){var targetbutton;if(event){spcpage.showOrderSpinner(event);targetbutton=$(event.target);}else{var widget=spcdiv.find("#"+scheduleddeliverywidgetid);if(widget.length){spcpage.showOrderSpinner(widget);}else{return ;}targetbutton=widget.parents("tr[shipping-speed=copy]").find("input[src*=radio]:image");}var targetorderid=targetbutton.parents("div[order=copy]").attr("orderid");var extradata="";spcpage.disableBuyButton(true);var shipments=spcdiv.find("div[order='copy']");var groupcount=0;$.each(shipments,function(i,shipment){var htm=$(shipment);var input="";var currentShippingSpeed=htm.find("input[name='currentshippingspeed']").attr("value");var currentShipSplitPreference=htm.find("input[name='currentshipsplitpreference']").attr("value");if(shipments.length==1){extradata+="&oldoption="+currentShippingSpeed+"."+currentShipSplitPreference;}var speeds=htm.find("[shipping-speed='copy']");var speed=speeds.find("input[src*=radio-on]");var splitpref=htm.find("[name='shipment-splitting']").find("input[src*=radio-on]");if(splitpref.length!=1){splitpref=null;}if(targetorderid==$(shipment).attr("orderid")){if(targetbutton.attr("shippingofferingid")){speed=targetbutton;}else{splitpref=targetbutton;}if(shipments.length==1){input+="&option="+speed.attr("value")+"."+splitpref.attr("value");}}input+="&lineitemids"+groupcount+"="+htm.find("input[name='orderlineitemids']").attr("value");if(speed.length){input+="&shippingspeed"+groupcount+"="+speed.attr("value");input+="&shippingofferingid"+groupcount+"="+speed.attr("shippingofferingid");input+="&guaranteetype"+groupcount+"="+speed.attr("guaranteetype");input+="&issss"+groupcount+"="+speed.attr("issss");var splitval="shipWhenComplete";if(splitpref){splitval=splitpref.attr("value");}input+="&shippriority"+groupcount+"="+splitval;if(speed.attr("isscheduledelivery")==="1"){var scheduleddeliverydiv=speed.parent().siblings(".shipping-speed-text").find('[id^="sd_widgets_"]');if(scheduleddeliverywidgetid&&scheduleddeliverydata&&((scheduleddeliverywidgetid===scheduleddeliverydiv.attr("id"))||(scheduleddeliverywidgetid===undefined))){for(var key in scheduleddeliverydata){input+="&"+key+"."+groupcount+"="+scheduleddeliverydata[key];}}else{input+="&"+scheduleddeliverydiv.children(":input").serialize();}}}else{input+="&isdigital"+groupcount+"=1";}groupcount++;extradata+=input;});if(groupcount>0){extradata+="&groupcount="+groupcount;}var ref;var trialkey="";if(PIPELINE.pipedata&&PIPELINE.pipedata.scopeid){trialkey+=PIPELINE.pipedata.scopeid+":";}trialkey+=targetbutton.attr("name")+":"+targetbutton.attr("value");if(spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS>0){spcpage.ASYNC_SET_DELIVERY_TRIAL_IN_PROGRESS=-1;}if(targetbutton.parents("[trialshippingspeed]").length==1){if(spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA&&spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA[trialkey]){if(spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA_TIMEOUT){clearTimeout(spcpage.ASYNC_SET_DELIVERY_TRIAL_PIPEDATA_TIMEOUT);}extradata+="&returnpipedata=0&returnsuccess=1";ref="ox_spc_set_cached_ship_option";}else{ref="ox_spc_set_ship_option";}extradata+="&trialkey="+trialkey;}if(!ref){ref="ox_spc_set_ship_option";}if(extradata.indexOf("&")===0){extradata=extradata.substr(1);}var url="/gp/buy/spc/handlers/set-delivery-options.html/ref="+ref;var callback="spcpage.jsonSetShipOptions";var errorhandler="spcpage.jsonSetShipOptionsError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};spcpage.validatePlaceYourOrderButton=function(){var placeOrderButton=spcdiv.find("div[buybuttondiv$=fx]").find("input");if(placeOrderButton.attr("issetshipoption")==="1"){spcpage.disableBuyButton();}if($("#wine-signature-confirmation").is(":visible")&&!$("#wineNoticeCheckbox").attr("checked")){$("#place-order-blocker-box p[error='confirmWineNotice']").attr("on","yes").show();spcpage.disableBuyButton();}else{$("#place-order-blocker-box p[error='confirmWineNotice']").attr("on","no").hide();}if($("#confirm-age-statement").is(":visible")&&!$("#confirmAgeCheckbox").attr("checked")){$("#place-order-blocker-box p[error='confirmYourAge']").attr("on","yes").show();spcpage.disableBuyButton();}else{$("#place-order-blocker-box p[error='confirmYourAge']").attr("on","no").hide();}if($("#professional-user-certification-message").is(":visible")&&!$("#confirmProfessionalUserCheckbox").attr("checked")){$("#place-order-blocker-box p[error='confirmProfessionalUser']").attr("on","yes").show();spcpage.disableBuyButton();}else{$("#place-order-blocker-box p[error='confirmProfessionalUser']").attr("on","no").hide();}if($("#china-invoice-required").attr("checked")&&(/^\s*$/.test($("#china-invoice-title").attr("value"))||/^\s*$/.test($("#china-invoice-category").attr("value")))){$("#place-order-blocker-box p[error='missingRequiredFieldForChinaInvoice']").attr("on","yes").show();spcpage.disableBuyButton();}else{$("#place-order-blocker-box p[error='missingRequiredFieldForChinaInvoice']").attr("on","no").hide();}};spcpage.ready=function(){if(spcpage.readyLoaded===1){return ;}if(window.amznJQ){amznJQ.onReady("popover",function(){amznJQ.jQuery("#vatBreakdownLink").removeAmazonPopoverTrigger().amazonPopoverTrigger({title:$("#vatTitle").html(),showOnHover:false,showCloseButton:true,skin:"default",location:"bottom",align:"right",width:450,localContent:"#vatBreakdown"});});}setmarker("x6");$("#spc-gc_entry input.apply").unbind("click").bind("click",spcpage.actionAddGiftPromotion);$("#payment-method .changelink").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);$("#spc-cobrand-ad #cobrand-change").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);$("#using-points .changelink").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);$("#using-amex-points .changelink").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);spcdiv.find("div[buybuttondiv='notfx']").find("input").unbind("click").bind("click",spcpage.actionConfirmPurchase);spcdiv.find("div[buybuttondiv='fx']").find("input").unbind("click").bind("click",spcpage.actionConfirmPurchase);spcdiv.find("input[name='changeCardNoEndDatePrime']").unbind("click").bind("click",spcpage.actionPrimeChangeCardNoEndDate);spcdiv.find("input[name='changeCardShowEndDatePrime']").unbind("click").bind("click",spcpage.actionPrimeChangeCardShowEndDate);spcdiv.find("div[buybuttondiv$=fx]").find("input").unbind("hover").hover(function(){spcpage.validatePlaceYourOrderButton();var blockerBox=$("#place-order-blocker-box");if(blockerBox.find("p[on=yes]").length>0){blockerBox.show();var y=blockerBox.height()/2;var x=blockerBox.width();blockerBox.css({top:$(this).offset().top-y,left:$(this).offset().left-x-20});}},function(){spcpage.enableBuyButton();$("#place-order-blocker-box").hide();});spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY=new ErrorAuthority($("#spc-gc_entry"));spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY={};spcpage.createValidators();spcpage.readyLoaded=1;};spcpage.startEngine=function startEngine(pipedata){setmarker("x7");if(!spcdiv){spcdiv=$("#spcpagecontent");}if(pipedata){spcpage.uiDashboardSpinner(true);setmarker("x8");uiScrollToTop();spcpage.jsonPage(pipedata);}else{spcpage.refreshPage();}};spcpage.PIN_SPC_SIDEBAR_13906=function(treatment){if(treatment=="T1"){spcpage.pinSidebar();}};spcpage.pinSidebar=function(){var sideBarTop=$("#sidebar").offset().top-parseFloat($("#bd").css("padding-left").replace(/auto/,0));$("#sidebar").css("position","relative");$("#sidebar").wrap('<div id="pin-sidebar" />');$(window).scroll(function(){var y=$(window).scrollTop();var sideBarCurrentBottom=$("#sidebar").offset().top+$("#sidebar").height();var blueBoxBottom;var sideBarBlueBoxFix;if($("#bottom-place-order").css("display")=="none"){blueBoxBottom=$("#bd").offset().top+$("#bd").height()+parseFloat($("#bd").css("padding-bottom").replace(/auto/,0));sideBarBlueBoxFix=$("#bd").height()-$("#sidebar").height();}else{blueBoxBottom=$("#bd").offset().top+$("#bd").height()-32;sideBarBlueBoxFix=$("#bd").height()-$("#sidebar").height()-32;}if((y>=sideBarTop)&&(y+$("#sidebar").height()<=blueBoxBottom)){$("#sidebar").css("position","fixed");$("#sidebar").css("margin-top",3);$("#sidebar").css("top","0px");$("#sidebar").css("left",$("#pin-sidebar").offset().left-$(window).scrollLeft());}else{if(y+$("#sidebar").height()>blueBoxBottom){$("#sidebar").css("position","absolute");$("#sidebar").css("margin-top",0);$("#sidebar").css("top",sideBarBlueBoxFix);$("#sidebar").css("left","0px");}else{$("#sidebar").css("position","relative");$("#sidebar").css("margin-top","0px");$("#sidebar").css("left","0px");$("#sidebar").css("top","0px");}}});};spcpage.RCX_CHECKOUT_SPC_BBQ_10015=function(treatment){if(window.useBbq&&treatment=="T1"){spcpage.PAGE_STATE.isbbq=true;}};spcpage.RCX_CHECKOUT_PERF_SPC_PAYPAGE_PREFETCH_10733=function(treatment){spcpage.ASYNC_PAYSELECT_PREFETCH=(treatment=="T2");};spcpage.C_AND_IA_UPDATE_11228=function(treatment){if(treatment=="T1"){$("#legalagreementC").hide();$("#legalagreementT1").show();}};spcpage.RCX_CHECKOUT_CORE_PLACE_ORDER_BUTTON_11664=function(treatment){if(treatment=="T1"){$("#placeOrderPrimaryButton").attr("src",$("#placeOrderPrimaryDE").attr("src"));$("#placeOrderSecondaryButton").attr("src",$("#placeOrderSecondaryDE").attr("src"));}};spcpage.SELLER_USAGE_NAME_13250=function(){};spcpage.showChangeCurrency=function showChangeCurrency(){$("#tfx-currency-switcher").show();$("#switch-currency-button").hide();return false;};spcpage.submitChangeCurrency=function submitChangeCurrency(currencyType,radioName){var ordersummary=PIPELINE.pipedata.ordersummary;var hasRetailSubtotals=ordersummary.subtotals&&ordersummary.subtotals.retail&&ordersummary.subtotals.retail.model;var hasRetailFXSubtotals=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.retail&&ordersummary.fx.subtotals.retail.model;var hasMerchantSubtotals=ordersummary.subtotals&&ordersummary.subtotals.merchant&&ordersummary.subtotals.merchant.model;var hasMerchantFXSubtotals=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.merchant&&ordersummary.fx.subtotals.merchant.model;if(currencyType=="marketplace"){$("#SPCSubtotals-transactional-table").hide();$("#SPCSubtotals-marketplace-table").show();if(hasRetailSubtotals){$("#SPCRetailSubtotals-marketplace-table").show();}else{$("#SPCRetailSubtotals-marketplace-table").hide();}if(hasMerchantSubtotals){$("#SPCMerchantSubtotals-marketplace-table").show();}else{$("#SPCMerchantSubtotals-marketplace-table").hide();}$("#SPCRetailSubtotals-transactional-table").hide();$("#SPCMerchantSubtotals-transactional-table").hide();}else{$("#SPCSubtotals-transactional-table").show();$("#SPCSubtotals-marketplace-table").hide();if(hasRetailFXSubtotals){$("#SPCRetailSubtotals-transactional-table").show();}else{$("#SPCRetailSubtotals-transactional-table").hide();}if(hasMerchantFXSubtotals){$("#SPCMerchantSubtotals-transactional-table").show();}else{$("#SPCMerchantSubtotals-transactional-table").hide();}$("#SPCRetailSubtotals-marketplace-table").hide();$("#SPCMerchantSubtotals-marketplace-table").hide();}var targetRadioInput=$("#"+radioName);if(targetRadioInput.attr("type")=="image"){targetRadioInput.attr("src",$("#radio-on").attr("src"));targetRadioInput.parent().siblings().find("input").attr("src",$("#radio-off").attr("src"));}else{targetRadioInput.attr("checked","checked");}if(currencyType=="marketplace"){$("#currencyChanged").attr("value","true");spcdiv.find("p[buybutton=marketplace]").show();spcdiv.find("p[buybutton=transactional]").hide();$("#fxGoodNews-marketplace").show();$("#fxGoodNews-transactional").hide();}else{$("#currencyChanged").attr("value","false");spcdiv.find("p[buybutton=marketplace]").hide();spcdiv.find("p[buybutton=transactional]").show();$("#fxGoodNews-marketplace").hide();$("#fxGoodNews-transactional").show();}};spcpage.htmlOrderSummary=function htmlOrderSummary(model,selector){var htm="";$.each(model,function(i,row){var rows="";if(row.style=="separator"){rows='<tr subtotalsseparator="copy"><td colspan="2"><hr /></td></tr>';}else{if(row.style=="grandTotal"){rows='<tr subtotalstotal="copy"><td colspan="2"><hr /></td></tr>';rows+='<tr subtotalstotal="copy"><td datafield="label" colspan="2" class="total">'+row.label+"&nbsp;";rows+='<em datafield="price" class="price">'+row.value+"</em></td></tr>";}else{if(row.style=="tfxGrandTotal"){rows='<tr subtotalstotal="copy"><td datafield="label" colspan="2" class="total">';rows+='<p datafield="price" class="tfx">('+row.label+"&nbsp;"+row.value+"**)</p></td></tr>";$("#tfx-terms-of-use-footnote").show();}else{if(row.style=="grandTotalLessStressed"){rows='<tr subtotalstotal="copy"><td colspan="2"><hr /></td></tr>';rows+='<tr subtotalstotal="copy"><td datafield="label" colspan="2" class="total">';rows+='<p datafield="price" class="tfx">('+row.label+"&nbsp;"+row.value+")</p></td></tr>";}else{if(row.style=="tfxGrandTotalStressed"){rows='<tr subtotalstotal="copy"><td datafield="label" colspan="2" class="total">'+row.label+"&nbsp;";rows+='<em datafield="price" class="price">'+row.value+"</em></td></tr>";$("#tfx-terms-of-use-footnote").show();}else{if(row.style=="rollupWithBreakdown"){var rollupLabel='<a class="changelink">'+row.label+"</a>&nbsp;"+$("#os-templates .carat-wrapper").clone().html();var classes="label rollup "+(row.taxable?"taxable":"nonTaxable");rows='<tr subtotalstotal="copy"><td datafield="label" class="'+classes+'">'+rollupLabel+"</td>";rows+='<td datafield="price" class="price">'+row.value+"</td></tr>";}else{rows='<tr subtotalsline="copy"><td datafield="label" class="label">'+row.label+"</td>";rows+='<td datafield="price" class="price">'+row.value+"</td></tr>";}}}}}}htm+=rows;});$(selector).html(htm);};spcpage.createRegulatoryFeePopover=function createRegulatoryFeePopover(targetSelector,contentSelector){if(window.amznJQ){amznJQ.onReady("popover",function(){amznJQ.jQuery(targetSelector).amazonPopoverTrigger({title:$(contentSelector+"-title").html(),showOnHover:false,showCloseButton:true,skin:"default",location:"bottom",align:"right",width:450,localContent:contentSelector});});}};spcpage.jsonOrderSummary=function jsonOrderSummary(ordersummary){var isFXEligible=ordersummary.fx&&ordersummary.fx.isFXEligible;var isFXPurchase=ordersummary.fx&&ordersummary.fx.purchaseIsFX;var isFXForeignContext=isFXEligible&&isFXPurchase&&$("#currencyChanged").attr("value")!="true";$("#spc-order-summary [subtotalsline=copy]").remove();$("#spc-order-summary [subtotalstotal=copy]").remove();$("#spc-order-summary [subtotalsseparator=copy]").remove();$("#callout-no-sss").hide();$("#important-message-callout").hide();$("#spc-order-summary").show();$("#spc-subtotals").show();var hasRetailSubtotals=ordersummary.subtotals&&ordersummary.subtotals.retail&&ordersummary.subtotals.retail.model;var hasRetailFXSubtotals=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.retail&&ordersummary.fx.subtotals.retail.model;var hasMerchantSubtotals=ordersummary.subtotals&&ordersummary.subtotals.merchant&&ordersummary.subtotals.merchant.model;var hasMerchantFXSubtotals=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.merchant&&ordersummary.fx.subtotals.merchant.model;var hasTaxableRegulatoryFeeBreakdown=ordersummary.subtotals&&ordersummary.subtotals.regulatoryfeebreakdown&&ordersummary.subtotals.regulatoryfeebreakdown.taxable;var hasNonTaxableRegulatoryFeeBreakdown=ordersummary.subtotals&&ordersummary.subtotals.regulatoryfeebreakdown&&ordersummary.subtotals.regulatoryfeebreakdown.nontaxable;var hasTaxableRegulatoryFeeBreakdownFX=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.regulatoryfeebreakdown&&ordersummary.fx.subtotals.regulatoryfeebreakdown.taxable;var hasNonTaxableRegulatoryFeeBreakdownFX=ordersummary.subtotals&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.regulatoryfeebreakdown&&ordersummary.fx.subtotals.regulatoryfeebreakdown.nontaxable;if(ordersummary.subtotals&&ordersummary.subtotals.model){spcpage.htmlOrderSummary(ordersummary.subtotals.model,"#SPCSubtotals-marketplace");}if(ordersummary.fx&&ordersummary.fx.subtotals&&ordersummary.fx.subtotals.model){spcpage.htmlOrderSummary(ordersummary.fx.subtotals.model,"#SPCSubtotals-transactional");}if(hasRetailSubtotals){spcpage.htmlOrderSummary(ordersummary.subtotals.retail.model,"#SPCRetailSubtotals-marketplace");}if(hasRetailFXSubtotals){spcpage.htmlOrderSummary(ordersummary.fx.subtotals.retail.model,"#SPCRetailSubtotals-transactional");}if(hasMerchantSubtotals){spcpage.htmlOrderSummary(ordersummary.subtotals.merchant.model,"#SPCMerchantSubtotals-marketplace");}if(hasMerchantFXSubtotals){spcpage.htmlOrderSummary(ordersummary.fx.subtotals.merchant.model,"#SPCMerchantSubtotals-transactional");}if(hasTaxableRegulatoryFeeBreakdown){spcpage.htmlOrderSummary(ordersummary.subtotals.regulatoryfeebreakdown.taxable,"#SPCTaxableRegulatoryFeeBreakdown-marketplace");spcpage.createRegulatoryFeePopover("#SPCSubtotals-marketplace .taxable.rollup","#SPCTaxableRegulatoryFeeBreakdown-marketplace-table");}if(hasNonTaxableRegulatoryFeeBreakdown){spcpage.htmlOrderSummary(ordersummary.subtotals.regulatoryfeebreakdown.nontaxable,"#SPCNonTaxableRegulatoryFeeBreakdown-marketplace");spcpage.createRegulatoryFeePopover("#SPCSubtotals-marketplace .nonTaxable.rollup","#SPCNonTaxableRegulatoryFeeBreakdown-marketplace-table");}if(hasTaxableRegulatoryFeeBreakdownFX){spcpage.htmlOrderSummary(ordersummary.fx.subtotals.regulatoryfeebreakdown.taxable,"#SPCTaxableRegulatoryFeeBreakdown-transactional");spcpage.createRegulatoryFeePopover("#SPCSubtotals-transactional .taxable.rollup","#SPCTaxableRegulatoryFeeBreakdown-transactional-table");}if(hasNonTaxableRegulatoryFeeBreakdownFX){spcpage.htmlOrderSummary(ordersummary.fx.subtotals.regulatoryfeebreakdown.nontaxable,"#SPCNonTaxableRegulatoryFeeBreakdown-transactional");spcpage.createRegulatoryFeePopover("#SPCSubtotals-transactional .nonTaxable.rollup","#SPCNonTaxableRegulatoryFeeBreakdown-transactional-table");}if(isFXEligible){if(isFXForeignContext){$("#fxGoodNews-transactional").show();$("#fxGoodNews-marketplace").hide();}else{$("#fxGoodNews-transactional").hide();$("#fxGoodNews-marketplace").show();}}else{$("#fxGoodNews-transactional").hide();$("#fxGoodNews-marketplace").hide();}if(ordersummary.showVatPopover){$("#vatBreakdownNote").show();}else{$("#vatBreakdownNote").hide();}if(isFXForeignContext){$("#SPCSubtotals-transactional-table").show();$("#SPCSubtotals-marketplace-table").hide();if(hasRetailFXSubtotals){$("#SPCRetailSubtotals-transactional-table").show();}else{$("#SPCRetailSubtotals-transactional-table").hide();}if(hasMerchantFXSubtotals){$("#SPCMerchantSubtotals-transactional-table").show();}else{$("#SPCMerchantSubtotals-transactional-table").hide();}$("#SPCRetailSubtotals-marketplace-table").hide();$("#SPCMerchantSubtotals-marketplace-table").hide();}else{$("#SPCSubtotals-transactional-table").hide();$("#SPCSubtotals-marketplace-table").show();if(hasRetailSubtotals){$("#SPCRetailSubtotals-marketplace-table").show();}else{$("#SPCRetailSubtotals-marketplace-table").hide();}if(hasMerchantSubtotals){$("#SPCMerchantSubtotals-marketplace-table").show();}else{$("#SPCMerchantSubtotals-marketplace-table").hide();}$("#SPCRetailSubtotals-transactional-table").hide();$("#SPCMerchantSubtotals-transactional-table").hide();}if(ordersummary.needsThirdPartyRedirect){spcdiv.find("p[name=placeYourOrderAndPay]").show();$("#redirectMessage").show();$("#spc-order-summary").addClass("wider");spcdiv.find("p[name=placeYourOrder]").hide();spcdiv.find("input[id=needsThirdPartyRedirect]").val("1");}else{spcdiv.find("p[name=placeYourOrderAndPay]").hide();$("#redirectMessage").hide();$("#spc-order-summary").removeClass("wider");spcdiv.find("p[name=placeYourOrder]").show();spcdiv.find("input[id=needsThirdPartyRedirect]").val("0");}if(!isFXEligible){spcdiv.find("div[buybuttondiv=notfx]").show();spcdiv.find("div[buybuttondiv=fx]").hide();}else{if(isFXForeignContext){spcdiv.find("div[buybuttondiv=notfx]").hide();spcdiv.find("div[buybuttondiv=fx]").show();spcdiv.find("p[buybutton=marketplace]").hide();spcdiv.find("p[buybutton=transactional]").show();}else{spcdiv.find("div[buybuttondiv=notfx]").hide();spcdiv.find("div[buybuttondiv=fx]").show();spcdiv.find("p[buybutton=marketplace]").show();spcdiv.find("p[buybutton=transactional]").hide();}}if(isFXEligible){if(isFXForeignContext){$("#checkoutCurrencyTransactional").attr("checked","checked");$("#checkoutCurrencyMarketplace").removeAttr("checked");}else{$("#checkoutCurrencyTransactional").removeAttr("checked");$("#checkoutCurrencyMarketplace").attr("checked","checked");}$("#tfxSection").show();$("#tfx-conversion-rate-trigger").click(function(){$("#tfx-conversion").show();$("#tfx-conversion-rate-trigger").hide();});spcdiv.find("span[currency=marketplace]").html(ordersummary.fx.mktCurrency);spcdiv.find("span[currency=transactional]").html(ordersummary.fx.currency);var fxrateelement=spcdiv.find("p[message=fxexchangerate]");fxrateelement.find("[datafield=exchange-rate]").html(ordersummary.fx.rate);fxrateelement.find("[datafield=foreign-currency]").html(ordersummary.fx.currency);spcdiv.find("input[imgname=buybutton-marketplace]").attr("src",ordersummary.fx.mktCurrencyButton);spcdiv.find("input[imgname=buybutton-transactional]").attr("src",ordersummary.fx.fxCurrencyButton);}else{$("#tfxSection").hide();}};spcpage.RCX_CHECKOUT_TFX_CURRENCY_ATTRIBUTE_14224=function RCX_CHECKOUT_TFX_CURRENCY_ATTRIBUTE_14224(treatment){if(treatment!="T1"){$("#tfx-currency-switcher").find("span[datafield=changelink]").hide();return ;}var ordersummary=PIPELINE.pipedata.ordersummary;var isFXEligible=ordersummary.fx&&ordersummary.fx.isFXEligible;if(isFXEligible){$("#fxGoodNews-disabled").hide();$("#change-non-fx-card-currency").hide();$("#tfx-currency-switcher .change-card-currency").removeAttr("href").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);$("#tfx-currency-switcher").find("span[datafield=changelink]").show();}else{if(ordersummary.fx.showCurrencyChangeLink){$("#fxGoodNews-disabled").show();}else{$("#fxGoodNews-disabled").hide();}if(ordersummary.fx.showCurrencyChangeLink){spcdiv.find("span[datafield=currency]").html(ordersummary.fx.currency);$("#change-non-fx-card-currency").show();$("#change-non-fx-card-currency .change-card-currency").removeAttr("href").unbind("click").bind("click",spcpage.actionChangePaymentWrapper);}else{$("#change-non-fx-card-currency").hide();}}};spcpage.PAGE_STATE=null;spcpage.GIFTCARD_PROMO_ERROR_AUTHORITY=null;spcpage.CHANGE_QUANTITY_ERROR_AUTHORITY=null;spcpage.addonpopover=null;spcpage.pbupdatepopover=null;spcpage.pbdeletepopover=null;function setmarker(marker){if(window.ue&&ue.t){uet(marker,SCOPE);}}function sendue(event){if(window.ue&&uex){if(PIPELINE.isajax){uex(event,SCOPE);}}}function setrid(rid){if(window.ue&&ues){ues("id",SCOPE,rid);PIPELINE.isajax=true;}}function setctb(){if(window.ue&&ues){ues("ctb",SCOPE,"1");}}function resetue(){if(window.ue&&ues){var t0_now=new Date();ues("t0",SCOPE,t0_now.getTime());setmarker("ue");setmarker("bb");}}var requestnumber=0;function createscope(isasync){if(isasync){ASYNCSCOPE="ctbajax"+requestnumber++;}else{SCOPE="ajax"+requestnumber++;}}function setscope(currentscope){SCOPE=currentscope;}shipoptionselectpage.startEngine=function startEngine(pipedata){shipoptionselectdiv=$("#shipoptionselectpagecontent");shipoptionselectdiv.find(".deferredoption").each(shipoptionselectpage.thawDeferredOption);shipoptionselectdiv.show();shipoptionselectdiv.trigger("pageloaded");};shipoptionselectpage.ready=function(){shipoptionselectdiv.find("#continue").unbind("click").bind("click",shipoptionselectpage.actionContinueWrapper);shipoptionselectdiv.find(".change-quantities-or-delete").unbind("click").bind("click",shipoptionselectpage.actionChange);shipoptionselectdiv.find("input:radio").unbind("click").bind("click",shipoptionselectpage.changeShipOption);shipoptionselectdiv.find("input:checkbox").unbind("click").bind("click",shipoptionselectpage.selectGiftCheckbox);amznJQ.onReady("popover",function(){shipoptionselectdiv.find("span.pbgroup-title").each(function(i,pbtitle){var pbgroupid=$(this).attr("pbgroupid");amznJQ.jQuery(this).amazonPopoverTrigger({showOnHover:true,showCloseButton:true,width:350,locationOffset:[55,0],location:"bottom",localContent:"#"+pbgroupid,closeEventInclude:["MOUSE_LEAVE","CLICK_OUTSIDE"]});});});eventPageLoaded();$("#checkoutpage").attr("pagename","shipoptionselect").attr("version","2");requestStaticContent("/gp/buy/pipeline/payselect.html","payselect");if($("#hasdefaultdeliveryinformation").attr("data-value")=="1"){shipoptionselectpage.asyncActionContinue();}shipoptionselectpage.OPTION_CHANGED=0;shipoptionselectpage.SHIP_OPTION_CHANGE_COUNT=0;};shipoptionselectpage.actionChange=function(event){window.location.href="/gp/ordering/checkout/item/select.html/"+getRefTag($(event.target));};shipoptionselectpage.actionContinueWrapper=function actionContinueWrapper(event){shipoptionselectdiv.find("#continue").hide();shipoptionselectdiv.find("#continue-spinner").show();setscope(ASYNCSCOPE);setctb();resetue();shipoptionselectpage.actionContinue(event);};shipoptionselectpage.actionContinue=function(event){if(shipoptionselectpage.WAITING_FOR_ASYNC_CONTINUE){shipoptionselectpage.CONTINUE_CLICKED=true;shipoptionselectpage.CONTINUE_EVENT=event;return ;}shipoptionselectpage.CONTINUE_CLICKED=false;shipoptionselectpage.CONTINUE_EVENT=null;if(shipoptionselectpage.ASYNC_CONTINUE_VALID&&shipoptionselectpage.ASYNC_CONTINUE_PIPEDATA){shipoptionselectpage.ASYNC_CONTINUE_VALID=false;shipoptionselectpage.WAITING_FOR_ASYNC_CONTINUE=false;conductor(shipoptionselectpage.ASYNC_CONTINUE_PIPEDATA);return ;}var extradata="returnpipedata=1&isClientTimeBased=1";shipoptionselectdiv.find(":input:checked").each(function(){extradata+="&"+$(this).attr("name")+"="+$(this).attr("value");});shipoptionselectdiv.find(":input:hidden").each(function(){extradata+="&"+$(this).attr("name")+"="+$(this).attr("value");});var hasPrefetch=shipoptionselectpage.ASYNC_CONTINUE_PIPEDATA?1:0;extradata+="&change="+shipoptionselectpage.OPTION_CHANGED+hasPrefetch;var url="/gp/buy/shipoptionselect/handlers/continue.html/"+getRefTag($(event.target));var callback="shipoptionselectpage.jsonContinue";var errorhandler="shipoptionselectpage.handleError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};shipoptionselectpage.jsonContinue=function(data){conductor(data.pipedata);};shipoptionselectpage.handleError=function(data){shipoptionselectdiv.find("#imb").html(data);shipoptionselectdiv.find("#continue-spinner").hide();shipoptionselectdiv.find("#continue").show();eventPageLoaded();};shipoptionselectpage.scheduledDeliveryEnableSOCallback=function scheduledDeliveryEnableSOCallback(data){};shipoptionselectpage.scheduledDeliverySetSOCallback=function scheduledDeliverySetSOCallback(data,id){};shipoptionselectpage.changeShipOption=function changeShipOption(event){if(shipoptionselectpage.SHIP_OPTION_CHANGE_COUNT<5){var extradata="isTrial=1";shipoptionselectdiv.find(":input:checked").each(function(){extradata+="&"+$(this).attr("name")+"="+$(this).attr("value");});shipoptionselectdiv.find(":input:hidden").each(function(){extradata+="&"+$(this).attr("name")+"="+$(this).attr("value");});var url="/gp/buy/shipoptionselect/handlers/continue.html/";getData(url,null,null,null,extradata);}shipoptionselectpage.OPTION_CHANGED=1;shipoptionselectpage.SHIP_OPTION_CHANGE_COUNT++;shipoptionselectpage.ASYNC_CONTINUE_VALID=false;};shipoptionselectpage.selectGiftCheckbox=function selectGiftCheckbox(event){shipoptionselectpage.OPTION_CHANGED=2;shipoptionselectpage.ASYNC_CONTINUE_VALID=false;};shipoptionselectpage.asyncActionContinue=function asyncActionContinue(){var url="/gp/buy/shipoptionselect/handlers/continue-prepare.html/";var callback="shipoptionselectpage.jsonAsyncContinue";var errorhandler="shipoptionselectpage.jsonAsyncErrorHandler";var systemerrorhandler="shipoptionselectpage.jsonAsyncErrorHandler";if(PIPELINE.pipedata&&PIPELINE.pipedata.weblabs&&PIPELINE.pipedata.weblabs.ship&&PIPELINE.pipedata.weblabs.ship.RCX_CHECKOUT_PERF_SPC_PAYPAGE_PREFETCH_10733=="T1"){url="/gp/buy/shared/handlers/continue-prepare.html?from=ship&to=payselect";}shipoptionselectpage.ASYNC_CONTINUE_VALID=true;shipoptionselectpage.WAITING_FOR_ASYNC_CONTINUE=true;if(shipoptionselectpage.ASYNC_CONTINUE_TIMEOUT){clearTimeout(shipoptionselectpage.ASYNC_CONTINUE_TIMEOUT);}getData(url,callback,errorhandler,systemerrorhandler,null);};shipoptionselectpage.jsonAsyncContinue=function jsonAsyncContinue(data){if(data.pipedata&&data.pipedata.nextpage&&data.pipedata.nextpage.page=="payselect"){shipoptionselectpage.ASYNC_CONTINUE_PIPEDATA=data.pipedata;}else{shipoptionselectpage.ASYNC_CONTINUE_VALID=false;}shipoptionselectpage.WAITING_FOR_ASYNC_CONTINUE=false;shipoptionselectpage.ASYNC_CONTINUE_TIMEOUT=setTimeout("shipoptionselectpage.ASYNC_CONTINUE_VALID = false",60000*5);if(shipoptionselectpage.CONTINUE_CLICKED){if(data.pipedata){shipoptionselectpage.actionContinue(shipoptionselectpage.CONTINUE_EVENT);}}};shipoptionselectpage.jsonAsyncErrorHandler=function jsonAsyncErrorHandler(data){shipoptionselectpage.WAITING_FOR_ASYNC_CONTINUE=false;shipoptionselectpage.ASYNC_CONTINUE_VALID=false;if(shipoptionselectpage.CONTINUE_CLICKED){shipoptionselectpage.actionContinue(shipoptionselectpage.CONTINUE_EVENT);}};shipoptionselectpage.thawDeferredOption=function(){$(this).replaceWith(shipoptionselectpage.deferredOptions[$(this).attr("deferredoptionindex")].displayableoptionhtml);};billingaddressselectpage.WAITING_FOR_ASYNC_CONTINUE=false;billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID=null;billingaddressselectpage.ASYNC_CONTINUE_PIPEDATA=null;billingaddressselectpage.CONTINUE_CLICKED=false;billingaddressselectpage.CONTINUE_EVENT=null;billingaddressselectpage.ASYNC_CONTINUE_TIMEOUT=null;billingaddressselectpage.ready=function(){};billingaddressselectpage.startEngine=function startEngine(pipedata){if(!billingaddressselectdiv){billingaddressselectdiv=$("#billingaddressselectpagecontent");}$("#existingaddresses input[name='submit']").show();$("#existingaddresses .continue-spinner").hide();if(pipedata){billingaddressselectpage.uiDashboardSpinner(true);uiScrollToTop();billingaddressselectpage.jsonPage(pipedata);}else{billingaddressselectpage.refreshPage();}$(document).trigger("page-loaded");};billingaddressselectpage.uiDashboardSpinner=function uiDashboardSpinner(enable){if(enable){$("#billingaddr-instructionswrapper").hide();$("#existingaddresses").hide();$("#newaddressform").hide();$("#billingaddressselect-spinner").show();$("#billingaddressselect-header").show();}else{$("#billingaddressselect-header").hide();$("#billingaddressselect-spinner").hide();$("#billingaddr-instructionswrapper").show();$("#existingaddresses").show();$("#newaddressform").show();}};billingaddressselectpage.jsonNewAddress=function jsonNewAddress(newAddress){$("#newshippingaddressfields").html(newAddress);$("#newaddressform #newshippingactions .continue-spinner").hide();$("#newaddressform #newshippingactions input[name='continue']").show();};billingaddressselectpage.jsonPage=function jsonPage(data){PIPELINE.pipedata=data;billingaddressselectdiv.find(".imb").hide();if(data.newAddress){billingaddressselectpage.jsonNewAddress(data.newAddress);}billingaddressselectpage.jsonAddressBook(data.addressbook,data.paymentInfo);if((data.paymentInfo)&&(data.paymentInfo.paymentinstrumentid)){billingaddressselectdiv.find("input[name='paymentInstrumentId']").val(data.paymentInfo.paymentinstrumentid);}else{billingaddressselectdiv.find("input[name='paymentInstrumentId']").val("");}if((data.paymentInfo)&&(data.paymentInfo.paymentmethodcode)){billingaddressselectdiv.find("input[name='paymentMethodCode']").val(data.paymentInfo.paymentmethodcode);}else{billingaddressselectdiv.find("input[name='paymentMethodCode']").val("");}if((data.pagestate)&&(data.pagestate.billingaddressselect)&&(data.pagestate.billingaddressselect.numberofdistinctitems)){billingaddressselectdiv.find("input[name='numberOfDistinctItems']").val(data.pagestate.billingaddressselect.numberofdistinctitems);}else{billingaddressselectdiv.find("input[name='numberOfDistinctItems']").val("");}if((data.pagestate)&&(data.pagestate.billingaddressselect)&&(data.pagestate.billingaddressselect.showaddinternationaladdress)){$("#newaddressform .addNewIntAddress").show();$("#newaddressform input[name='isIntlBillingAddress']").val(1);}else{$("#newaddressform .addNewIntAddress").hide();$("#newaddressform input[name='isIntlBillingAddress']").val(0);}if(data.weblabs&&data.weblabs.billingaddressselect&&(data.weblabs.billingaddressselect.CHECKOUT_10242=="T1")){billingaddressselectpage.asyncActionUseAddress();}billingaddressselectpage.toggleButtons(true);billingaddressselectpage.uiDashboardSpinner(false);if(billingaddressselectpage.anchorToNewAddressForm){billingaddressselectpage.showNewAddressForm();billingaddressselectpage.anchorToNewAddressForm=false;}$("#checkoutpage").attr("pagename","billingselect").attr("version","2");};billingaddressselectpage.refreshPage=function refreshPage(){billingaddressselectpage.uiDashboardSpinner(true);uiScrollToTop();var url="/gp/buy/pipeline/handlers/json-pipedata.html";var extradata="page=billingaddressselect&object=addressbook&object=newAddress&object=paymentInfo&object=pagestate";var callback="billingaddressselectpage.jsonPage";var errorhandler="generalErrorHandling";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};billingaddressselectpage.jsonAddressBlock=function jsonAddressBlock(addressAndOptions,counter,template,container){var htm=template.clone();htm.find("input[name='addressID']").val(addressAndOptions.addressID);htm.find("input[name='submit']").attr("addressID",addressAndOptions.addressID);if(addressAndOptions.addressWidgetHTML){htm.find(".displayAddressBlock").attr("id","addr-"+addressAndOptions.addressID).prepend(addressAndOptions.addressWidgetHTML);if(addressAndOptions.isInvoiceAddress){htm.find(".invoice-address-msg").show();}}htm.attr("addressblock","copy").addClass("addressBlock"+counter).addClass("addressblock"+((counter%2)?"left":"right")).appendTo(container).show();};billingaddressselectpage.jsonAddressBook=function jsonAddressBook(addressbook,paymentInfo){var addrContainer=$("#existingaddresses");if(addressbook&&addressbook.sortedaddressandoptions&&(addressbook.sortedaddressandoptions.length>0)){$("#billingaddr-instructionswrapper").show();$("#newaddressform h1").hide();$("#newaddressform h1."+(((paymentInfo)&&(paymentInfo.isExternalPayment))?"extpay-":"")+"choose-or-enter-new").show();if((paymentInfo)&&(paymentInfo.isExternalPayment)){$("#billing-addr-select-or-add-new").hide();$("#contact-addr-select-or-add-new").show();}else{$("#contact-addr-select-or-add-new").hide();$("#billing-addr-select-or-add-new").show();}var addrTemplate=addrContainer.find("[addressblock='template']");var addrCounter=0;addrContainer.find('div[addressblock="copy"]').remove();addrContainer.find('[billingaddressseparator="copy"]').remove();addrContainer.find('[addressbookseparator="copy"]').remove();while(addrCounter<addressbook.sortedaddressandoptions.length){addrCounter++;billingaddressselectpage.jsonAddressBlock(addressbook.sortedaddressandoptions[addrCounter-1],addrCounter,addrTemplate,addrContainer);if(addrCounter%2==0){addrContainer.find('[billingaddressseparator="template"]').clone().attr("billingaddressseparator","copy").appendTo(addrContainer).show();}}if(addrCounter%2){addrContainer.find('[addressbookseparator="template"]').clone().attr("addressbookseparator","copy").appendTo(addrContainer).show();}if(addressbook.addresscount){addrContainer.show();}else{addrContainer.hide();}}else{$("#billingaddr-instructionswrapper").hide();$("#newaddressform h1").hide();$("#newaddressform h1."+(((paymentInfo)&&(paymentInfo.isExternalPayment))?"extpay-":"")+"enter-new").show();addrContainer.hide();addrContainer.find('div[addressblock="copy"]').remove();addrContainer.find('[billingaddressseparator="copy"]').remove();addrContainer.find('[addressbookseparator="copy"]').remove();}};billingaddressselectpage.jsonAsyncUseAddress=function jsonAsyncUseAddress(data){if(data.pipedata){billingaddressselectpage.ASYNC_CONTINUE_PIPEDATA=data.pipedata;billingaddressselectpage.WAITING_FOR_ASYNC_CONTINUE=false;billingaddressselectpage.ASYNC_CONTINUE_TIMEOUT=setTimeout("billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID=null",30000);if(billingaddressselectpage.CONTINUE_CLICKED){billingaddressselectpage.actionUseAddress(billingaddressselectpage.CONTINUE_EVENT);}}else{billingaddressselectpage.jsonAsyncErrorHandler(data);}};billingaddressselectpage.jsonAsyncErrorHandler=function jsonAsyncErrorHandler(data){billingaddressselectpage.WAITING_FOR_ASYNC_CONTINUE=false;billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID=null;if(billingaddressselectpage.CONTINUE_CLICKED){billingaddressselectpage.actionUseAddress(billingaddressselectpage.CONTINUE_EVENT);}};billingaddressselectpage.asyncActionUseAddress=function asyncActionUseAddress(){var target=$("#existingaddresses").find('div[addressblock="copy"] input[name="addressID"]');if((target==null)||(target.attr("value")=="")){return ;}var extradata="returnpipedata=1&returnjson=1&isClientTimeBased=1&addressID="+target.attr("value");if(billingaddressselectdiv.find('input[name="paymentInstrumentId"]').attr("value")){extradata+="&paymentInstrumentId="+billingaddressselectdiv.find('input[name="paymentInstrumentId"]').attr("value");}if(billingaddressselectdiv.find('input[name="paymentMethodCode"]').attr("value")){extradata+="&paymentMethodCode="+billingaddressselectdiv.find('input[name="paymentMethodCode"]').attr("value");}if(billingaddressselectdiv.find('input[name="numberOfDistinctItems"]').attr("value")){extradata+="&numberOfDistinctItems="+billingaddressselectdiv.find('input[name="numberOfDistinctItems"]').attr("value");}var url="/gp/buy/billingaddressselect/handlers/continue.html";var callback="billingaddressselectpage.jsonAsyncUseAddress";var errorhandler="billingaddressselectpage.jsonAsyncErrorHandler";var systemerrorhandler="generalErrorHandling";billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID=target.attr("value");billingaddressselectpage.WAITING_FOR_ASYNC_CONTINUE=true;getData(url,callback,errorhandler,systemerrorhandler,extradata);};billingaddressselectpage.actionUseAddressWrapper=function actionUseAddressWrapper(event){billingaddressselectpage.toggleButtons(false);billingaddressselectdiv.find(".imb").hide();var target=$(event.target);target.hide();target.parent().find(".continue-spinner").show();setscope(ASYNCSCOPE);setctb();resetue();logEvents.enqueue(new LogEntry(logEvents.CLICKED,target.attr("addressID"),[]));billingaddressselectpage.actionUseAddress(event);};billingaddressselectpage.actionUseAddress=function actionUseAddress(event){if(billingaddressselectpage.WAITING_FOR_ASYNC_CONTINUE){billingaddressselectpage.CONTINUE_CLICKED=true;billingaddressselectpage.CONTINUE_EVENT=event;return ;}billingaddressselectpage.CONTINUE_CLICKED=false;billingaddressselectpage.CONTINUE_EVENT=null;var target=$(event.target);if((billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID!=null)&&(target.attr("addressID")==billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID)){billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID=null;billingaddressselectpage.WAITING_FOR_ASYNC_CONTINUE=false;conductor(billingaddressselectpage.ASYNC_CONTINUE_PIPEDATA);return ;}else{billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID=null;}var extradata="returnpipedata=1&returnjson=1&isClientTimeBased=1&addressID="+target.attr("addressID");if(billingaddressselectdiv.find('input[name="paymentInstrumentId"]').attr("value")){extradata+="&paymentInstrumentId="+billingaddressselectdiv.find('input[name="paymentInstrumentId"]').attr("value");}if(billingaddressselectdiv.find('input[name="paymentMethodCode"]').attr("value")){extradata+="&paymentMethodCode="+billingaddressselectdiv.find('input[name="paymentMethodCode"]').attr("value");}if(billingaddressselectdiv.find('input[name="numberOfDistinctItems"]').attr("value")){extradata+="&numberOfDistinctItems="+billingaddressselectdiv.find('input[name="numberOfDistinctItems"]').attr("value");}var url="/gp/buy/billingaddressselect/handlers/continue.html";var callback="billingaddressselectpage.jsonContinue";var errorhandler="billingaddressselectpage.handleError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};billingaddressselectpage.jsonContinue=function jsonContinue(data){if(data.pipedata){if(billingaddressselectpage.isbbq){bbqConductor(data.pipedata,"spc");}else{conductor(data.pipedata);}}else{if(data.newAddress){billingaddressselectpage.jsonNewAddress(data.newAddress);billingaddressselectpage.toggleButtons(true);$("#newaddressform #newshippingactions .continue-spinner").hide();$("#newaddressform #newshippingactions input[name='continue']").show();if(data.createAddressResult=="addressCreationFailed"){billingaddressselectdiv.find(".imb").show();}}else{billingaddressselectpage.handleError(data);}}};billingaddressselectpage.handleError=function handleError(data){$("#newaddressform #newshippingactions .continue-spinner").hide();$("#newaddressform #newshippingactions input[name='continue']").show();$("#existingaddresses .continue-spinner").hide();$("#existingaddresses input[name='submit']").show();billingaddressselectpage.toggleButtons(true);eventPageLoaded();};billingaddressselectpage.actionAddAddress=function actionAddAddress(event){billingaddressselectpage.toggleButtons(false);billingaddressselectdiv.find(".imb").hide();var target=$(event.target);target.hide();target.parent().find(".continue-spinner").show();setscope(ASYNCSCOPE);setctb();resetue();billingaddressselectpage.ASYNC_CONTINUE_ADDRESSID=null;var extradata="returnpipedata=1&returnjson=1";$("#newaddressform #newshippingaddressfields input").each(function(){extradata+="&"+$(this).attr("name")+"="+encodeURIComponent($(this).attr("value"));});$("#newaddressform #newshippingaddressfields select").each(function(){extradata+="&"+$(this).attr("name")+"="+$(this).attr("value");});if(billingaddressselectdiv.find('input[name="paymentInstrumentId"]').attr("value")){extradata+="&paymentInstrumentId="+billingaddressselectdiv.find('input[name="paymentInstrumentId"]').attr("value");}if(billingaddressselectdiv.find('input[name="paymentMethodCode"]').attr("value")){extradata+="&paymentMethodCode="+billingaddressselectdiv.find('input[name="paymentMethodCode"]').attr("value");}var url="/gp/buy/billingaddressselect/handlers/continue.html";var callback="billingaddressselectpage.jsonContinue";var errorhandler="billingaddressselectpage.handleError";var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};billingaddressselectpage.actionAddIntAddress=function actionAddIntAddress(event){$("#add-new-intl-address").submit();};billingaddressselectpage.toggleButtons=function toggleButtons(enable){if(enable){$("#existingaddresses input[name='submit']").css("cursor","pointer");$('#existingaddresses input[name="submit"]').unbind("click").bind("click",billingaddressselectpage.actionUseAddressWrapper);$("#newaddressform #newshippingactions input[name='continue']").css("cursor","pointer");$('#newaddressform #newshippingactions input[name="continue"]').unbind("click").bind("click",billingaddressselectpage.actionAddAddress);$("#newaddressform .addNewIntAddress").unbind("click").bind("click",billingaddressselectpage.actionAddIntAddress);}else{$("#newaddressform .addNewIntAddress").unbind("click");$("#newaddressform #newshippingactions input[name='continue']").css("cursor","not-allowed");$("#newaddressform #newshippingactions input[name='continue']").unbind("click");$("#existingaddresses input[name='submit']").css("cursor","not-allowed");$("#existingaddresses input[name='submit']").unbind("click");}};billingaddressselectpage.showNewAddressForm=function showNewAddressForm(){var newaddressform=$("#newaddressform");if(newaddressform&&newaddressform.length){$(window).scrollTop(newaddressform.offset().top);}};billingaddressselectpage.RCX_CHECKOUT_SPC_BBQ_10015=function(treatment){if(window.useBbq&&treatment=="T1"){billingaddressselectpage.isbbq=true;}};ordereditpopover.showPopover=function showPopover(useAltCloseText){if(useAltCloseText){$("#popover-close-text").hide();$("#popover-close-cancel-text").show();}else{$("#popover-close-cancel-text").hide();$("#popover-close-text").show();}var anchor=$("#pagecontentplaceholder");if(spcdiv.is(":visible")){anchor=$("#custom-doc");}var content=$("#order-edit-popover");if(content){var popoverCloseButton=$("#popover-close-button");popoverCloseButton.show().unbind("click").bind("click",ordereditpopover.hidePopover);ordereditpopover.bindActionEnterKeyOnButton(popoverCloseButton);ordereditpopover.popover=amznJQ.jQuery.AmazonPopover.displayPopover({localContent:"#order-edit-popover",skin:"default",modal:true,showOnHover:false,draggable:false,showCloseButton:false,closeEventExclude:"CLICK_OUTSIDE",locationElement:anchor,location:"top",locationOffset:[0,content.height()+100],align:"center",height:null,width:content.width()+84,forceAlignment:true,zIndex:1000});}};ordereditpopover.hidePopover=function hidePopover(){if(ordereditpopover.popover){ordereditpopover.popover.close();ordereditpopover.popover=null;}};ordereditpopover.startLoading=function startLoading(hideClose){if(hideClose){$("#popover-close-button").hide();}$("#order-edit-popover .popover-spinner").show();};ordereditpopover.stopLoading=function stopLoading(){$("#popover-close-button").show();$("#order-edit-popover .popover-spinner").hide();};ordereditpopover.createPaginationDiv=function createPaginationDiv(currentPage,count,callback){var paginationDiv=$("#order-edit-popover [pagination='template']").clone().attr("pagination","copy");var lowerBound=currentPage-1;if(lowerBound<0){lowerBound=0;}var upperBound=lowerBound+2;if(upperBound>=count){upperbound=count-1;lowerBound=upperBound-2;if(lowerBound<0){lowerbound=0;}}if(lowerBound<3){lowerBound=1;}if((count-upperBound)<4){upperBound=count-2;}paginationDiv.find(".pagination-next").before($("<span>").addClass("pagination-link").attr("goto",0).html("1"));if(lowerBound>2){paginationDiv.find(".pagination-next").before($("<span>").addClass("pagination-ellipsis").html("..."));}for(var i=lowerBound;i<=upperBound;i++){paginationDiv.find(".pagination-next").before($("<span>").addClass("pagination-link").attr("goto",i).html(i+1));}if(count-upperBound>3){paginationDiv.find(".pagination-next").before($("<span>").addClass("pagination-ellipsis").html("..."));}paginationDiv.find(".pagination-next").before($("<span>").addClass("pagination-link").attr("goto",count-1).html(count));if(currentPage>0){paginationDiv.find(".pagination-previous").removeClass("pagination-hidden").addClass("pagination-link").attr("goto",currentPage-1);}if(currentPage<count-1){paginationDiv.find(".pagination-next").removeClass("pagination-hidden").addClass("pagination-link").attr("goto",currentPage+1);}paginationDiv.find("span[goto="+currentPage+"]").removeClass("pagination-link").addClass("pagination-current");var paginationLink=paginationDiv.find(".pagination-link");paginationLink.bind("click",callback);ordereditpopover.bindActionEnterKeyOnButton(paginationLink);return paginationDiv;};ordereditpopover.fillAddressBook=function fillAddressBook(addresses,bookDiv,numRows,numColumns,setterUrl,setterCallback,setterErrorHandler){bookDiv.find(".select-address-page[addresspage!='template']").remove();var currentIndex=0;var pageCount=0;for(var pageIndex=0;currentIndex<=addresses.length;pageIndex++){var page=bookDiv.find("[addresspage='template']").clone().attr("addresspage",pageIndex);for(var rowIndex=0;rowIndex<numRows&&currentIndex<=addresses.length;rowIndex++){var row=page.find("[addressrow='template']").clone().attr("addressrow","copy").show();for(var colIndex=0;colIndex<numColumns&&currentIndex<=addresses.length;colIndex++){var slot;if(currentIndex==addresses.length){slot=row.find("[newaddressslot='template']").clone().attr("newaddressslot","copy").show();}else{slot=row.find("[addressslot='template']").clone().attr("addressslot","copy").show();slot.append(addresses[currentIndex].html);if(addresses[currentIndex].isInvoiceAddress){slot.append(slot.find(".invoice-address-note").clone().show());}var setArgs=addresses[currentIndex].setArgs+"&index="+currentIndex;var setterData={seturl:setterUrl,setargs:setArgs,callback:setterCallback,errorhandler:setterErrorHandler};var button;if(addresses[currentIndex].isSelected){button=slot.find(".use-current-address-button");}else{button=slot.find(".use-different-address-button");}button.unbind("click").bind("click",setterData,ordereditpopover.actionChooseAddress).show();ordereditpopover.bindActionEnterKeyOnButton(button);}if(colIndex==numColumns-1){slot.addClass("select-address-slot-last");}row.find("ol:first").append(slot);currentIndex++;}page.find("ol:first").append(row);}pageCount++;bookDiv.append(page);page.show();if(bookDiv.height()>parseInt(bookDiv.css("min-height"))){bookDiv.css("min-height",bookDiv.css("height"));}page.hide();}};ordereditpopover.actionChooseAddress=function actionChooseAddress(event){var url;var setArgs;var callback;var errorhandler;if(event&&event.data&&event.data.seturl&&event.data.setargs&&event.data.callback&&event.data.errorhandler){url=event.data.seturl;setArgs=event.data.setargs;callback=event.data.callback;errorhandler=event.data.errorhandler;}ordereditpopover.startLoading(true);var extradata="?"+setArgs;var systemerrorhandler="generalErrorHandling";getData(url,callback,errorhandler,systemerrorhandler,extradata);};ordereditpopover.bindActionEnterKeyOnButton=function bindActionEnterKeyOnButton(button){button.keyup(function(e){if(e.which==13){$(e.target).trigger("click");}});};ordereditpopover.showShippingAddressPopover=function showShippingAddressPopover(){$("#order-edit-popover .popover-title").hide();$("#order-edit-popover .popover-content").hide();$("#popover-content-shipping-address").show();$("#popover-title-shipping-address").show();ordereditpopover.showPopover();};ordereditpopover.jsonShippingAddressPopover=function jsonShippingAddressPopover(data){var refTagRoot;var setterCallback;var setterErrorhandler;if(spcdiv.is(":visible")){refTagRoot="ox_spc";setterCallback="spcpage.jsonUpdateShippingAddress";setterErrorhandler="generalErrorHandling";}var bookDiv=$("#shipping-address-book");var url="/gp/buy/pipeline/handlers/update-shipping-address.html";ordereditpopover.fillAddressBook(data.addresses,bookDiv,2,3,url,setterCallback,setterErrorhandler);bookDiv.find(".select-address-page[addresspage='0']").show();var pageCount=bookDiv.find(".select-address-page[addresspage!='template']").length;if(pageCount>1){var paginationDiv=ordereditpopover.createPaginationDiv(0,pageCount,ordereditpopover.clickShippingAddressPaginationLink);$("#shipping-address-main").find(".popover-pagination").remove();paginationDiv.appendTo($("#shipping-address-main")).show();}if(data.showPickupSearch){$("#popover-store-pickup-search").show();if(data.useTwoZipStoreSearch){$("#popover-store-pickup-search .secondary-pickup-input").show();$("#popover-store-pickup-search input[name='searchCriterion']").val("storeTwoZips");$("#popover-store-pickup-search .popover-pickup-input input").removeClass("single-input").addClass("two-inputs");}else{$("#popover-store-pickup-search .secondary-pickup-input input").val("");}}else{$("#popover-store-pickup-search").hide();}if(data.canShipToMultiple){$("#popover-ship-to-multiple-link").show();}else{$("#popover-ship-to-multiple-link").hide();}$("#popover-store-pickup-search .popover-pickup-input input").focus(function(){if($(this).hasClass("pickup-query-default")){$("#popover-store-pickup-search .popover-pickup-input input").removeClass("pickup-query-default").addClass("pickup-query").val("");}});var addAddressButtonDiv=bookDiv.find(".add-address-button");addAddressButtonDiv.bind("click",{usecase:"addaddress",reftag:refTagRoot+"_shipaddr_addnewbox_popover"},ordereditpopover.actionClickShippingAddressLink);var popoverAddNewAddressLink=$("#popover-add-new-address-link");popoverAddNewAddressLink.bind("click",{usecase:"addaddress",reftag:refTagRoot+"_shipaddr_addnewlink_popover"},ordereditpopover.actionClickShippingAddressLink);var popoverShipToMultipleLink=$("#popover-ship-to-multiple-link");popoverShipToMultipleLink.bind("click",{usecase:"shiptomultiple",reftag:refTagRoot+"_shipaddr_multilink_popover"},ordereditpopover.actionClickShippingAddressLink);var popoverEditAddressLink=$("#popover-edit-address-link");popoverEditAddressLink.bind("click",{usecase:"editaddress",reftag:refTagRoot+"_shipaddr_editlink_popover"},ordereditpopover.actionClickShippingAddressLink);ordereditpopover.bindActionEnterKeyOnButton(addAddressButtonDiv);ordereditpopover.bindActionEnterKeyOnButton(popoverAddNewAddressLink);ordereditpopover.bindActionEnterKeyOnButton(popoverShipToMultipleLink);ordereditpopover.bindActionEnterKeyOnButton(popoverEditAddressLink);ordereditpopover.stopLoading();eventPageLoaded();$("#checkoutpage").attr("pagename","addressselect").attr("version","3");};ordereditpopover.actionClickShippingAddressLink=function actionClickShippingAddressLink(event){var useCase=null;if(event&&event.data&&event.data.usecase){useCase=event.data.usecase;}else{return ;}var refTag;if(event.data.reftag){refTag=event.data.reftag;}else{refTag="shipaddr_popover_link";}var url=null;var anchor="";var args="";if(useCase=="addaddress"){url="/gp/ordering/checkout/address/select.html";anchor="#new-address";}else{if(useCase=="editaddress"){url="/gp/ordering/checkout/address/select.html";}else{if(useCase=="shiptomultiple"){url="/gp/ordering/checkout/item/select.html";args="?useCase=multiAddress";}}}if(url){window.location.href=url+"/ref="+refTag+anchor+args;}};ordereditpopover.clickShippingAddressPaginationLink=function clickShippingAddressPaginationLink(event){if(!event||!event.target){return ;}var target=$(event.target);var nextPage=parseInt(target.attr("goto"));var bookDiv=$("#shipping-address-book");var pageCount=bookDiv.find(".select-address-page[addresspage!='template']").length;bookDiv.find(".select-address-page:visible").fadeOut(300,function(){var paginationDiv=ordereditpopover.createPaginationDiv(nextPage,pageCount,ordereditpopover.clickShippingAddressPaginationLink);$("#shipping-address-main").find(".popover-pagination").remove();paginationDiv.appendTo($("#shipping-address-main")).show();bookDiv.find("div[addresspage="+nextPage+"]").fadeIn(300);});};ordereditpopover.showBillingAddressPopover=function showBillingAddressPopover(){$("#order-edit-popover .popover-title").hide();$("#order-edit-popover .popover-content").hide();$("#popover-content-billing-address").show();$("#popover-title-billing-address").show();ordereditpopover.showPopover();};ordereditpopover.jsonBillingAddressPopover=function jsonBillingAddressPopover(data){var refTagRoot;var setterCallback;var setterErrorhandler="generalErrorHandling";if(spcdiv.is(":visible")){refTagRoot="ox_spc";setterCallback="spcpage.jsonUpdateBillingAddress";}var bookDiv=$("#billing-address-book");var url="/gp/buy/pipeline/handlers/update-billing-address.html";ordereditpopover.fillAddressBook(data.addresses,bookDiv,2,3,url,setterCallback,setterErrorhandler);bookDiv.find(".select-address-page[addresspage='0']").show();var pageCount=bookDiv.find(".select-address-page[addresspage!='template']").length;if(pageCount>1){var paginationDiv=ordereditpopover.createPaginationDiv(0,pageCount,ordereditpopover.clickBillingAddressPaginationLink);$("#billing-address-main").find(".popover-pagination").remove();paginationDiv.appendTo($("#billing-address-main")).show();}var addAddressButton=bookDiv.find(".add-address-button");addAddressButton.bind("click",{pipelineBillingPage:data.pipelineBillingPage,usecase:"addaddress",reftag:refTagRoot+"_billaddr_addnewbox_popover"},ordereditpopover.actionClickBillingAddressLink);var popoverAddNewBillingAddressLink=$("#popover-add-new-billing-address-link");popoverAddNewBillingAddressLink.bind("click",{pipelineBillingPage:data.pipelineBillingPage,usecase:"addaddress",reftag:refTagRoot+"_billaddr_addnewlink_popover"},ordereditpopover.actionClickBillingAddressLink);ordereditpopover.bindActionEnterKeyOnButton(popoverAddNewBillingAddressLink);ordereditpopover.bindActionEnterKeyOnButton(addAddressButton);ordereditpopover.stopLoading();eventPageLoaded();$("#checkoutpage").attr("pagename","billingselect").attr("version","3");};ordereditpopover.jsonBillingAddressPopoverError=function jsonBillingAddressPopoverError(data){ordereditpopover.stopLoading();if(spcpage.PAGE_STATE.isbbq){setBbqPage("billingaddressselect");}else{PIPEDATA_RETURN_RID="1";PIPELINE.pipedata=null;gotoPage("billingaddressselect");}};ordereditpopover.actionClickBillingAddressLink=function actionClickBillingAddressLink(event){var useCase=null;if(event&&event.data&&event.data.usecase){useCase=event.data.usecase;}else{return ;}var refTag;if(event.data.reftag){refTag=event.data.reftag;}else{refTag="billaddr_popover_link";}var url=null;var anchor="";var args="";if(useCase=="addaddress"){if(event.data.pipelineBillingPage){billingaddressselectpage.anchorToNewAddressForm=true;if(spcpage.PAGE_STATE.isbbq){setBbqPage("billingaddressselect");}else{PIPEDATA_RETURN_RID="1";PIPELINE.pipedata=null;gotoPage("billingaddressselect");}}else{url="/gp/ordering/checkout/billing/select.html";anchor="#new-address";}}if(url){window.location.href=url+"/ref="+refTag+anchor+args;}};ordereditpopover.clickBillingAddressPaginationLink=function clickBillingAddressPaginationLink(event){if(!event||!event.target){return ;}var target=$(event.target);var nextPage=parseInt(target.attr("goto"));var bookDiv=$("#billing-address-book");var pageCount=bookDiv.find(".select-address-page[addresspage!='template']").length;bookDiv.find(".select-address-page:visible").fadeOut(300,function(){var paginationDiv=ordereditpopover.createPaginationDiv(nextPage,pageCount,ordereditpopover.clickBillingAddressPaginationLink);$("#billing-address-main").find(".popover-pagination").remove();paginationDiv.appendTo($("#billing-address-main")).show();bookDiv.find("div[addresspage="+nextPage+"]").fadeIn(300);});};ordereditpopover.showGiftPopover=function showGiftPopover(){$("#order-edit-popover .popover-title").hide();$("#order-edit-popover .popover-content").hide();$("#popover-content-gift").show();$("#popover-title-gift").show();ordereditpopover.showPopover(true);};ordereditpopover.jsonGiftPopover=function jsonGiftPopover(data){$("#gift-error-box").hide();if(data&&data.item&&data.item.title){$("#popover-gift-top .gift-item-title span").html(data.item.title);}if(data&&data.obfuscatedEntityId){var checkoutButtonEnable=$("#checkout-button-enable");checkoutButtonEnable.unbind("click").bind("click",{obfuscatedentityid:data.obfuscatedEntityId,giftData:data},ordereditpopover.actionSaveGiftOptions);ordereditpopover.bindActionEnterKeyOnButton(checkoutButtonEnable);}if(data&&data.selected){if(data.selected.hidePrices){$("#hide-prices-checkbox").attr("checked","checked");}else{$("#hide-prices-checkbox").removeAttr("checked");}}if(data&&data.item.purchaseIsKindle){$("#popover-kindle-registration-box").show();$("#kindleRegistration-1").bind("change",ordereditpopover.yourAccountKindle);$("#kindleRegistration-0").bind("change",ordereditpopover.giftKindle);$("#hide-prices-checkbox").bind("change",ordereditpopover.hidePricesForKindle);$("#popover-kindle-registration-box .register-kindle-customer-name").html($("#popover-content-gift").find("#gift-customer-name").html());if(data.selected.hidePrices||data.selected.isWrapped){$("#kindleRegistration-1").removeAttr("checked");$("#kindleRegistration-0").attr("checked","checked");}else{$("#kindleRegistration-1").attr("checked","checked");$("#kindleRegistration-0").removeAttr("checked");}$("#amazon-gift-wrap").unbind("change");}else{$("#popover-kindle-registration-box").hide();$("#amazon-gift-wrap").bind("change",ordereditpopover.actionDisableHidePrice);}if(data.options.canHaveMessage){if(data&&data.selected){var message=data.selected.message;if(message&&message.length){$("#popover-content-gift textarea[name='gift-message-text']").val(message);$("#include-gift-message-checkbox").attr("checked","checked");}else{if(message==null&&data.selected.isWrapped){$("#include-gift-message-checkbox").removeAttr("checked");$("#popover-content-gift textarea[name='gift-message-text']").val("");}else{$("#popover-content-gift textarea[name='gift-message-text']").val("");var sampleMsg=$("#popover-content-gift").find("#sample-gift-msg").html();sampleMsg+="\n\n";sampleMsg+=$("#popover-content-gift").find("#sample-gift-msg-from").text();sampleMsg+=ordereditpopover.getFirstName($("#popover-content-gift").find("#gift-customer-name").html());$("#popover-content-gift textarea[name='gift-message-text']").val(sampleMsg);$("#inlcude-gift-message-checkbox").attr("checked","checked");}}}if(data&&data.options){$("#popover-content-gift textarea[name='gift-message-text']").bind("keyup",function(){ordereditpopover.updateGiftMessageCounter(data.options.maxMessageChars,data.options.maxMessageLines,data.options.hasFixedGiftMsgLimit);});$("#popover-content-gift textarea[name='gift-message-text']").bind("mouseup",function(){ordereditpopover.updateGiftMessageCounter(data.options.maxMessageChars,data.options.maxMessageLines,data.options.hasFixedGiftMsgLimit);});ordereditpopover.updateGiftMessageCounter(data.options.maxMessageChars,data.options.maxMessageLines,data.options.hasFixedGiftMsgLimit);$("#include-gift-message-checkbox").bind("change",function(){ordereditpopover.clearGiftMessage(data.options.maxMessageChars,data.options.maxMessageLines,data.options.hasFixedGiftMsgLimit);});}}else{$(".popover-gift-message-text").css("visibility","hidden");$("#include-gift-message").css("visibility","hidden");$(".popover-gift-message-not-available").show();}if(data&&data.options&&!data.options.canBeWrapped){$("#popover-content-gift .right-pane").hide();$("#popover-content-gift .popover-gift-no-wrap-available").show();$("#hide-prices-amazon-msg").hide();$("#hide-prices-note").hide();$("#hide-prices-merchant-msg").show();$("#hide-prices-checkbox").attr("disabled",false);}else{if(data&&data.item.isAmazonFulfilled){$("#popover-content-gift .right-pane").hide();$("#popover-content-gift .popover-gift-fba-wrap").show();$("#hide-prices-amazon-msg").show();$("#hide-prices-merchant-msg").hide();if(data.useLargeWrapImage){$("#popover-content-gift .large-preview").show();var largerImageLink=$("#popover-content-gift .larger-image-link");largerImageLink.unbind("click").bind("click",ordereditpopover.actionShowGiftWrapPreview);ordereditpopover.bindActionEnterKeyOnButton(largerImageLink);}else{var imageUrl=data.options.wraps[0].imageurl;$("#fba-image").attr("src",imageUrl).show();$("#popover-gift-center .amazon-gift-wrap-text").css("padding-top","10px");$("#popover-gift-center .gift-wrap-title").css("display","block");}if(data.options&&data.options.wraps&&data.options.wraps[0]){$("#popover-content-gift .fba-wrap-checkbox .gift-wrap-price").html(data.options.wraps[0].price);$("#amazon-gift-wrap").val(data.options.wraps[0].id);if(data.selected.isWrapped){$("#amazon-gift-wrap").attr("checked","checked");if(!data.item.purchaseIsKindle){$("#hide-prices-checkbox").attr("checked",true);$("#hide-prices-checkbox").attr("disabled",true);$("#hide-prices-note").show();}}else{$("#amazon-gift-wrap").removeAttr("checked");$("#hide-prices-checkbox").attr("disabled",false);$("#hide-prices-note").hide();}}}else{$("#popover-content-gift .right-pane").hide();$("#hide-prices-checkbox").removeAttr("disabled");$("#hide-prices-amazon-msg").hide();$("#hide-prices-note").hide();$("#hide-prices-merchant-msg").show();var wrapDisplay=$("#popover-content-gift .popover-gift-merchant-wrap").show();wrapDisplay.find(".mfn-wrap-copy").remove();var wrapTemplate=wrapDisplay.find(".mfn-wrap-template");for(var i=0;i<data.options.wraps.length;i++){var wrapDiv=wrapTemplate.clone(true).removeClass("mfn-wrap-template").addClass("mfn-wrap-copy");var id=data.options.wraps[i].id;wrapDiv.find("input").attr("id","mfn-wrap-"+i).val(id);wrapDiv.find("label").attr("for","mfn-wrap-"+i);var description=data.options.wraps[i].description;wrapDiv.find(".mfn-wrap-description").html(description);var price=data.options.wraps[i].price;wrapDiv.find(".mfn-wrap-price").html(price);var imageUrl=data.options.wraps[i].imageurl;if(imageUrl&&imageUrl.length){wrapDiv.find("#mfn-image").attr("src",imageUrl).show();}wrapDiv.show().insertAfter(wrapTemplate);}wrapDisplay.find("mfn-wrap-checkbox").removeAttr("checked");if(data.selected&&data.selected.isWrapped){wrapDisplay.find("input[value='"+data.selected.wrap+"']").attr("checked","checked");}else{wrapDisplay.find("#mfn-wrap-none").attr("checked","checked");}}}ordereditpopover.stopLoading();eventPageLoaded();$("#checkoutpage").attr("pagename","giftselect").attr("version","3");};ordereditpopover.jsonGiftPopoverError=function jsonGiftPopoverError(data){ordereditpopover.stopLoading();eventPageLoaded();$("#checkoutpage").attr("pagename","giftselect").attr("version","3");};ordereditpopover.actionSaveGiftOptions=function actionSaveGiftOptions(event){var args="?";if(event&&event.data&&event.data.obfuscatedentityid){args+="obfuscatedEntityId="+event.data.obfuscatedentityid+"&";}if($("#include-gift-message-checkbox").is(":checked")){args+="includeMessage=1&"+"message="+encodeURIComponent($("#popover-content-gift textarea[name='gift-message-text']").val())+"&";args+="maxChars="+event.data.giftData.options.maxMessageChars+"&";args+="maxLines="+event.data.giftData.options.maxMessageLines+"&";}else{args+="includeMessage=0&";}if($("#hide-prices-checkbox").is(":checked")){args+="hidePrices=1&";}else{args+="hidePrices=0&";}if($("#popover-content-gift .popover-gift-fba-wrap").is(":visible")){if($("#amazon-gift-wrap").is(":checked")){args+="giftWrap="+$("#amazon-gift-wrap").val()+"&";if(event.data.giftData.options){args+="currencyAmount="+event.data.giftData.options.wraps[0].priceAmount+"&";args+="currencyUnit="+event.data.giftData.options.wraps[0].unit+"&";}}}else{if($("#popover-content-gift .popover-gift-merchant-wrap").is(":visible")){var wrapId=$("#popover-content-gift input[name='mfn-gift-wrap']:checked").eq(0).val();if(wrapId&&wrapId.length){args+="giftWrap="+wrapId+"&";for(var i=0;i<event.data.giftData.options.wraps.length;i++){if($(".popover-gift-merchant-wrap").find("#mfn-wrap-"+i).is(":checked")){args+="currencyAmount="+event.data.giftData.options.wraps[i].priceAmount+"&";args+="currencyUnit="+event.data.giftData.options.wraps[i].unit+"&";break;}}}}}var url="/gp/buy/pipeline/handlers/update-gift.html";var callback="spcpage.jsonUpdateGift";var errorhandler="ordereditpopover.jsonUpdateGiftError";var systemerrorhandler="generalErrorHandling";ordereditpopover.startLoading(true);getData(url,callback,errorhandler,systemerrorhandler,args);};ordereditpopover.jsonUpdateGiftError=function jsonUpdateGiftError(errors){ordereditpopover.stopLoading();if(errors.giftMessageNotOk=="MessageTooLong"){$("#popover-gift-top #gift-error-box").find(".gift-error-box-char-limit-error").html(errors.maxChars);$("#popover-gift-top #gift-error-box").find(".gift-error-box-line-limit-error").html(errors.maxLines);$("#gift-error-box").show();}};ordereditpopover.updateGiftMessageCounter=function updateGiftMessageCounter(maxMessageChars,maxMessageLines,hasFixedGiftMsgLimit){ordereditpopover.MAX_MESSAGE_CHARS=maxMessageChars;ordereditpopover.MAX_MESSAGE_LINES=maxMessageLines;var message=$("#popover-content-gift textarea[name='gift-message-text']");if(message){if(hasFixedGiftMsgLimit){var size=message.val().length;}else{var size=unescape(encodeURIComponent(message.val())).length;}var numLines=message.val().split("\n").length;var charDelta=ordereditpopover.MAX_MESSAGE_CHARS-size;var lineDelta=ordereditpopover.MAX_MESSAGE_LINES-numLines;if((size>0)&&($("#include-gift-message-checkbox").not(":checked"))){$("#include-gift-message-checkbox").attr("checked","checked");}var tempMsg=message.val().split("\n");var eachline;for(eachline in tempMsg){if(tempMsg[eachline].length>24){if((tempMsg[eachline].length%24)==0){lineDelta-=Math.floor(tempMsg[eachline].length/24)-1;}else{lineDelta-=Math.floor(tempMsg[eachline].length/24);}}}$("#popover-gift-center .remainder-count").hide();var remainingCharDiv;if(charDelta<-1){remainingCharDiv=$("#popover-gift-center .remaining-char-over-multiple").show();}else{if(charDelta<0){remainingCharDiv=$("#popover-gift-center .remaining-char-over-single").show();}else{if(charDelta==1){remainingCharDiv=$("#popover-gift-center .remaining-char-single").show();}else{remainingCharDiv=$("#popover-gift-center .remaining-char-multiple").show();}}}remainingCharDiv.find(".chars-remaining").html(Math.abs(charDelta));var remainingLineDiv;if(lineDelta<-1){remainingLineDiv=$("#popover-gift-center .remaining-line-over-multiple").show();}else{if(lineDelta<0){remainingLineDiv=$("#popover-gift-center .remaining-line-over-single").show();}else{if(lineDelta==1){remainingLineDiv=$("#popover-gift-center .remaining-line-single").show();}else{remainingLineDiv=$("#popover-gift-center .remaining-line-multiple").show();}}}remainingLineDiv.find(".lines-remaining").html(Math.abs(lineDelta));if(charDelta<0||lineDelta<0){$("#checkout-button-enable").hide();$("#checkout-button-disabled").show();$("#checkout-button-disabled").hover(function(){ordereditpopover.maybeDisplayContinueDisabled(charDelta,lineDelta,ordereditpopover.MAX_MESSAGE_CHARS,ordereditpopover.MAX_MESSAGE_LINES);},function(){$("#popover-continue-blocker-box").hide();});}if(charDelta>-1&&lineDelta>-1){$("#checkout-button-disabled").hide();$("#checkout-button-enable").show();$("#popover-continue-blocker-box").hide();}}};ordereditpopover.maybeDisplayContinueDisabled=function maybeDisplayContinueDisabled(charCount,lineCount,maxChars,maxLines){var htm=$("#popover-continue-blocker-box");htm.show();if(charCount<0){$("#popover-gift-bottom .gift-char-limit-error").show();$("#popover-gift-bottom .gift-char-limit-error").find(".char-limit-error").html(maxChars);$("#popover-gift-bottom .gift-line-limit-error").hide();}else{if(lineCount<0){$("#popover-gift-bottom .gift-line-limit-error").show();$("#popover-gift-bottom .gift-line-limit-error").find(".line-limit-error").html(maxLines);$("#popover-gift-bottom .gift-char-limit-error").hide();}}};ordereditpopover.actionShowGiftWrapPreview=function actionShowGiftWrapPreview(event){$("#popover-content-gift").fadeOut(100,function(){$("#popover-content-gift-wrap-preview").fadeIn(100);});var backToGiftOptionsButton=$("#popover-content-gift-wrap-preview .back-to-gift-options-button");backToGiftOptionsButton.unbind("click").bind("click",ordereditpopover.actionBackToGiftOptions);ordereditpopover.bindActionEnterKeyOnButton(backToGiftOptionsButton);};ordereditpopover.actionBackToGiftOptions=function actionBackToGiftOptions(event){$("#popover-content-gift-wrap-preview").fadeOut(100,function(){$("#popover-content-gift").fadeIn(100);});};ordereditpopover.actionDisableHidePrice=function actionDisableHidePrice(event){if($("#amazon-gift-wrap").is(":checked")){$("#hide-prices-checkbox").attr("checked",true);$("#hide-prices-checkbox").attr("disabled",true);$("#hide-prices-note").show();}else{if($("#amazon-gift-wrap").not(":checked")){$("#hide-prices-checkbox").attr("checked",true);$("#hide-prices-checkbox").attr("disabled",false);$("#hide-prices-note").hide();}}};ordereditpopover.yourAccountKindle=function yourAccountKindle(event){if($("#amazon-gift-wrap").not(":checked")){$("#hide-prices-checkbox").removeAttr("checked");}};ordereditpopover.giftKindle=function giftKindle(event){$("#hide-prices-checkbox").attr("checked","checked");};ordereditpopover.hidePricesForKindle=function hidePricesForKindle(event){if($("#hide-prices-checkbox").is(":checked")){$("#kindleRegistration-1").removeAttr("checked");$("#kindleRegistration-0").attr("checked","checked");}else{if($("#hide-prices-checkbox").not(":checked")){$("#kindleRegistration-1").attr("checked","checked");$("#kindleRegistration-0").removeAttr("checked");}}};ordereditpopover.clearGiftMessage=function clearGiftMessage(maxMessageChars,maxMessageLines,hasFixedGiftMsgLimit){if($("#include-gift-message-checkbox").not(":checked")){$("#popover-content-gift textarea[name='gift-message-text']").val("");ordereditpopover.updateGiftMessageCounter(maxMessageChars,maxMessageLines,hasFixedGiftMsgLimit);}else{if($("#include-gift-message-checkbox").is(":checked")){}}};ordereditpopover.getFirstName=function getFirstName(fullName){var has_title=false;var firstName="";var splittedName=fullName.split(" ");if(/^(?:Dr|Mr|Mrs|Ms|Mme|Lt|Attn|Attn:|Prof|Pt|The)\.?$/i.test(splittedName[0])){has_title=true;}if(has_title){splittedName.shift();firstName=splittedName.shift();}else{firstName=splittedName.shift();}return firstName;};var doubleClickPrevention_clickTime=0;var CLICK_TIME_RESTRICTION=10000;function doubleClickPrevention_onSubmit(){var clickTime=new Date();if((clickTime.getTime()-doubleClickPrevention_clickTime)<CLICK_TIME_RESTRICTION){return false;}else{doubleClickPrevention_clickTime=clickTime.getTime();return true;}}PIPELINE.bbqCache=new Object();$(window).bind("hashchange",function(e){if(!window.useBbq){return ;}var page=bbqGetPage();if(PIPELINE.bbqCache[page]){PIPELINE.pipedata=PIPELINE.bbqCache[page];}else{requestPipedata(page);}if(PIPELINE.bbqCache["loadedpage"]=="spc"&&page=="payselect"){PIPEDATA_RETURN_RID="1";PIPELINE.pipedata=null;}else{if(PIPELINE.bbqCache["loadedpage"]=="spc"&&page=="billingaddressselect"){PIPEDATA_RETURN_RID="1";PIPELINE.pipedata=null;}}if(PIPELINE.bbqCache["loadedpage"]&&page){eval(PIPELINE.bbqCache["loadedpage"]+"page.uiDashboardSpinner(true)");}if(PIPELINE.bbqCache.usedConductor){delete PIPELINE.bbqCache.usedConductor;}else{if(PIPELINE.bbqCache[page]){gotoPage(page);}}PIPELINE.bbqCache["loadedpage"]=page;});function bbqCacheCurrentPage(page,data){if(!page){page=bbqGetPage();}if(!data){data=PIPELINE.pipedata;}PIPELINE.bbqCache[page]=data;}function bbqGetPage(){var page=$.bbq.getState("p");if(!page){page="spc";}return page;}function bbqConductor(pipedata,nextpage){conductor(pipedata,nextpage);if(PIPELINE.nextpage&&PIPELINE.nextpage.page){PIPELINE.bbqCache.usedConductor=true;setBbqPage(PIPELINE.nextpage.page);}}function setBbqPage(page,state){bbqCacheCurrentPage();if(!state){state=$.bbq.getState();}state["p"]=page;$.bbq.pushState(state);}